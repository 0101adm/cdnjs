/*
 * IDBWrapper - A cross-browser wrapper for IndexedDB
 * Copyright (c) 2011 - 2012 Jens Arps
 * http://jensarps.de/
 *
 * Licensed under the MIT (X11) license
 */
(function(h,f,e){"function"===typeof define?define(f):"undefined"!==typeof module&&module.exports?module.exports=f():e[h]=f()})("IDBStore",function(){var h,f={storeName:"Store",dbVersion:1,keyPath:"id",autoIncrement:!0,onStoreReady:function(){},onError:function(a){throw a;},indexes:[]};h=function(a,b){for(var c in f)this[c]="undefined"!=typeof a[c]?a[c]:f[c];this.dbName="IDBWrapper-"+this.storeName;this.dbVersion=parseInt(this.dbVersion,10);b&&(this.onStoreReady=b);this.idb=window.indexedDB||window.webkitIndexedDB||
window.mozIndexedDB;this.keyRange=window.IDBKeyRange||window.webkitIDBKeyRange||window.mozIDBKeyRange;this.consts={READ_ONLY:"readonly",READ_WRITE:"readwrite",VERSION_CHANGE:"versionchange",NEXT:"next",NEXT_NO_DUPLICATE:"nextunique",PREV:"prev",PREV_NO_DUPLICATE:"prevunique"};this.openDB()};h.prototype={db:null,dbName:null,dbVersion:null,store:null,storeName:null,keyPath:null,autoIncrement:null,indexes:null,features:null,onStoreReady:null,onError:null,openDB:function(){this.newVersionAPI="undefined"==
typeof this.idb.setVersion;if(!this.newVersionAPI)this.onError(Error("The IndexedDB implementation in this browser is outdated. Please upgrade your browser."));(this.features={}).hasAutoIncrement=!window.mozIndexedDB;var a=this.idb.open(this.dbName,this.dbVersion);a.onerror=function(a){var c=!1;"error"in a.target?c="VersionError"==a.target.error.name:"errorCode"in a.target&&(c=12==a.target.errorCode);if(c)this.onError(Error("The version number provided is lower than the existing one."));else this.onError(a)}.bind(this);
a.onsuccess=function(a){if(this.db)this.onStoreReady();else if(this.db=a.target.result,this.db.objectStoreNames.contains(this.storeName))this.store||(this.store=this.db.transaction([this.storeName],this.consts.READ_ONLY).objectStore(this.storeName)),this.indexes.forEach(function(c){var a=c.name;c.keyPath=c.keyPath||a;c.unique=!!c.unique;c.multiEntry=!!c.multiEntry;if(!a)throw Error("Cannot create index: No index name given.");if(this.hasIndex(a)){var b=this.store.index(a);if(!["keyPath","unique",
"multiEntry"].every(function(a){return"multiEntry"==a&&void 0===b[a]&&!1===c[a]?!0:c[a]==b[a]}))this.onError(Error('Cannot modify index "'+a+'" for current version. Please bump version number to '+(this.dbVersion+1)+"."))}else this.onError(Error('Cannot create new index "'+a+'" for current version. Please bump version number to '+(this.dbVersion+1)+"."))},this),this.onStoreReady();else this.onError(Error("Cannot create a new store for current version. Please bump version number to "+(this.dbVersion+
1)+"."))}.bind(this);a.onupgradeneeded=function(a){this.db=a.target.result;this.store=this.db.objectStoreNames.contains(this.storeName)?a.target.transaction.objectStore(this.storeName):this.db.createObjectStore(this.storeName,{keyPath:this.keyPath,autoIncrement:this.autoIncrement});this.indexes.forEach(function(a){var b=a.name;a.keyPath=a.keyPath||b;a.unique=!!a.unique;a.multiEntry=!!a.multiEntry;if(!b)this.onError(Error("Cannot create index: No index name given."));if(this.hasIndex(b)){var g=this.store.index(b);
["keyPath","unique","multiEntry"].every(function(b){return"multiEntry"==b&&void 0===g[b]&&!1===a[b]?!0:a[b]==g[b]})||(this.store.deleteIndex(b),this.store.createIndex(b,a.keyPath,{unique:a.unique,multiEntry:a.multiEntry}))}else this.store.createIndex(b,a.keyPath,{unique:a.unique,multiEntry:a.multiEntry})},this)}.bind(this)},deleteDatabase:function(){this.idb.deleteDatabase&&this.idb.deleteDatabase(this.dbName)},put:function(a,b,c){c||(c=function(a){console.error("Could not write data.",a)});b||(b=
e);"undefined"==typeof a[this.keyPath]&&!this.features.hasAutoIncrement&&(a[this.keyPath]=this._getUID());a=this.db.transaction([this.storeName],this.consts.READ_WRITE).objectStore(this.storeName).put(a);a.onsuccess=function(a){b(a.target.result)};a.onerror=c},get:function(a,b,c){c||(c=function(a){console.error("Could not read data.",a)});b||(b=e);a=this.db.transaction([this.storeName],this.consts.READ_ONLY).objectStore(this.storeName).get(a);a.onsuccess=function(a){b(a.target.result)};a.onerror=
c},remove:function(a,b,c){c||(c=function(a){console.error("Could not remove data.",a)});b||(b=e);a=this.db.transaction([this.storeName],this.consts.READ_WRITE).objectStore(this.storeName)["delete"](a);a.onsuccess=function(a){b(a.target.result)};a.onerror=c},getAll:function(a,b){b||(b=function(a){console.error("Could not read data.",a)});a||(a=e);var c=this.db.transaction([this.storeName],this.consts.READ_ONLY),d=c.objectStore(this.storeName);d.getAll?(c=d.getAll(),c.onsuccess=function(b){a(b.target.result)},
c.onerror=b):this._getAllCursor(c,a,b)},_getAllCursor:function(a,b,c){var d=[];a=a.objectStore(this.storeName).openCursor();a.onsuccess=function(a){(a=a.target.result)?(d.push(a.value),a["continue"]()):b(d)};a.onError=c},clear:function(a,b){b||(b=function(a){console.error("Could not clear store.",a)});a||(a=e);var c=this.db.transaction([this.storeName],this.consts.READ_WRITE).objectStore(this.storeName).clear();c.onsuccess=function(b){a(b.target.result)};c.onerror=b},_getUID:function(){return+new Date},
getIndexList:function(){return this.store.indexNames},hasIndex:function(a){return this.store.indexNames.contains(a)},iterate:function(a,b){b=j({index:null,order:"ASC",filterDuplicates:!1,keyRange:null,writeAccess:!1,onEnd:null,onError:function(a){console.error("Could not open cursor.",a)}},b||{});var c="desc"==b.order.toLowerCase()?"PREV":"NEXT";b.filterDuplicates&&(c+="_NO_DUPLICATE");var d=this.db.transaction([this.storeName],this.consts[b.writeAccess?"READ_WRITE":"READ_ONLY"]),g=d.objectStore(this.storeName);
b.index&&(g=g.index(b.index));c=g.openCursor(b.keyRange,this.consts[c]);c.onerror=b.onError;c.onsuccess=function(c){if(c=c.target.result)a(c.value,c,d),c["continue"]();else if(b.onEnd)b.onEnd();else a(null)}},count:function(a,b){b=j({index:null,keyRange:null},b||{});var c=b.onError||function(a){console.error("Could not open cursor.",a)},d=this.db.transaction([this.storeName],this.consts.READ_ONLY).objectStore(this.storeName);b.index&&(d=d.index(b.index));d=d.count(b.keyRange);d.onsuccess=function(b){a(b.target.result)};
d.onError=function(a){c(a)}},makeKeyRange:function(a){var b="undefined"!=typeof a.lower,c="undefined"!=typeof a.upper;switch(!0){case b&&c:a=this.keyRange.bound(a.lower,a.upper,a.excludeLower,a.excludeUpper);break;case b:a=this.keyRange.lowerBound(a.lower,a.excludeLower);break;case c:a=this.keyRange.upperBound(a.upper,a.excludeUpper);break;default:throw Error('Cannot create KeyRange. Provide one or both of "lower" or "upper" value.');}return a}};var e=function(){},k={},j=function(a,b){var c,d;for(c in b)d=
b[c],d!==k[c]&&d!==a[c]&&(a[c]=d);return a};return h},this);
