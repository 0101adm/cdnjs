define(function(e,f,c){var b=e("./lib/lang");var d=e("./range").Range;var h=e("./keyboard/hash_handler").HashHandler;var j=e("./tokenizer").Tokenizer;var l=d.comparePoints;var a=function(){this.snippetMap={};this.snippetNameMap={}};(function(){this.getTokenizer=function(){function m(q,p,o){q=q.substr(1);if(/^\d+$/.test(q)&&!o.inFormatString){return[{tabstopId:parseInt(q,10)}]}return[{text:q}]}function n(o){return"(?:[^\\\\"+o+"]|\\\\.)"}a.$tokenizer=new j({start:[{regex:/:/,onMatch:function(q,p,o){if(o.length&&o[0].expectIf){o[0].expectIf=false;o[0].elseBranch=o[0];return[o[0]]}return":"}},{regex:/\\./,onMatch:function(r,q,o){var p=r[1];if(p=="}"&&o.length){r=p}else{if("`$\\".indexOf(p)!=-1){r=p}else{if(o.inFormatString){if(p=="n"){r="\n"}else{if(p=="t"){r="\n"}else{if("ulULE".indexOf(p)!=-1){r={changeCase:p,local:p>"a"}}}}}}}return[r]}},{regex:/}/,onMatch:function(q,p,o){return[o.length?o.shift():q]}},{regex:/\$(?:\d+|\w+)/,onMatch:m},{regex:/\$\{[\dA-Z_a-z]+/,onMatch:function(r,q,o){var p=m(r.substr(1),q,o);o.unshift(p[0]);return p},next:"snippetVar"},{regex:/\n/,token:"newline",merge:false}],snippetVar:[{regex:"\\|"+n("\\|")+"*\\|",onMatch:function(q,p,o){o[0].choices=q.slice(1,-1).split(",")},next:"start"},{regex:"/("+n("/")+"+)/(?:("+n("/")+"*)/)(\\w*):?",onMatch:function(r,q,o){var p=o[0];p.fmtString=r;r=this.splitRegex.exec(r);p.guard=r[1];p.fmt=r[2];p.flag=r[3];return""},next:"start"},{regex:"`"+n("`")+"*`",onMatch:function(q,p,o){o[0].code=q.splice(1,-1);return""},next:"start"},{regex:"\\?",onMatch:function(q,p,o){if(o[0]){o[0].expectIf=true}},next:"start"},{regex:"([^:}\\\\]|\\\\.)*:?",token:"",next:"start"}],formatString:[{regex:"/("+n("/")+"+)/",token:"regex"},{regex:"",onMatch:function(q,p,o){o.inFormatString=true},next:"start"}]});a.prototype.getTokenizer=function(){return a.$tokenizer};return a.$tokenizer};this.tokenizeTmSnippet=function(n,m){return this.getTokenizer().getLineTokens(n,m).tokens.map(function(o){return o.value||o})};this.$getDefaultValue=function(p,m){if(/^[A-Z]\d+$/.test(m)){var n=m.substr(1);return(this.variables[m[0]+"__"]||{})[n]}if(/^\d+$/.test(m)){return(this.variables.__||{})[m]}m=m.replace(/^TM_/,"");if(!p){return}var o=p.session;switch(m){case"CURRENT_WORD":var q=o.getWordRange();case"SELECTION":case"SELECTED_TEXT":return o.getTextRange(q);case"CURRENT_LINE":return o.getLine(p.getCursorPosition().row);case"PREV_LINE":return o.getLine(p.getCursorPosition().row-1);case"LINE_INDEX":return p.getCursorPosition().column;case"LINE_NUMBER":return p.getCursorPosition().row+1;case"SOFT_TABS":return o.getUseSoftTabs()?"YES":"NO";case"TAB_SIZE":return o.getTabSize();case"FILENAME":case"FILEPATH":return"";case"FULLNAME":return"Ace"}};this.variables={};this.getVariableValue=function(m,n){if(this.variables.hasOwnProperty(n)){return this.variables[n](m,n)||""}return this.$getDefaultValue(m,n)||""};this.tmStrFormat=function(t,r,q){var n=r.flag||"";var p=r.guard;p=new RegExp(p,n.replace(/[^gi]/,""));var o=this.tokenizeTmSnippet(r.fmt,"formatString");var m=this;var s=t.replace(p,function(){m.variables.__=arguments;var x=m.resolveVariables(o,q);var y="E";for(var u=0;u<x.length;u++){var w=x[u];if(typeof w=="object"){x[u]="";if(w.changeCase&&w.local){var v=x[u+1];if(v&&typeof v=="string"){if(w.changeCase=="u"){x[u]=v[0].toUpperCase()}else{x[u]=v[0].toLowerCase()}x[u+1]=v.substr(1)}}else{if(w.changeCase){y=w.changeCase}}}else{if(y=="U"){x[u]=w.toUpperCase()}else{if(y=="L"){x[u]=w.toLowerCase()}}}}return x.join("")});this.variables.__=null;return s};this.resolveVariables=function(r,q){var m=[];for(var n=0;n<r.length;n++){var p=r[n];if(typeof p=="string"){m.push(p)}else{if(typeof p!="object"){continue}else{if(p.skip){o(p)}else{if(p.processed<n){continue}else{if(p.text){var s=this.getVariableValue(q,p.text);if(s&&p.fmtString){s=this.tmStrFormat(s,p)}p.processed=n;if(p.expectIf==null){if(s){m.push(s);o(p)}}else{if(s){p.skip=p.elseBranch}else{o(p)}}}else{if(p.tabstopId!=null){m.push(p)}else{if(p.changeCase!=null){m.push(p)}}}}}}}}function o(t){var u=r.indexOf(t,n+1);if(u!=-1){n=u}}return m};this.insertSnippet=function(s,H){var t=s.getCursorPosition();var w=s.session.getLine(t.row);var y=w.match(/^\s*/)[0];var G=s.session.getTabString();var A=this.tokenizeTmSnippet(H);A=this.resolveVariables(A,s);A=A.map(function(p){if(p=="\n"){return p+y}if(typeof p=="string"){return p.replace(/\t/g,G)}return p});var I=[];A.forEach(function(O,J){if(typeof O!="object"){return}var P=O.tabstopId;var L=I[P];if(!L){L=I[P]=[];L.index=P;L.value=""}if(L.indexOf(O)!==-1){return}L.push(O);var K=A.indexOf(O,J+1);if(K===-1){return}var N=A.slice(J+1,K);var M=N.some(function(p){return typeof p==="object"});if(M&&!L.value){L.value=N}else{if(N.length&&(!L.value||typeof L.value!=="string")){L.value=N.join("")}}});I.forEach(function(p){p.length=0});var r={};function o(M){var N=[];for(var K=0;K<M.length;K++){var L=M[K];if(typeof L=="object"){if(r[L.tabstopId]){continue}var J=M.lastIndexOf(L,K-1);L=N[J]||{tabstopId:L.tabstopId}}N[K]=L}return N}for(var F=0;F<A.length;F++){var B=A[F];if(typeof B!="object"){continue}var C=B.tabstopId;var E=A.indexOf(B,F+1);if(r[C]){if(r[C]===B){r[C]=null}continue}var m=I[C];var u=typeof m.value=="string"?[m.value]:o(m.value);u.unshift(F+1,Math.max(0,E-F));u.push(B);r[C]=B;A.splice.apply(A,u);if(m.indexOf(B)===-1){m.push(B)}}var v=0,n=0;var x="";A.forEach(function(p){if(typeof p==="string"){if(p[0]==="\n"){n=p.length-1;v++}else{n+=p.length}x+=p}else{if(!p.start){p.start={row:v,column:n}}else{p.end={row:v,column:n}}}});var z=s.getSelectionRange();var q=s.session.replace(z,x);var D=new i(s);D.addTabstops(I,z.start,q);D.tabNext()};this.$getScope=function(n){var m=n.session.$mode.$id||"";m=m.split("/").pop();if(m==="html"||m==="php"){if(m==="php"){m="html"}var p=n.getCursorPosition();var o=n.session.getState(p.row);if(typeof o==="object"){o=o[0]}if(o.substring){if(o.substring(0,3)=="js-"){m="javascript"}else{if(o.substring(0,4)=="css-"){m="css"}else{if(o.substring(0,4)=="php-"){m="php"}}}}}return m};this.getActiveScopes=function(n){var m=this.$getScope(n);var o=[m];var p=this.snippetMap;if(p[m]&&p[m].includeScopes){o.push.apply(o,p[m].includeScopes)}o.push("_");return o};this.expandWithTab=function(n){var s=n.getCursorPosition();var m=n.session.getLine(s.row);var q=m.substring(0,s.column);var r=m.substr(s.column);var p=this.snippetMap;var o;this.getActiveScopes(n).some(function(u){var t=p[u];if(t){o=this.findMatchingSnippet(t,q,r)}return !!o},this);if(!o){return false}n.session.doc.removeInLine(s.row,s.column-o.replaceBefore.length,s.column+o.replaceAfter.length);this.variables.M__=o.matchBefore;this.variables.T__=o.matchAfter;this.insertSnippet(n,o.content);this.variables.M__=this.variables.T__=null;return true};this.findMatchingSnippet=function(q,o,p){for(var m=q.length;m--;){var n=q[m];if(n.startRe&&!n.startRe.test(o)){continue}if(n.endRe&&!n.endRe.test(p)){continue}if(!n.startRe&&!n.endRe){continue}n.matchBefore=n.startRe?n.startRe.exec(o):[""];n.matchAfter=n.endRe?n.endRe.exec(p):[""];n.replaceBefore=n.triggerRe?n.triggerRe.exec(o)[0]:"";n.replaceAfter=n.endTriggerRe?n.endTriggerRe.exec(p)[0]:"";return n}};this.snippetMap={};this.snippetNameMap={};this.register=function(p,q){var r=this.snippetMap;var o=this.snippetNameMap;var n=this;function t(u){if(u&&!/^\^?\(.*\)\$?$|^\\b$/.test(u)){u="(?:"+u+")"}return u||""}function m(v,w,u){v=t(v);w=t(w);if(u){v=w+v;if(v&&v[v.length-1]!="$"){v=v+"$"}}else{v=v+w;if(v&&v[0]!="^"){v="^"+v}}return new RegExp(v)}function s(v){if(!v.scope){v.scope=q||"_"}q=v.scope;if(!r[q]){r[q]=[];o[q]={}}var w=o[q];if(v.name){var u=w[v.name];if(u){n.unregister(u)}w[v.name]=v}r[q].push(v);if(v.tabTrigger&&!v.trigger){if(!v.guard&&/^\w/.test(v.tabTrigger)){v.guard="\\b"}v.trigger=b.escapeRegExp(v.tabTrigger)}v.startRe=m(v.trigger,v.guard,true);v.triggerRe=new RegExp(v.trigger,"",true);v.endRe=m(v.endTrigger,v.endGuard,true);v.endTriggerRe=new RegExp(v.endTrigger,"",true)}if(p.content){s(p)}else{if(Array.isArray(p)){p.forEach(s)}}};this.unregister=function(o,p){var q=this.snippetMap;var n=this.snippetNameMap;function m(t){var v=n[t.scope||p];if(v&&v[t.name]){delete v[t.name];var u=q[t.scope||p];var r=u&&u.indexOf(t);if(r>=0){u.splice(r,1)}}}if(o.content){m(o)}else{if(Array.isArray(o)){o.forEach(m)}}};this.parseSnippetFile=function(t){t=t.replace(/\r/g,"");var s=[],n={};var v=/^#.*|^({[\s\S]*})\s*$|^(\S+) (.*)$|^((?:\n*\t.*)+)/gm;var p;while(p=v.exec(t)){if(p[1]){try{n=JSON.parse(p[1]);s.push(n)}catch(r){}}if(p[4]){n.content=p[4].replace(/^\t/gm,"");s.push(n);n={}}else{var u=p[2],o=p[3];if(u=="regex"){var q=/\/((?:[^\/\\]|\\.)*)|$/g;n.guard=q.exec(o)[1];n.trigger=q.exec(o)[1];n.endTrigger=q.exec(o)[1];n.endGuard=q.exec(o)[1]}else{if(u=="snippet"){n.tabTrigger=o.match(/^\S*/)[0];if(!n.name){n.name=o}}else{n[u]=o}}}}return s};this.getSnippetByName=function(m,n){var p=this.snippetNameMap;var o;this.getActiveScopes(n).some(function(r){var q=p[r];if(q){o=q[m]}return !!o},this);return o}}).call(a.prototype);var i=function(m){if(m.tabstopManager){return m.tabstopManager}m.tabstopManager=this;this.$onChange=this.onChange.bind(this);this.$onChangeSelection=b.delayedCall(this.onChangeSelection.bind(this)).schedule;this.$onChangeSession=this.onChangeSession.bind(this);this.$onAfterExec=this.onAfterExec.bind(this);this.attach(m)};(function(){this.attach=function(m){this.index=-1;this.ranges=[];this.tabstops=[];this.selectedTabstop=null;this.editor=m;this.editor.on("change",this.$onChange);this.editor.on("changeSelection",this.$onChangeSelection);this.editor.on("changeSession",this.$onChangeSession);this.editor.commands.on("afterExec",this.$onAfterExec);this.editor.keyBinding.addKeyboardHandler(this.keyboardHandler)};this.detach=function(){this.tabstops.forEach(this.removeTabstopMarkers,this);this.ranges=null;this.tabstops=null;this.selectedTabstop=null;this.editor.removeListener("change",this.$onChange);this.editor.removeListener("changeSelection",this.$onChangeSelection);this.editor.removeListener("changeSession",this.$onChangeSession);this.editor.commands.removeListener("afterExec",this.$onAfterExec);this.editor.keyBinding.removeKeyboardHandler(this.keyboardHandler);this.editor.tabstopManager=null;this.editor=null};this.onChange=function(w){var q=w.data.range;var n=w.data.action[0]=="r";var p=q.start;var s=q.end;var z=p.row;var t=s.row;var y=t-z;var v=s.column-p.column;if(n){y=-y;v=-v}if(!this.$inChange&&n){var x=this.selectedTabstop;var A=!x.some(function(B){return l(B.start,p)<=0&&l(B.end,s)>=0});if(A){return this.detach()}}var o=this.ranges;for(var u=0;u<o.length;u++){var m=o[u];if(m.end.row<p.row){continue}if(l(p,m.start)<0&&l(s,m.end)>0){this.removeRange(m);u--;continue}if(m.start.row==z&&m.start.column>p.column){m.start.column+=v}if(m.end.row==z&&m.end.column>=p.column){m.end.column+=v}if(m.start.row>=z){m.start.row+=y}if(m.end.row>=z){m.end.row+=y}if(l(m.start,m.end)>0){this.removeRange(m)}}if(!o.length){this.detach()}};this.updateLinkedFields=function(){var p=this.selectedTabstop;if(!p.hasLinkedRanges){return}this.$inChange=true;var q=this.editor.session;var r=q.getTextRange(p.firstNonLinked);for(var o=p.length;o--;){var n=p[o];if(!n.linked){continue}var m=f.snippetManager.tmStrFormat(r,n.original);q.replace(n,m)}this.$inChange=false};this.onAfterExec=function(m){if(m.command&&!m.command.readOnly){this.updateLinkedFields()}};this.onChangeSelection=function(){if(!this.editor){return}var o=this.editor.selection.lead;var n=this.editor.selection.anchor;var r=this.editor.selection.isEmpty();for(var p=this.ranges.length;p--;){if(this.ranges[p].linked){continue}var m=this.ranges[p].contains(o.row,o.column);var q=r||this.ranges[p].contains(n.row,n.column);if(m&&q){return}}this.detach()};this.onChangeSession=function(){this.detach()};this.tabNext=function(o){var m=this.tabstops.length-1;var n=this.index+(o||1);n=Math.min(Math.max(n,0),m);this.selectTabstop(n);if(n==m){this.detach()}};this.selectTabstop=function(m){var o=this.tabstops[this.index];if(o){this.addTabstopMarkers(o)}this.index=m;o=this.tabstops[this.index];if(!o||!o.length){return}this.selectedTabstop=o;if(!this.editor.inVirtualSelectionMode){var p=this.editor.multiSelect;p.toSingleRange(o.firstNonLinked.clone());for(var n=o.length;n--;){if(o.hasLinkedRanges&&o[n].linked){continue}p.addRange(o[n].clone(),true)}}else{this.editor.selection.setRange(o.firstNonLinked)}this.editor.keyBinding.addKeyboardHandler(this.keyboardHandler)};this.addTabstops=function(t,u,o){if(!t[0]){var s=d.fromPoints(o,o);g(s.start,u);g(s.end,u);t[0]=[s];t[0].index=0}var q=this.index;var m=[q,0];var n=this.ranges;var r=this.editor;t.forEach(function(x){for(var w=x.length;w--;){var y=x[w];var v=d.fromPoints(y.start,y.end||y.start);k(v.start,u);k(v.end,u);v.original=y;v.tabstop=x;n.push(v);x[w]=v;if(y.fmtString){v.linked=true;x.hasLinkedRanges=true}else{if(!x.firstNonLinked){x.firstNonLinked=v}}}if(!x.firstNonLinked){x.hasLinkedRanges=false}m.push(x);this.addTabstopMarkers(x)},this);m.push(m.splice(2,1)[0]);this.tabstops.splice.apply(this.tabstops,m)};this.addTabstopMarkers=function(m){var n=this.editor.session;m.forEach(function(o){if(!o.markerId){o.markerId=n.addMarker(o,"ace_snippet-marker","text")}})};this.removeTabstopMarkers=function(m){var n=this.editor.session;m.forEach(function(o){n.removeMarker(o.markerId);o.markerId=null})};this.removeRange=function(m){var n=m.tabstop.indexOf(m);m.tabstop.splice(n,1);n=this.ranges.indexOf(m);this.ranges.splice(n,1);this.editor.session.removeMarker(m.markerId)};this.keyboardHandler=new h();this.keyboardHandler.bindKeys({Tab:function(m){if(f.snippetManager&&f.snippetManager.expandWithTab(m)){return}m.tabstopManager.tabNext(1)},"Shift-Tab":function(m){m.tabstopManager.tabNext(-1)},Esc:function(m){m.tabstopManager.detach()},Return:function(m){return false}})}).call(i.prototype);var k=function(m,n){if(m.row==0){m.column+=n.column}m.row+=n.row};var g=function(m,n){if(m.row==n.row){m.column-=n.column}m.row-=n.row};e("./lib/dom").importCssString(".ace_snippet-marker {    -moz-box-sizing: border-box;    box-sizing: border-box;    background: rgba(194, 193, 208, 0.09);    border: 1px dotted rgba(211, 208, 235, 0.62);    position: absolute;}");f.snippetManager=new a()});