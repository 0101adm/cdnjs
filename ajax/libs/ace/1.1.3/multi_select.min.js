define(function(g,q,b){var n=g("./range_list").RangeList;var o=g("./range").Range;var c=g("./selection").Selection;var e=g("./mouse/multi_select_handler").onMouseDown;var m=g("./lib/event");var r=g("./lib/lang");var d=g("./commands/multi_select_commands");q.commands=d.defaultCommands.concat(d.multiSelectCommands);var f=g("./search").Search;var h=new f();function j(u,t,s){h.$options.wrap=true;h.$options.needle=t;h.$options.backwards=s==-1;return h.find(u)}var a=g("./edit_session").EditSession;(function(){this.getSelectionMarkers=function(){return this.$selectionMarkers}}).call(a.prototype);(function(){this.ranges=null;this.rangeList=null;this.addRange=function(t,s){if(!t){return}if(!this.inMultiSelectMode&&this.rangeCount==0){var v=this.toOrientedRange();this.rangeList.add(v);this.rangeList.add(t);if(this.rangeList.ranges.length!=2){this.rangeList.removeAll();return s||this.fromOrientedRange(t)}this.rangeList.removeAll();this.rangeList.add(v);this.$onAddRange(v)}if(!t.cursor){t.cursor=t.end}var u=this.rangeList.add(t);this.$onAddRange(t);if(u.length){this.$onRemoveRange(u)}if(this.rangeCount>1&&!this.inMultiSelectMode){this._signal("multiSelect");this.inMultiSelectMode=true;this.session.$undoSelect=false;this.rangeList.attach(this.session)}return s||this.fromOrientedRange(t)};this.toSingleRange=function(s){s=s||this.ranges[0];var t=this.rangeList.removeAll();if(t.length){this.$onRemoveRange(t)}s&&this.fromOrientedRange(s)};this.substractPoint=function(t){var s=this.rangeList.substractPoint(t);if(s){this.$onRemoveRange(s);return s[0]}};this.mergeOverlappingRanges=function(){var s=this.rangeList.merge();if(s.length){this.$onRemoveRange(s)}else{if(this.ranges[0]){this.fromOrientedRange(this.ranges[0])}}};this.$onAddRange=function(s){this.rangeCount=this.rangeList.ranges.length;this.ranges.unshift(s);this._signal("addRange",{range:s})};this.$onRemoveRange=function(u){this.rangeCount=this.rangeList.ranges.length;if(this.rangeCount==1&&this.inMultiSelectMode){var v=this.rangeList.ranges.pop();u.push(v);this.rangeCount=0}for(var t=u.length;t--;){var s=this.ranges.indexOf(u[t]);this.ranges.splice(s,1)}this._signal("removeRange",{ranges:u});if(this.rangeCount==0&&this.inMultiSelectMode){this.inMultiSelectMode=false;this._signal("singleSelect");this.session.$undoSelect=true;this.rangeList.detach(this.session)}v=v||this.ranges[0];if(v&&!v.isEqual(this.getRange())){this.fromOrientedRange(v)}};this.$initRangeList=function(){if(this.rangeList){return}this.rangeList=new n();this.ranges=[];this.rangeCount=0};this.getAllRanges=function(){return this.rangeCount?this.rangeList.ranges.concat():[this.getRange()]};this.splitIntoLines=function(){if(this.rangeCount>1){var t=this.rangeList.ranges;var z=t[t.length-1];var A=o.fromPoints(t[0].start,z.end);this.toSingleRange();this.setSelectionRange(A,z.cursor==z.start)}else{var A=this.getRange();var B=this.isBackwards();var C=A.start.row;var x=A.end.row;if(C==x){if(B){var u=A.end,w=A.start}else{var u=A.start,w=A.end}this.addRange(o.fromPoints(w,w));this.addRange(o.fromPoints(u,u));return}var v=[];var s=this.getLineRange(C,true);s.start.column=A.start.column;v.push(s);for(var y=C+1;y<x;y++){v.push(this.getLineRange(y,true))}s=this.getLineRange(x,true);s.end.column=A.end.column;v.push(s);v.forEach(this.addRange,this)}};this.toggleBlockSelection=function(){if(this.rangeCount>1){var s=this.rangeList.ranges;var w=s[s.length-1];var t=o.fromPoints(s[0].start,w.end);this.toSingleRange();this.setSelectionRange(t,w.cursor==w.start)}else{var v=this.session.documentToScreenPosition(this.selectionLead);var u=this.session.documentToScreenPosition(this.selectionAnchor);var x=this.rectangularRangeBlock(v,u);x.forEach(this.addRange,this)}};this.rectangularRangeBlock=function(t,z,E){var u=[];var w=t.column<z.column;if(w){var v=t.column;var D=z.column}else{var v=z.column;var D=t.column}var F=t.row<z.row;if(F){var G=t.row;var y=z.row}else{var G=z.row;var y=t.row}if(v<0){v=0}if(G<0){G=0}if(G==y){E=true}for(var H=G;H<=y;H++){var B=o.fromPoints(this.session.screenToDocumentPosition(H,v),this.session.screenToDocumentPosition(H,D));if(B.isEmpty()){if(C&&p(B.end,C)){break}var C=B.end}B.cursor=w?B.start:B.end;u.push(B)}if(F){u.reverse()}if(!E){var x=u.length-1;while(u[x].isEmpty()&&x>0){x--}if(x>0){var s=0;while(u[s].isEmpty()){s++}}for(var A=x;A>=s;A--){if(u[A].isEmpty()){u.splice(A,1)}}}return u}}).call(c.prototype);var l=g("./editor").Editor;(function(){this.updateSelectionMarkers=function(){this.renderer.updateCursor();this.renderer.updateBackMarkers()};this.addSelectionMarker=function(t){if(!t.cursor){t.cursor=t.end}var s=this.getSelectionStyle();t.marker=this.session.addMarker(t,"ace_selection",s);this.session.$selectionMarkers.push(t);this.session.selectionMarkerCount=this.session.$selectionMarkers.length;return t};this.removeSelectionMarker=function(s){if(!s.marker){return}this.session.removeMarker(s.marker);var t=this.session.$selectionMarkers.indexOf(s);if(t!=-1){this.session.$selectionMarkers.splice(t,1)}this.session.selectionMarkerCount=this.session.$selectionMarkers.length};this.removeSelectionMarkers=function(s){var u=this.session.$selectionMarkers;for(var w=s.length;w--;){var t=s[w];if(!t.marker){continue}this.session.removeMarker(t.marker);var v=u.indexOf(t);if(v!=-1){u.splice(v,1)}}this.session.selectionMarkerCount=u.length};this.$onAddRange=function(s){this.addSelectionMarker(s.range);this.renderer.updateCursor();this.renderer.updateBackMarkers()};this.$onRemoveRange=function(s){this.removeSelectionMarkers(s.ranges);this.renderer.updateCursor();this.renderer.updateBackMarkers()};this.$onMultiSelect=function(s){if(this.inMultiSelectMode){return}this.inMultiSelectMode=true;this.setStyle("ace_multiselect");this.keyBinding.addKeyboardHandler(d.keyboardHandler);this.commands.setDefaultHandler("exec",this.$onMultiSelectExec);this.renderer.updateCursor();this.renderer.updateBackMarkers()};this.$onSingleSelect=function(s){if(this.session.multiSelect.inVirtualMode){return}this.inMultiSelectMode=false;this.unsetStyle("ace_multiselect");this.keyBinding.removeKeyboardHandler(d.keyboardHandler);this.commands.removeDefaultHandler("exec",this.$onMultiSelectExec);this.renderer.updateCursor();this.renderer.updateBackMarkers();this._emit("changeSelection")};this.$onMultiSelectExec=function(u){var v=u.command;var t=u.editor;if(!t.multiSelect){return}if(!v.multiSelectAction){var s=v.exec(t,u.args||{});t.multiSelect.addRange(t.multiSelect.toOrientedRange());t.multiSelect.mergeOverlappingRanges()}else{if(v.multiSelectAction=="forEach"){s=t.forEachSelection(v,u.args)}else{if(v.multiSelectAction=="forEachLine"){s=t.forEachSelection(v,u.args,true)}else{if(v.multiSelectAction=="single"){t.exitMultiSelectMode();s=v.exec(t,u.args||{})}else{s=v.multiSelectAction(t,u.args||{})}}}}return s};this.forEachSelection=function(u,A,z){if(this.inVirtualSelectionMode){return}var B=this.session;var C=this.selection;var v=C.rangeList;var D;var t=C._eventRegistry;C._eventRegistry={};var s=new c(B);this.inVirtualSelectionMode=true;for(var x=v.ranges.length;x--;){if(z){while(x>0&&v.ranges[x].start.row==v.ranges[x-1].end.row){x--}}s.fromOrientedRange(v.ranges[x]);s.id=v.ranges[x].marker;this.selection=B.selection=s;var y=u.exec(this,A||{});if(D!==undefined){D=y}s.toOrientedRange(v.ranges[x])}s.detach();this.selection=B.selection=C;this.inVirtualSelectionMode=false;C._eventRegistry=t;C.mergeOverlappingRanges();var w=this.renderer.$scrollAnimation;this.onCursorChange();this.onSelectionChange();if(w&&w.from==w.to){this.renderer.animateScrolling(w.from)}return D};this.exitMultiSelectMode=function(){if(!this.inMultiSelectMode||this.inVirtualSelectionMode){return}this.multiSelect.toSingleRange()};this.getSelectedText=function(){var w="";if(this.inMultiSelectMode&&!this.inVirtualSelectionMode){var t=this.multiSelect.rangeList.ranges;var u=[];for(var v=0;v<t.length;v++){u.push(this.session.getTextRange(t[v]))}var s=this.session.getDocument().getNewLineCharacter();w=u.join(s);if(w.length==(u.length-1)*s.length){w=""}}else{if(!this.selection.isEmpty()){w=this.session.getTextRange(this.getSelectionRange())}}return w};this.onPaste=function(x){if(this.$readOnly){return}var w={text:x};this._signal("paste",w);x=w.text;if(!this.inMultiSelectMode||this.inVirtualSelectionMode){return this.insert(x)}var t=x.split(/\r\n|\r|\n/);var s=this.selection.rangeList.ranges;if(t.length>s.length||t.length<2||!t[1]){return this.commands.exec("insertstring",this,x)}for(var v=s.length;v--;){var u=s[v];if(!u.isEmpty()){this.session.remove(u)}this.session.insert(u.start,t[v])}};this.findAll=function(x,u,t){u=u||{};u.needle=x||u.needle;this.$search.set(u);var s=this.$search.findAll(this.session);if(!s.length){return 0}this.$blockScrolling+=1;var w=this.multiSelect;if(!t){w.toSingleRange(s[0])}for(var v=s.length;v--;){w.addRange(s[v],true)}this.$blockScrolling-=1;return s.length};this.selectMoreLines=function(t,A){var w=this.selection.toOrientedRange();var B=w.cursor==w.end;var z=this.session.documentToScreenPosition(w.cursor);if(this.selection.$desiredColumn){z.column=this.selection.$desiredColumn}var x=this.session.screenToDocumentPosition(z.row+t,z.column);if(!w.isEmpty()){var u=this.session.documentToScreenPosition(B?w.end:w.start);var v=this.session.screenToDocumentPosition(u.row+t,u.column)}else{var v=x}if(B){var y=o.fromPoints(x,v);y.cursor=y.start}else{var y=o.fromPoints(v,x);y.cursor=y.end}y.desiredColumn=z.column;if(!this.selection.inMultiSelectMode){this.selection.addRange(w)}else{if(A){var s=w.cursor}}this.selection.addRange(y);if(s){this.selection.substractPoint(s)}};this.transposeSelections=function(t){var y=this.session;var x=y.multiSelect;var w=x.ranges;for(var v=w.length;v--;){var s=w[v];if(s.isEmpty()){var u=y.getWordRange(s.start.row,s.start.column);s.start.row=u.start.row;s.start.column=u.start.column;s.end.row=u.end.row;s.end.column=u.end.column}}x.mergeOverlappingRanges();var z=[];for(var v=w.length;v--;){var s=w[v];z.unshift(y.getTextRange(s))}if(t<0){z.unshift(z.pop())}else{z.push(z.shift())}for(var v=w.length;v--;){var s=w[v];var u=s.clone();y.replace(s,z[v]);s.start.row=u.start.row;s.start.column=u.start.column}};this.selectMore=function(u,v){var y=this.session;var w=y.multiSelect;var s=w.toOrientedRange();if(s.isEmpty()){s=y.getWordRange(s.start.row,s.start.column);s.cursor=u==-1?s.start:s.end;this.multiSelect.addRange(s)}var x=y.getTextRange(s);var t=j(y,x,u);if(t){t.cursor=u==-1?t.start:t.end;this.$blockScrolling+=1;this.session.unfold(t);this.multiSelect.addRange(t);this.$blockScrolling-=1;this.renderer.scrollCursorIntoView(null,0.5)}if(v){this.multiSelect.substractPoint(s.cursor)}};this.alignCursors=function(){var z=this.session;var u=z.multiSelect;var t=u.ranges;if(!t.length){var w=this.selection.getRange();var y=w.start.row,x=w.end.row;var B=y==x;if(B){var A=this.session.getLength();var G;do{G=this.session.getLine(x)}while(/[=:]/.test(G)&&++x<A);do{G=this.session.getLine(y)}while(/[=:]/.test(G)&&--y>0);if(y<0){y=0}if(x>=A){x=A-1}}var F=this.session.doc.removeLines(y,x);F=this.$reAlignText(F,B);this.session.doc.insert({row:y,column:0},F.join("\n")+"\n");if(!B){w.start.column=0;w.end.column=F[F.length-1].length}this.selection.setRange(w)}else{var E=-1;var v=t.filter(function(H){if(H.cursor.row==E){return true}E=H.cursor.row});u.$onRemoveRange(v);var C=0;var D=Infinity;var s=t.map(function(J){var K=J.cursor;var H=z.getLine(K.row);var I=H.substr(K.column).search(/\S/g);if(I==-1){I=0}if(K.column>C){C=K.column}if(I<D){D=I}return I});t.forEach(function(J,I){var K=J.cursor;var H=C-K.column;var L=s[I]-D;if(H>L){z.insert(K,r.stringRepeat(" ",H-L))}else{z.remove(new o(K.row,K.column,K.row,K.column-H+L))}J.start.column=J.end.column=C;J.start.row=J.end.row=K.row;J.cursor=J.end});u.fromOrientedRange(t[0]);this.renderer.updateCursor();this.renderer.updateBackMarkers()}};this.$reAlignText=function(C,v){var s=true,u=true;var x,y,B;return C.map(function(E){var D=E.match(/(\s*)(.*?)(\s*)([=:].*)/);if(!D){return[E]}if(x==null){x=D[1].length;y=D[2].length;B=D[3].length;return D}if(x+y+B!=D[1].length+D[2].length+D[3].length){u=false}if(x!=D[1].length){s=false}if(x>D[1].length){x=D[1].length}if(y<D[2].length){y=D[2].length}if(B>D[3].length){B=D[3].length}return D}).map(v?t:s?u?A:t:w);function z(D){return r.stringRepeat(" ",D)}function t(D){return !D[2]?D[0]:z(x)+D[2]+z(y-D[2].length+B)+D[4].replace(/^([=:])\s+/,"$1 ")}function A(D){return !D[2]?D[0]:z(x+y-D[2].length)+D[2]+z(B," ")+D[4].replace(/^([=:])\s+/,"$1 ")}function w(D){return !D[2]?D[0]:z(x)+D[2]+z(B)+D[4].replace(/^([=:])\s+/,"$1 ")}}}).call(l.prototype);function p(t,s){return t.row==s.row&&t.column==s.column}q.onSessionChange=function(u){var t=u.session;if(!t.multiSelect){t.$selectionMarkers=[];t.selection.$initRangeList();t.multiSelect=t.selection}this.multiSelect=t.multiSelect;var s=u.oldSession;if(s){s.multiSelect.removeEventListener("addRange",this.$onAddRange);s.multiSelect.removeEventListener("removeRange",this.$onRemoveRange);s.multiSelect.removeEventListener("multiSelect",this.$onMultiSelect);s.multiSelect.removeEventListener("singleSelect",this.$onSingleSelect)}t.multiSelect.on("addRange",this.$onAddRange);t.multiSelect.on("removeRange",this.$onRemoveRange);t.multiSelect.on("multiSelect",this.$onMultiSelect);t.multiSelect.on("singleSelect",this.$onSingleSelect);if(this.inMultiSelectMode!=t.selection.inMultiSelectMode){if(t.selection.inMultiSelectMode){this.$onMultiSelect()}else{this.$onSingleSelect()}}};function k(s){if(s.$multiselectOnSessionChange){return}s.$onAddRange=s.$onAddRange.bind(s);s.$onRemoveRange=s.$onRemoveRange.bind(s);s.$onMultiSelect=s.$onMultiSelect.bind(s);s.$onSingleSelect=s.$onSingleSelect.bind(s);s.$multiselectOnSessionChange=q.onSessionChange.bind(s);s.$multiselectOnSessionChange(s);s.on("changeSession",s.$multiselectOnSessionChange);s.on("mousedown",e);s.commands.addCommands(d.defaultCommands);i(s)}function i(t){var s=t.textInput.getElement();var v=false;m.addListener(s,"keydown",function(w){if(w.keyCode==18&&!(w.ctrlKey||w.shiftKey||w.metaKey)){if(!v){t.renderer.setMouseCursor("crosshair");v=true}}else{if(v){u()}}});m.addListener(s,"keyup",u);m.addListener(s,"blur",u);function u(w){if(v){t.renderer.setMouseCursor("");v=false}}}q.MultiSelect=k;g("./config").defineOptions(l.prototype,"editor",{enableMultiselect:{set:function(s){k(this);if(s){this.on("changeSession",this.$multiselectOnSessionChange);this.on("mousedown",e)}else{this.off("changeSession",this.$multiselectOnSessionChange);this.off("mousedown",e)}},value:true}})});