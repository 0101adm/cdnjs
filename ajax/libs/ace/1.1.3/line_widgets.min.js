define(function(b,a,c){var d=b("./lib/oop");var g=b("./lib/dom");var f=b("./range").Range;function e(h){this.session=h;this.session.widgetManager=this;this.session.getRowLength=this.getRowLength;this.session.$getWidgetScreenLength=this.$getWidgetScreenLength;this.updateOnChange=this.updateOnChange.bind(this);this.renderWidgets=this.renderWidgets.bind(this);this.measureWidgets=this.measureWidgets.bind(this);this.session._changedWidgets=[];this.detach=this.detach.bind(this);this.session.on("change",this.updateOnChange)}(function(){this.getRowLength=function(j){var i;if(this.lineWidgets){i=this.lineWidgets[j]&&this.lineWidgets[j].rowCount||0}else{i=0}if(!this.$useWrapMode||!this.$wrapData[j]){return 1+i}else{return this.$wrapData[j].length+1+i}};this.$getWidgetScreenLength=function(){var h=0;this.lineWidgets.forEach(function(i){if(i&&i.rowCount){h+=i.rowCount}});return h};this.attach=function(h){if(h.widgetManager&&h.widgetManager!=this){h.widgetManager.detach()}if(this.editor==h){return}this.detach();this.editor=h;this.editor.on("changeSession",this.detach);h.widgetManager=this;h.setOption("enableLineWidgets",true);h.renderer.on("beforeRender",this.measureWidgets);h.renderer.on("afterRender",this.renderWidgets)};this.detach=function(j){if(j&&j.session==this.session){return}var i=this.editor;if(!i){return}i.off("changeSession",this.detach);this.editor=null;i.widgetManager=null;i.renderer.off("beforeRender",this.measureWidgets);i.renderer.off("afterRender",this.renderWidgets);var h=this.session.lineWidgets;h&&h.forEach(function(k){if(k&&k.el&&k.el.parentNode){k._inDocument=false;k.el.parentNode.removeChild(k.el)}})};this.updateOnChange=function(n){var l=this.session.lineWidgets;if(!l){return}var o=n.data;var j=o.range;var i=j.start.row;var h=j.end.row-i;if(h===0){}else{if(o.action=="removeText"||o.action=="removeLines"){var m=l.splice(i+1,h);m.forEach(function(p){p&&this.removeLineWidget(p)},this);this.$updateRows()}else{var k=new Array(h);k.unshift(i,0);l.splice.apply(l,k);this.$updateRows()}}};this.$updateRows=function(){var h=this.session.lineWidgets;if(!h){return}var i=true;h.forEach(function(j,k){if(j){i=false;j.row=k}});if(i){this.session.lineWidgets=null}};this.addLineWidget=function(h){if(!this.session.lineWidgets){this.session.lineWidgets=new Array(this.session.getLength())}this.session.lineWidgets[h.row]=h;var i=this.editor.renderer;if(h.html&&!h.el){h.el=g.createElement("div");h.el.innerHTML=h.html}if(h.el){g.addCssClass(h.el,"ace_lineWidgetContainer");h.el.style.position="absolute";h.el.style.zIndex=5;i.container.appendChild(h.el);h._inDocument=true}if(!h.coverGutter){h.el.style.zIndex=3}if(!h.pixelHeight){h.pixelHeight=h.el.offsetHeight}if(h.rowCount==null){h.rowCount=h.pixelHeight/i.layerConfig.lineHeight}this.session._emit("changeFold",{data:{start:{row:h.row}}});this.$updateRows();this.renderWidgets(null,i);return h};this.removeLineWidget=function(h){h._inDocument=false;if(h.el&&h.el.parentNode){h.el.parentNode.removeChild(h.el)}if(h.editor&&h.editor.destroy){try{h.editor.destroy()}catch(i){}}if(this.session.lineWidgets){this.session.lineWidgets[h.row]=undefined}this.session._emit("changeFold",{data:{start:{row:h.row}}});this.$updateRows()};this.onWidgetChanged=function(h){this.session._changedWidgets.push(h);this.editor&&this.editor.renderer.updateFull()};this.measureWidgets=function(p,o){var k=this.session._changedWidgets;var l=o.layerConfig;if(!k||!k.length){return}var n=Infinity;for(var m=0;m<k.length;m++){var h=k[m];if(!h._inDocument){h._inDocument=true;o.container.appendChild(h.el)}h.h=h.el.offsetHeight;if(!h.fixedWidth){h.w=h.el.offsetWidth;h.screenWidth=Math.ceil(h.w/l.characterWidth)}var j=h.h/l.lineHeight;if(h.coverLine){j-=this.session.getRowLineCount(h.row);if(j<0){j=0}}if(h.rowCount!=j){h.rowCount=j;if(h.row<n){n=h.row}}}if(n!=Infinity){this.session._emit("changeFold",{data:{start:{row:n}}});this.session.lineWidgetWidth=null}this.session._changedWidgets=[]};this.renderWidgets=function(m,n){var h=n.layerConfig;var o=this.session.lineWidgets;if(!o){return}var l=Math.min(this.firstRow,h.firstRow);var r=Math.max(this.lastRow,h.lastRow,o.length);while(l>0&&!o[l]){l--}this.firstRow=h.firstRow;this.lastRow=h.lastRow;n.$cursorLayer.config=h;for(var k=l;k<=r;k++){var q=o[k];if(!q||!q.el){continue}if(!q._inDocument){q._inDocument=true;n.container.appendChild(q.el)}var p=n.$cursorLayer.getPixelPosition({row:k,column:0},true).top;if(!q.coverLine){p+=h.lineHeight*this.session.getRowLineCount(q.row)}q.el.style.top=p-h.offset+"px";var j=q.coverGutter?0:n.gutterWidth;if(!q.fixedWidth){j-=n.scrollLeft}q.el.style.left=j+"px";if(q.fixedWidth){q.el.style.right=n.scrollBar.getWidth()+"px"}else{q.el.style.right=""}}}}).call(e.prototype);a.LineWidgets=e});