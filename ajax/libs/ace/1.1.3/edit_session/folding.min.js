define(function(d,c,e){var g=d("../range").Range;var h=d("./fold_line").FoldLine;var a=d("./fold").Fold;var f=d("../token_iterator").TokenIterator;function b(){this.getFoldAt=function(p,m,l){var o=this.getFoldLine(p);if(!o){return null}var n=o.folds;for(var k=0;k<n.length;k++){var j=n[k];if(j.range.contains(p,m)){if(l==1&&j.range.isEnd(p,m)){continue}else{if(l==-1&&j.range.isStart(p,m)){continue}}return j}}};this.getFoldsInRange=function(q){var l=q.start;var n=q.end;var m=this.$foldData;var k=[];l.column+=1;n.column-=1;for(var p=0;p<m.length;p++){var s=m[p].range.compareRange(q);if(s==2){continue}else{if(s==-2){break}}var t=m[p].folds;for(var o=0;o<t.length;o++){var r=t[o];s=r.range.compareRange(q);if(s==-2){break}else{if(s==2){continue}else{if(s==42){break}}}k.push(r)}}l.column-=1;n.column+=1;return k};this.getFoldsInRangeList=function(i){if(Array.isArray(i)){var j=[];i.forEach(function(k){j=j.concat(this.getFoldsInRange(k))},this)}else{var j=this.getFoldsInRange(i)}return j};this.getAllFolds=function(){var n=[];var m=this.$foldData;for(var l=0;l<m.length;l++){for(var k=0;k<m[l].folds.length;k++){n.push(m[l].folds[k])}}return n};this.getFoldStringAt=function(r,k,j,q){q=q||this.getFoldLine(r);if(!q){return null}var m={end:{column:0}};var o,n;for(var l=0;l<q.folds.length;l++){n=q.folds[l];var p=n.range.compareEnd(r,k);if(p==-1){o=this.getLine(n.start.row).substring(m.end.column,n.start.column);break}else{if(p===0){return null}}m=n}if(!o){o=this.getLine(n.start.row).substring(m.end.column)}if(j==-1){return o.substring(0,k-m.end.column)}else{if(j==1){return o.substring(k-m.end.column)}else{return o}}};this.getFoldLine=function(j,k){var m=this.$foldData;var l=0;if(k){l=m.indexOf(k)}if(l==-1){l=0}for(l;l<m.length;l++){var n=m[l];if(n.start.row<=j&&n.end.row>=j){return n}else{if(n.end.row>j){return null}}}return null};this.getNextFoldLine=function(j,k){var m=this.$foldData;var l=0;if(k){l=m.indexOf(k)}if(l==-1){l=0}for(l;l<m.length;l++){var n=m[l];if(n.end.row>=j){return n}}return null};this.getFoldedRowCount=function(p,n){var m=this.$foldData,k=n-p+1;for(var l=0;l<m.length;l++){var o=m[l],j=o.end.row,q=o.start.row;if(j>=n){if(q<n){if(q>=p){k-=n-q}else{k=0}}break}else{if(j>=p){if(q>=p){k-=j-q}else{k-=j-p+1}}}}return k};this.$addFoldLine=function(i){this.$foldData.push(i);this.$foldData.sort(function(k,j){return k.start.row-j.start.row});return i};this.addFold=function(t,n){var j=this.$foldData;var r=false;var q;if(t instanceof a){q=t}else{q=new a(n,t);q.collapseChildren=n.collapseChildren}this.$clipRangeToDocument(q.range);var w=q.start.row;var k=q.start.column;var l=q.end.row;var p=q.end.column;if(!(w<l||w==l&&k<=p-2)){throw new Error("The range has to be at least 2 characters width")}var o=this.getFoldAt(w,k,1);var v=this.getFoldAt(l,p,-1);if(o&&v==o){return o.addSubFold(q)}if((o&&!o.range.isStart(w,k))||(v&&!v.range.isEnd(l,p))){throw new Error("A fold can't intersect already existing fold"+q.range+o.range)}var u=this.getFoldsInRange(q.range);if(u.length>0){this.removeFolds(u);u.forEach(function(i){q.addSubFold(i)})}for(var m=0;m<j.length;m++){var s=j[m];if(l==s.start.row){s.addFold(q);r=true;break}else{if(w==s.end.row){s.addFold(q);r=true;if(!q.sameRow){var x=j[m+1];if(x&&x.start.row==l){s.merge(x);break}}break}else{if(l<=s.start.row){break}}}}if(!r){s=this.$addFoldLine(new h(this.$foldData,q))}if(this.$useWrapMode){this.$updateWrapData(s.start.row,s.start.row)}else{this.$updateRowLengthCache(s.start.row,s.start.row)}this.$modified=true;this._emit("changeFold",{data:q,action:"add"});return q};this.addFolds=function(i){i.forEach(function(j){this.addFold(j)},this)};this.removeFold=function(l){var o=l.foldLine;var k=o.start.row;var j=o.end.row;var m=this.$foldData;var n=o.folds;if(n.length==1){m.splice(m.indexOf(o),1)}else{if(o.range.isEnd(l.end.row,l.end.column)){n.pop();o.end.row=n[n.length-1].end.row;o.end.column=n[n.length-1].end.column}else{if(o.range.isStart(l.start.row,l.start.column)){n.shift();o.start.row=n[0].start.row;o.start.column=n[0].start.column}else{if(l.sameRow){n.splice(n.indexOf(l),1)}else{var i=o.split(l.start.row,l.start.column);n=i.folds;n.shift();i.start.row=n[0].start.row;i.start.column=n[0].start.column}}}}if(!this.$updating){if(this.$useWrapMode){this.$updateWrapData(k,j)}else{this.$updateRowLengthCache(k,j)}}this.$modified=true;this._emit("changeFold",{data:l,action:"remove"})};this.removeFolds=function(l){var j=[];for(var k=0;k<l.length;k++){j.push(l[k])}j.forEach(function(i){this.removeFold(i)},this);this.$modified=true};this.expandFold=function(i){this.removeFold(i);i.subFolds.forEach(function(j){i.restoreRange(j);this.addFold(j)},this);if(i.collapseChildren>0){this.foldAll(i.start.row+1,i.end.row,i.collapseChildren-1)}i.subFolds=[]};this.expandFolds=function(i){i.forEach(function(j){this.expandFold(j)},this)};this.unfold=function(i,k){var j,m;if(i==null){j=new g(0,0,this.getLength(),0);k=true}else{if(typeof i=="number"){j=new g(i,0,i,this.getLine(i).length)}else{if("row" in i){j=g.fromPoints(i,i)}else{j=i}}}m=this.getFoldsInRangeList(j);if(k){this.removeFolds(m)}else{var l=m;while(l.length){this.expandFolds(l);l=this.getFoldsInRangeList(j)}}if(m.length){return m}};this.isRowFolded=function(i,j){return !!this.getFoldLine(i,j)};this.getRowFoldEnd=function(i,j){var k=this.getFoldLine(i,j);return k?k.end.row:i};this.getRowFoldStart=function(i,j){var k=this.getFoldLine(i,j);return k?k.start.row:i};this.getFoldDisplayLine=function(n,j,o,i,l){if(i==null){i=n.start.row;l=0}if(j==null){j=n.end.row;o=this.getLine(j).length}var m=this.doc;var k="";n.walk(function(s,r,q,p){if(r<i){return}if(r==i){if(q<l){return}p=Math.max(l,p)}if(s!=null){k+=s}else{k+=m.getLine(r).substring(p,q)}},j,o);return k};this.getDisplayLine=function(m,n,j,k){var l=this.getFoldLine(m);if(!l){var i;i=this.doc.getLine(m);return i.substring(k||0,n||i.length)}else{return this.getFoldDisplayLine(l,m,n,j,k)}};this.$cloneFoldData=function(){var i=[];i=this.$foldData.map(function(k){var j=k.folds.map(function(l){return l.clone()});return new h(i,j)});return i};this.toggleFold=function(k){var l=this.selection;var i=l.getRange();var j;var p;if(i.isEmpty()){var o=i.start;j=this.getFoldAt(o.row,o.column);if(j){this.expandFold(j);return}else{if(p=this.findMatchingBracket(o)){if(i.comparePoint(p)==1){i.end=p}else{i.start=p;i.start.column++;i.end.column--}}else{if(p=this.findMatchingBracket({row:o.row,column:o.column+1})){if(i.comparePoint(p)==1){i.end=p}else{i.start=p}i.start.column++}else{i=this.getCommentFoldRange(o.row,o.column)||i}}}}else{var m=this.getFoldsInRange(i);if(k&&m.length){this.expandFolds(m);return}else{if(m.length==1){j=m[0]}}}if(!j){j=this.getFoldAt(i.start.row,i.start.column)}if(j&&j.range.toString()==i.toString()){this.expandFold(j);return}var n="...";if(!i.isMultiLine()){n=this.getTextRange(i);if(n.length<4){return}n=n.trim().substring(0,2)+".."}this.addFold(n,i)};this.getCommentFoldRange=function(o,n,j){var m=new f(this,o,n);var k=m.getCurrentToken();if(k&&/^comment|string/.test(k.type)){var i=new g();var l=new RegExp(k.type.replace(/\..*/,"\\."));if(j!=1){do{k=m.stepBackward()}while(k&&l.test(k.type));m.stepForward()}i.start.row=m.getCurrentTokenRow();i.start.column=m.getCurrentTokenColumn()+2;m=new f(this,o,n);if(j!=-1){do{k=m.stepForward()}while(k&&l.test(k.type));k=m.stepBackward()}else{k=m.getCurrentToken()}i.end.row=m.getCurrentTokenRow();i.end.column=m.getCurrentTokenColumn()+k.value.length-2;return i}};this.foldAll=function(k,j,p){if(p==undefined){p=100000}var m=this.foldWidgets;if(!m){return}j=j||this.getLength();k=k||0;for(var o=k;o<j;o++){if(m[o]==null){m[o]=this.getFoldWidget(o)}if(m[o]!="start"){continue}var i=this.getFoldWidgetRange(o);if(i&&i.isMultiLine()&&i.end.row<=j&&i.start.row>=k){o=i.end.row;try{var l=this.addFold("...",i);if(l){l.collapseChildren=p}}catch(n){}}}};this.$foldStyles={manual:1,markbegin:1,markbeginend:1};this.$foldStyle="markbegin";this.setFoldStyle=function(i){if(!this.$foldStyles[i]){throw new Error("invalid fold style: "+i+"["+Object.keys(this.$foldStyles).join(", ")+"]")}if(this.$foldStyle==i){return}this.$foldStyle=i;if(i=="manual"){this.unfold()}var j=this.$foldMode;this.$setFolding(null);this.$setFolding(j)};this.$setFolding=function(i){if(this.$foldMode==i){return}this.$foldMode=i;this.removeListener("change",this.$updateFoldWidgets);this._emit("changeAnnotation");if(!i||this.$foldStyle=="manual"){this.foldWidgets=null;return}this.foldWidgets=[];this.getFoldWidget=i.getFoldWidget.bind(i,this,this.$foldStyle);this.getFoldWidgetRange=i.getFoldWidgetRange.bind(i,this,this.$foldStyle);this.$updateFoldWidgets=this.updateFoldWidgets.bind(this);this.on("change",this.$updateFoldWidgets)};this.getParentFoldRangeData=function(o,l){var n=this.foldWidgets;if(!n||(l&&n[o])){return{}}var m=o-1,j;while(m>=0){var p=n[m];if(p==null){p=n[m]=this.getFoldWidget(m)}if(p=="start"){var k=this.getFoldWidgetRange(m);if(!j){j=k}if(k&&k.end.row>=o){break}}m--}return{range:m!==-1&&k,firstRange:j}};this.onFoldWidgetClick=function(m,l){l=l.domEvent;var j={children:l.shiftKey,all:l.ctrlKey||l.metaKey,siblings:l.altKey};var i=this.$toggleFoldWidget(m,j);if(!i){var k=(l.target||l.srcElement);if(k&&/ace_fold-widget/.test(k.className)){k.className+=" ace_invalid"}}};this.$toggleFoldWidget=function(p,q){if(!this.getFoldWidget){return}var n=this.getFoldWidget(p);var r=this.getLine(p);var i=n==="end"?-1:1;var m=this.getFoldAt(p,i===-1?0:r.length,i);if(m){if(q.children||q.all){this.removeFold(m)}else{this.expandFold(m)}return}var l=this.getFoldWidgetRange(p,true);if(l&&!l.isMultiLine()){m=this.getFoldAt(l.start.row,l.start.column,1);if(m&&l.isEqual(m.range)){this.removeFold(m);return}}if(q.siblings){var k=this.getParentFoldRangeData(p);if(k.range){var o=k.range.start.row+1;var j=k.range.end.row}this.foldAll(o,j,q.all?10000:0)}else{if(q.children){j=l?l.end.row:this.getLength();this.foldAll(p+1,l.end.row,q.all?10000:0)}else{if(l){if(q.all){l.collapseChildren=10000}this.addFold("...",l)}}}return l};this.toggleFoldWidget=function(m){var l=this.selection.getCursor().row;l=this.getRowFoldStart(l);var i=this.$toggleFoldWidget(l,{});if(i){return}var k=this.getParentFoldRangeData(l,true);i=k.range||k.firstRange;if(i){l=i.start.row;var j=this.getFoldAt(l,this.getLine(l).length,1);if(j){this.removeFold(j)}else{this.addFold("...",i)}}};this.updateFoldWidgets=function(l){var n=l.data;var j=n.range;var m=j.start.row;var i=j.end.row-m;if(i===0){this.foldWidgets[m]=null}else{if(n.action=="removeText"||n.action=="removeLines"){this.foldWidgets.splice(m,i+1,null)}else{var k=Array(i+1);k.unshift(m,1);this.foldWidgets.splice.apply(this.foldWidgets,k)}}}}c.Folding=b});