define(function(d,b,e){var c=d("../lib/keys");var a=d("../lib/useragent");function f(h,g){this.platform=g||(a.isMac?"mac":"win");this.commands={};this.commandKeyBinding={};if(this.__defineGetter__&&this.__defineSetter__&&typeof console!="undefined"&&console.error){var i=false;var j=function(){if(!i){i=true;console.error("commmandKeyBinding has too many m's. use commandKeyBinding")}};this.__defineGetter__("commmandKeyBinding",function(){j();return this.commandKeyBinding});this.__defineSetter__("commmandKeyBinding",function(k){j();return this.commandKeyBinding=k})}else{this.commmandKeyBinding=this.commandKeyBinding}this.addCommands(h)}(function(){this.addCommand=function(h){if(this.commands[h.name]){this.removeCommand(h)}this.commands[h.name]=h;if(h.bindKey){this._buildKeyHash(h)}};this.removeCommand=function(l){var h=(typeof l==="string"?l:l.name);l=this.commands[h];delete this.commands[h];var j=this.commandKeyBinding;for(var k in j){for(var i in j[k]){if(j[k][i]==l){delete j[k][i]}}}};this.bindKey=function(h,j){if(!h){return}if(typeof j=="function"){this.addCommand({exec:j,bindKey:h,name:j.name||h});return}var i=this.commandKeyBinding;h.split("|").forEach(function(k){var m=this.parseKeys(k,j);var l=m.hashId;(i[l]||(i[l]={}))[m.key]=j},this)};this.addCommands=function(h){h&&Object.keys(h).forEach(function(i){var j=h[i];if(!j){return}if(typeof j==="string"){return this.bindKey(j,i)}if(typeof j==="function"){j={exec:j}}if(typeof j!=="object"){return}if(!j.name){j.name=i}this.addCommand(j)},this)};this.removeCommands=function(h){Object.keys(h).forEach(function(i){this.removeCommand(h[i])},this)};this.bindKeys=function(h){Object.keys(h).forEach(function(i){this.bindKey(i,h[i])},this)};this._buildKeyHash=function(j){var i=j.bindKey;if(!i){return}var h=typeof i=="string"?i:i[this.platform];this.bindKey(h,j)};this.parseKeys=function(m){if(m.indexOf(" ")!=-1){m=m.split(/\s+/).pop()}var o=m.toLowerCase().split(/[\-\+]([\-\+])?/).filter(function(i){return i});var k=o.pop();var n=c[k];if(c.FUNCTION_KEYS[n]){k=c.FUNCTION_KEYS[n].toLowerCase()}else{if(!o.length){return{key:k,hashId:-1}}else{if(o.length==1&&o[0]=="shift"){return{key:k.toUpperCase(),hashId:-1}}}}var l=0;for(var j=o.length;j--;){var h=c.KEY_MODS[o[j]];if(h==null){if(typeof console!="undefined"){console.error("invalid modifier "+o[j]+" in "+m)}return false}l|=h}return{key:k,hashId:l}};this.findKeyCommand=function g(j,h){var i=this.commandKeyBinding;return i[j]&&i[j][h]};this.handleKeyboard=function(j,i,h,k){return{command:this.findKeyCommand(i,h)}}}).call(f.prototype);b.HashHandler=f});