define(function(f,e,g){var b=f("./vim/commands");var a=b.coreCommands;var d=f("./vim/maps/util");var c=f("../lib/useragent");var h={i:{command:a.start},I:{command:a.startBeginning},a:{command:a.append},A:{command:a.appendEnd},"ctrl-f":{command:"gotopagedown"},"ctrl-b":{command:"gotopageup"}};e.handler={$id:"ace/keyboard/vim",handleMacRepeat:function(k,j,i){if(j==-1){k.inputChar=i;k.lastEvent="input"}else{if(k.inputChar&&k.$lastHash==j&&k.$lastKey==i){if(k.lastEvent=="input"){k.lastEvent="input1"}else{if(k.lastEvent=="input1"){return true}}}else{k.$lastHash=j;k.$lastKey=i;k.lastEvent="keypress"}}},updateMacCompositionHandlers:function(l,j){var i=function(n){if(d.currentMode!=="insert"){var m=this.textInput.getElement();m.blur();m.focus();m.value=n}else{this.onCompositionUpdateOrig(n)}};var k=function(m){if(d.currentMode==="insert"){this.onCompositionStartOrig(m)}};if(j){if(!l.onCompositionUpdateOrig){l.onCompositionUpdateOrig=l.onCompositionUpdate;l.onCompositionUpdate=i;l.onCompositionStartOrig=l.onCompositionStart;l.onCompositionStart=k}}else{if(l.onCompositionUpdateOrig){l.onCompositionUpdate=l.onCompositionUpdateOrig;l.onCompositionUpdateOrig=null;l.onCompositionStart=l.onCompositionStartOrig;l.onCompositionStartOrig=null}}},handleKeyboard:function(m,l,j,o,n){if(l!==0&&(!j||o==-1)){return null}var k=m.editor;if(l==1){j="ctrl-"+j}if(j=="ctrl-c"){if(!c.isMac&&k.getCopyText()){k.once("copy",function(){if(m.state=="start"){a.stop.exec(k)}else{k.selection.clearSelection()}});return{command:"null",passEvent:true}}return{command:a.stop}}else{if((j=="esc"&&l===0)||j=="ctrl-["){return{command:a.stop}}else{if(m.state=="start"){if(c.isMac&&this.handleMacRepeat(m,l,j)){l=-1;j=m.inputChar}if(l==-1||l==1||l===0&&j.length>1){if(b.inputBuffer.idle&&h[j]){return h[j]}var i=b.inputBuffer.push(k,j);return{command:"null",passEvent:!i}}else{if(j.length==1&&(l===0||l==4)){return{command:"null",passEvent:true}}else{if(j=="esc"&&l===0){return{command:a.stop}}}}}else{if(j=="ctrl-w"){return{command:"removewordleft"}}}}}},attach:function(i){i.on("click",e.onCursorMove);if(d.currentMode!=="insert"){b.coreCommands.stop.exec(i)}i.$vimModeHandler=this;this.updateMacCompositionHandlers(i,true)},detach:function(i){i.removeListener("click",e.onCursorMove);d.noMode(i);d.currentMode="normal";this.updateMacCompositionHandlers(i,false)},actions:b.actions,getStatusText:function(){if(d.currentMode=="insert"){return"INSERT"}if(d.onVisualMode){return(d.onVisualLineMode?"VISUAL LINE ":"VISUAL ")+b.inputBuffer.status}return b.inputBuffer.status}};e.onCursorMove=function(i){b.onCursorMove(i.editor,i);e.onCursorMove.scheduled=false}});