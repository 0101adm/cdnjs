define(function(b,a,c){var f=b("../lib/oop");var d=b("../keyboard/hash_handler").HashHandler;var e=b("../lib/event_emitter").EventEmitter;var g=function(i,h){d.call(this,h,i);this.byName=this.commands;this.setDefaultHandler("exec",function(j){return j.command.exec(j.editor,j.args||{})})};f.inherits(g,d);(function(){f.implement(this,e);this.exec=function(l,j,i){if(typeof l==="string"){l=this.commands[l]}if(!l){return false}if(j&&j.$readOnly&&!l.readOnly){return false}var k={editor:j,command:l,args:i};var h=this._emit("exec",k);this._signal("afterExec",k);return h===false?false:true};this.toggleRecording=function(h){if(this.$inReplay){return}h&&h._emit("changeStatus");if(this.recording){this.macro.pop();this.removeEventListener("exec",this.$addCommandToMacro);if(!this.macro.length){this.macro=this.oldMacro}return this.recording=false}if(!this.$addCommandToMacro){this.$addCommandToMacro=function(i){this.macro.push([i.command,i.args])}.bind(this)}this.oldMacro=this.macro;this.macro=[];this.on("exec",this.$addCommandToMacro);return this.recording=true};this.replay=function(h){if(this.$inReplay||!this.macro){return}if(this.recording){return this.toggleRecording(h)}try{this.$inReplay=true;this.macro.forEach(function(i){if(typeof i=="string"){this.exec(i,h)}else{this.exec(i[0],h,i[1])}},this)}finally{this.$inReplay=false}};this.trimMacro=function(h){return h.map(function(i){if(typeof i[0]!="string"){i[0]=i[0].name}if(!i[1]){i=i[0]}return i})}}).call(g.prototype);a.CommandManager=g});