define(function(c,e,b){var g=c("../lib/oop");var d=c("../lib/dom");var a=c("../lib/lang");var i=c("../lib/event_emitter").EventEmitter;var h=0;var f=e.FontMetrics=function(k,j){this.el=d.createElement("div");this.$setMeasureNodeStyles(this.el.style,true);this.$main=d.createElement("div");this.$setMeasureNodeStyles(this.$main.style);this.$measureNode=d.createElement("div");this.$setMeasureNodeStyles(this.$measureNode.style);this.el.appendChild(this.$main);this.el.appendChild(this.$measureNode);k.appendChild(this.el);if(!h){this.$testFractionalRect()}this.$measureNode.textContent=a.stringRepeat("X",h);this.$characterSize={width:0,height:0};this.checkForSizeChanges()};(function(){g.implement(this,i);this.$characterSize={width:0,height:0};this.$testFractionalRect=function(){var k=d.createElement("div");this.$setMeasureNodeStyles(k.style);k.style.width="0.2px";document.documentElement.appendChild(k);var j=k.getBoundingClientRect().width;if(j>0&&j<1){h=1}else{h=100}k.parentNode.removeChild(k)};this.$setMeasureNodeStyles=function(k,j){k.width=k.height="auto";k.left=k.top="-100px";k.visibility="hidden";k.position="fixed";k.whiteSpace="pre";k.font="inherit";k.overflow=j?"hidden":"visible"};this.checkForSizeChanges=function(){var k=this.$measureSizes();if(k&&(this.$characterSize.width!==k.width||this.$characterSize.height!==k.height)){this.$measureNode.style.fontWeight="bold";var j=this.$measureSizes();this.$measureNode.style.fontWeight="";this.$characterSize=k;this.charSizes=Object.create(null);this.allowBoldFonts=j&&j.width===k.width&&j.height===k.height;this._emit("changeCharacterSize",{data:k})}};this.$pollSizeChanges=function(){if(this.$pollSizeChangesTimer){return this.$pollSizeChangesTimer}var j=this;return this.$pollSizeChangesTimer=setInterval(function(){j.checkForSizeChanges()},500)};this.setPolling=function(j){if(j){this.$pollSizeChanges()}else{if(this.$pollSizeChangesTimer){this.$pollSizeChangesTimer}}};this.$measureSizes=function(){var k=this.$measureNode.getBoundingClientRect();var j={height:k.height,width:k.width/h};if(j.width===0||j.height===0){return null}return j};this.$measureCharWidth=function(j){this.$main.textContent=a.stringRepeat(j,h);var k=this.$main.getBoundingClientRect();return k.width/h};this.getCharacterWidth=function(k){var j=this.charSizes[k];if(j===undefined){this.charSizes[k]=this.$measureCharWidth(k)/this.$characterSize.width}return j};this.destroy=function(){clearInterval(this.$pollSizeChangesTimer);if(this.el&&this.el.parentNode){this.el.parentNode.removeChild(this.el)}}}).call(f.prototype)});