define(function(f,g,e){var i=f("./keyboard/hash_handler").HashHandler;var k=f("./autocomplete/popup").AcePopup;var h=f("./autocomplete/util");var c=f("./lib/event");var d=f("./lib/lang");var b=f("./snippets").snippetManager;var j=function(){this.autoInsert=true;this.keyboardHandler=new i();this.keyboardHandler.bindKeys(this.commands);this.blurListener=this.blurListener.bind(this);this.changeListener=this.changeListener.bind(this);this.mousedownListener=this.mousedownListener.bind(this);this.mousewheelListener=this.mousewheelListener.bind(this);this.changeTimer=d.delayedCall(function(){this.updateCompletions(true)}.bind(this))};(function(){this.$init=function(){this.popup=new k(document.body||document.documentElement);this.popup.on("click",function(l){this.insertMatch();l.stop()}.bind(this))};this.openPopup=function(m,p,r){if(!this.popup){this.$init()}this.popup.setData(this.completions.filtered);var o=m.renderer;if(!r){this.popup.setRow(0);this.popup.setFontSize(m.getFontSize());var l=o.layerConfig.lineHeight;var q=o.$cursorLayer.getPixelPosition(this.base,true);q.left-=this.popup.getTextLeftOffset();var n=m.container.getBoundingClientRect();q.top+=n.top-o.layerConfig.offset;q.left+=n.left-m.renderer.scrollLeft;q.left+=o.$gutterLayer.gutterWidth;this.popup.show(q,l)}};this.detach=function(){this.editor.keyBinding.removeKeyboardHandler(this.keyboardHandler);this.editor.off("changeSelection",this.changeListener);this.editor.off("blur",this.blurListener);this.editor.off("mousedown",this.mousedownListener);this.editor.off("mousewheel",this.mousewheelListener);this.changeTimer.cancel();if(this.popup){this.popup.hide()}this.activated=false;this.completions=this.base=null};this.changeListener=function(l){var m=this.editor.selection.lead;if(m.row!=this.base.row||m.column<this.base.column){this.detach()}if(this.activated){this.changeTimer.schedule()}else{this.detach()}};this.blurListener=function(){if(document.activeElement!=this.editor.textInput.getElement()){this.detach()}};this.mousedownListener=function(l){this.detach()};this.mousewheelListener=function(l){this.detach()};this.goTo=function(m){var n=this.popup.getRow();var l=this.popup.session.getLength()-1;switch(m){case"up":n=n<0?l:n-1;break;case"down":n=n>=l?-1:n+1;break;case"start":n=0;break;case"end":n=l;break}this.popup.setRow(n)};this.insertMatch=function(o){if(!o){o=this.popup.getData(this.popup.getRow())}if(!o){return false}if(o.completer&&o.completer.insertMatch){o.completer.insertMatch(this.editor)}else{if(this.completions.filterText){var l=this.editor.selection.getAllRanges();for(var n=0,m;m=l[n];n++){m.start.column-=this.completions.filterText.length;this.editor.session.remove(m)}}if(o.snippet){b.insertSnippet(this.editor,o.snippet)}else{this.editor.execCommand("insertstring",o.value||o)}}this.detach()};this.commands={Up:function(l){l.completer.goTo("up")},Down:function(l){l.completer.goTo("down")},"Ctrl-Up|Ctrl-Home":function(l){l.completer.goTo("start")},"Ctrl-Down|Ctrl-End":function(l){l.completer.goTo("end")},Esc:function(l){l.completer.detach()},Space:function(l){l.completer.detach();l.insert(" ")},Return:function(l){l.completer.insertMatch()},"Shift-Return":function(l){l.completer.insertMatch(true)},Tab:function(l){l.completer.insertMatch()},PageUp:function(l){l.completer.popup.gotoPageUp()},PageDown:function(l){l.completer.popup.gotoPageDown()}};this.gatherCompletions=function(m,r){var p=m.getSession();var q=m.getCursorPosition();var l=p.getLine(q.row);var o=h.retrievePrecedingIdentifier(l,q.column);this.base=m.getCursorPosition();this.base.column-=o.length;var n=[];h.parForEach(m.completers,function(s,t){s.getCompletions(m,p,q,o,function(v,u){if(!v){n=n.concat(u)}t()})},function(){r(null,{prefix:o,matches:n})});return true};this.showPopup=function(l){if(this.editor){this.detach()}this.activated=true;this.editor=l;if(l.completer!=this){if(l.completer){l.completer.detach()}l.completer=this}l.keyBinding.addKeyboardHandler(this.keyboardHandler);l.on("changeSelection",this.changeListener);l.on("blur",this.blurListener);l.on("mousedown",this.mousedownListener);l.on("mousewheel",this.mousewheelListener);this.updateCompletions()};this.updateCompletions=function(n){if(n&&this.base&&this.completions){var m=this.editor.getCursorPosition();var l=this.editor.session.getTextRange({start:this.base,end:m});if(l==this.completions.filterText){return}this.completions.setFilter(l);if(!this.completions.filtered.length){return this.detach()}this.openPopup(this.editor,l,n);return}this.gatherCompletions(this.editor,function(q,p){var r=p&&p.matches;if(!r||!r.length){return this.detach()}this.completions=new a(r);this.completions.setFilter(p.prefix);var o=this.completions.filtered;if(!o.length){return this.detach()}if(this.autoInsert&&o.length==1){return this.insertMatch(o[0])}this.openPopup(this.editor,p.prefix,n)}.bind(this))};this.cancelContextMenu=function(){var l=function(m){this.editor.off("nativecontextmenu",l);if(m&&m.domEvent){c.stopEvent(m.domEvent)}}.bind(this);setTimeout(l,10);this.editor.on("nativecontextmenu",l)}}).call(j.prototype);j.startCommand={name:"startAutocomplete",exec:function(l){if(!l.completer){l.completer=new j()}l.completer.showPopup(l);l.completer.cancelContextMenu()},bindKey:"Ctrl-Space|Ctrl-Shift-Space|Alt-Space"};var a=function(n,m,l){this.all=n;this.filtered=n;this.filterText=m||""};(function(){this.setFilter=function(n){if(n.length>this.filterText&&n.lastIndexOf(this.filterText,0)===0){var m=this.filtered}else{var m=this.all}this.filterText=n;m=this.filterCompletions(m,this.filterText);m=m.sort(function(p,o){return o.exactMatch-p.exactMatch||o.score-p.score});var l=null;m=m.filter(function(p){var o=p.value||p.caption||p.snippet;if(o===l){return false}l=o;return true});this.filtered=m};this.filterCompletions=function(w,q){var r=[];var y=q.toUpperCase();var t=q.toLowerCase();loop:for(var s=0,z;z=w[s];s++){var A=z.value||z.caption||z.snippet;if(!A){continue}var u=-1;var p=0;var x=0;var v,l;for(var o=0;o<q.length;o++){var n=A.indexOf(t[o],u+1);var m=A.indexOf(y[o],u+1);v=(n>=0)?((m<0||n<m)?n:m):m;if(v<0){continue loop}l=v-u-1;if(l>0){if(u===-1){x+=10}x+=l}p=p|(1<<v);u=v}z.matchMask=p;z.exactMatch=x?0:1;z.score=(z.score||0)-x;r.push(z)}return r}}).call(a.prototype);g.Autocomplete=j;g.FilteredList=a});