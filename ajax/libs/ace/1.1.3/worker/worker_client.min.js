define(function(c,a,d){var f=c("../lib/oop");var e=c("../lib/event_emitter").EventEmitter;var b=c("../config");var h=function(j,p,k,q){this.$sendDeltaQueue=this.$sendDeltaQueue.bind(this);this.changeListener=this.changeListener.bind(this);this.onMessage=this.onMessage.bind(this);if(c.nameToUrl&&!c.toUrl){c.toUrl=c.nameToUrl}if(b.get("packaged")||!c.toUrl){q=q||b.moduleUrl(p,"worker")}else{var l=this.$normalizePath;q=q||l(c.toUrl("ace/worker/worker.js",null,"_"));var r={};j.forEach(function(s){r[s]=l(c.toUrl(s,null,"_").replace(/(\.js)?(\?.*)?$/,""))})}try{this.$worker=new Worker(q)}catch(n){if(n instanceof window.DOMException){var i=this.$workerBlob(q);var o=window.URL||window.webkitURL;var m=o.createObjectURL(i);this.$worker=new Worker(m);o.revokeObjectURL(m)}else{throw n}}this.$worker.postMessage({init:true,tlns:r,module:p,classname:k});this.callbackId=1;this.callbacks={};this.$worker.onmessage=this.onMessage};(function(){f.implement(this,e);this.onMessage=function(i){var j=i.data;switch(j.type){case"log":window.console&&console.log&&console.log.apply(console,j.data);break;case"event":this._signal(j.name,{data:j.data});break;case"call":var k=this.callbacks[j.id];if(k){k(j.data);delete this.callbacks[j.id]}break}};this.$normalizePath=function(i){if(!location.host){return i}i=i.replace(/^[a-z]+:\/\/[^\/]+/,"");i=location.protocol+"//"+location.host+(i.charAt(0)=="/"?"":location.pathname.replace(/\/[^\/]*$/,""))+"/"+i.replace(/^[\/]+/,"");return i};this.terminate=function(){this._signal("terminate",{});this.deltaQueue=null;this.$worker.terminate();this.$worker=null;this.$doc.removeEventListener("change",this.changeListener);this.$doc=null};this.send=function(j,i){this.$worker.postMessage({command:j,args:i})};this.call=function(j,i,l){if(l){var k=this.callbackId++;this.callbacks[k]=l;i.push(k)}this.send(j,i)};this.emit=function(j,k){try{this.$worker.postMessage({event:j,data:{data:k.data}})}catch(i){}};this.attachToDocument=function(i){if(this.$doc){this.terminate()}this.$doc=i;this.call("setValue",[i.getValue()]);i.on("change",this.changeListener)};this.changeListener=function(i){if(!this.deltaQueue){this.deltaQueue=[i.data];setTimeout(this.$sendDeltaQueue,0)}else{this.deltaQueue.push(i.data)}};this.$sendDeltaQueue=function(){var i=this.deltaQueue;if(!i){return}this.deltaQueue=null;if(i.length>20&&i.length>this.$doc.getLength()>>1){this.call("setValue",[this.$doc.getValue()])}else{this.emit("change",{data:i})}};this.$workerBlob=function(k){var i="importScripts('"+k+"');";try{return new Blob([i],{type:"application/javascript"})}catch(m){var l=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder;var j=new l();j.append(i);return j.getBlob("application/javascript")}}}).call(h.prototype);var g=function(m,l,p){this.$sendDeltaQueue=this.$sendDeltaQueue.bind(this);this.changeListener=this.changeListener.bind(this);this.callbackId=1;this.callbacks={};this.messageBuffer=[];var j=null;var o=false;var k=Object.create(e);var i=this;this.$worker={};this.$worker.terminate=function(){};this.$worker.postMessage=function(q){i.messageBuffer.push(q);if(j){if(o){setTimeout(n)}else{n()}}};this.setEmitSync=function(q){o=q};var n=function(){var q=i.messageBuffer.shift();if(q.command){j[q.command].apply(j,q.args)}else{if(q.event){k._signal(q.event,q.data)}}};k.postMessage=function(q){i.onMessage({data:q})};k.callback=function(r,q){this.postMessage({type:"call",id:q,data:r})};k.emit=function(q,r){this.postMessage({type:"event",name:q,data:r})};b.loadModule(["worker",l],function(q){j=new q[p](k);while(i.messageBuffer.length){n()}})};g.prototype=h.prototype;a.UIWorkerClient=g;a.WorkerClient=h});