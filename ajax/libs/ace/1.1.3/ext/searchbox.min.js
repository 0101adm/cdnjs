define(function(e,h,d){var g=e("../lib/dom");var c=e("../lib/lang");var b=e("../lib/event");var k=e("../requirejs/text!./searchbox.css");var j=e("../keyboard/hash_handler").HashHandler;var f=e("../lib/keys");g.importCssString(k,"ace_searchbox");var i='<div class="ace_search right">    <button type="button" action="hide" class="ace_searchbtn_close"></button>    <div class="ace_search_form">        <input class="ace_search_field" placeholder="Search for" spellcheck="false"></input>        <button type="button" action="findNext" class="ace_searchbtn next"></button>        <button type="button" action="findPrev" class="ace_searchbtn prev"></button>    </div>    <div class="ace_replace_form">        <input class="ace_search_field" placeholder="Replace with" spellcheck="false"></input>        <button type="button" action="replaceAndFindNext" class="ace_replacebtn">Replace</button>        <button type="button" action="replaceAll" class="ace_replacebtn">All</button>    </div>    <div class="ace_search_options">        <span action="toggleRegexpMode" class="ace_button" title="RegExp Search">.*</span>        <span action="toggleCaseSensitive" class="ace_button" title="CaseSensitive Search">Aa</span>        <span action="toggleWholeWords" class="ace_button" title="Whole Word Search">\\b</span>    </div></div>'.replace(/>\s+/g,">");var a=function(m,l,n){var o=g.createElement("div");o.innerHTML=i;this.element=o.firstChild;this.$init();this.setEditor(m)};(function(){this.setEditor=function(l){l.searchBox=this;l.container.appendChild(this.element);this.editor=l};this.$initElements=function(l){this.searchBox=l.querySelector(".ace_search_form");this.replaceBox=l.querySelector(".ace_replace_form");this.searchOptions=l.querySelector(".ace_search_options");this.regExpOption=l.querySelector("[action=toggleRegexpMode]");this.caseSensitiveOption=l.querySelector("[action=toggleCaseSensitive]");this.wholeWordOption=l.querySelector("[action=toggleWholeWords]");this.searchInput=this.searchBox.querySelector(".ace_search_field");this.replaceInput=this.replaceBox.querySelector(".ace_search_field")};this.$init=function(){var m=this.element;this.$initElements(m);var l=this;b.addListener(m,"mousedown",function(n){setTimeout(function(){l.activeInput.focus()},0);b.stopPropagation(n)});b.addListener(m,"click",function(p){var n=p.target||p.srcElement;var o=n.getAttribute("action");if(o&&l[o]){l[o]()}else{if(l.$searchBarKb.commands[o]){l.$searchBarKb.commands[o].exec(l)}}b.stopPropagation(p)});b.addCommandKeyListener(m,function(q,o,p){var n=f.keyCodeToString(p);var r=l.$searchBarKb.findKeyCommand(o,n);if(r&&r.exec){r.exec(l);b.stopEvent(q)}});this.$onChange=c.delayedCall(function(){l.find(false,false)});b.addListener(this.searchInput,"input",function(){l.$onChange.schedule(20)});b.addListener(this.searchInput,"focus",function(){l.activeInput=l.searchInput;l.searchInput.value&&l.highlight()});b.addListener(this.replaceInput,"focus",function(){l.activeInput=l.replaceInput;l.searchInput.value&&l.highlight()})};this.$closeSearchBarKb=new j([{bindKey:"Esc",name:"closeSearchBar",exec:function(l){l.searchBox.hide()}}]);this.$searchBarKb=new j();this.$searchBarKb.bindKeys({"Ctrl-f|Command-f|Ctrl-H|Command-Option-F":function(m){var l=m.isReplace=!m.isReplace;m.replaceBox.style.display=l?"":"none";m[l?"replaceInput":"searchInput"].focus()},"Ctrl-G|Command-G":function(l){l.findNext()},"Ctrl-Shift-G|Command-Shift-G":function(l){l.findPrev()},esc:function(l){setTimeout(function(){l.hide()})},Return:function(l){if(l.activeInput==l.replaceInput){l.replace()}l.findNext()},"Shift-Return":function(l){if(l.activeInput==l.replaceInput){l.replace()}l.findPrev()},Tab:function(l){(l.activeInput==l.replaceInput?l.searchInput:l.replaceInput).focus()}});this.$searchBarKb.addCommands([{name:"toggleRegexpMode",bindKey:{win:"Alt-R|Alt-/",mac:"Ctrl-Alt-R|Ctrl-Alt-/"},exec:function(l){l.regExpOption.checked=!l.regExpOption.checked;l.$syncOptions()}},{name:"toggleCaseSensitive",bindKey:{win:"Alt-C|Alt-I",mac:"Ctrl-Alt-R|Ctrl-Alt-I"},exec:function(l){l.caseSensitiveOption.checked=!l.caseSensitiveOption.checked;l.$syncOptions()}},{name:"toggleWholeWords",bindKey:{win:"Alt-B|Alt-W",mac:"Ctrl-Alt-B|Ctrl-Alt-W"},exec:function(l){l.wholeWordOption.checked=!l.wholeWordOption.checked;l.$syncOptions()}}]);this.$syncOptions=function(){g.setCssClass(this.regExpOption,"checked",this.regExpOption.checked);g.setCssClass(this.wholeWordOption,"checked",this.wholeWordOption.checked);g.setCssClass(this.caseSensitiveOption,"checked",this.caseSensitiveOption.checked);this.find(false,false)};this.highlight=function(l){this.editor.session.highlight(l||this.editor.$search.$options.re);this.editor.renderer.updateBackMarkers()};this.find=function(o,m){var n=this.editor.find(this.searchInput.value,{skipCurrent:o,backwards:m,wrap:true,regExp:this.regExpOption.checked,caseSensitive:this.caseSensitiveOption.checked,wholeWord:this.wholeWordOption.checked});var l=!n&&this.searchInput.value;g.setCssClass(this.searchBox,"ace_nomatch",l);this.editor._emit("findSearchBox",{match:!l});this.highlight()};this.findNext=function(){this.find(true,false)};this.findPrev=function(){this.find(true,true)};this.replace=function(){if(!this.editor.getReadOnly()){this.editor.replace(this.replaceInput.value)}};this.replaceAndFindNext=function(){if(!this.editor.getReadOnly()){this.editor.replace(this.replaceInput.value);this.findNext()}};this.replaceAll=function(){if(!this.editor.getReadOnly()){this.editor.replaceAll(this.replaceInput.value)}};this.hide=function(){this.element.style.display="none";this.editor.keyBinding.removeKeyboardHandler(this.$closeSearchBarKb);this.editor.focus()};this.show=function(l,m){this.element.style.display="";this.replaceBox.style.display=m?"":"none";this.isReplace=m;if(l){this.searchInput.value=l}this.searchInput.focus();this.searchInput.select();this.editor.keyBinding.addKeyboardHandler(this.$closeSearchBarKb)}}).call(a.prototype);h.SearchBox=a;h.Search=function(l,m){var n=l.searchBox||new a(l);n.show(l.session.getTextRange(),m)}});