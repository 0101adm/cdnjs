define(function(d,g,b){var k=d("ace/keyboard/hash_handler").HashHandler;var j=d("ace/editor").Editor;var a=d("ace/snippets").snippetManager;var c=d("ace/range").Range;var e;j.prototype.indexToPosition=function(n){return this.session.doc.indexToPosition(n)};j.prototype.positionToIndex=function(n){return this.session.doc.positionToIndex(n)};function h(){}h.prototype={setupContext:function(n){this.ace=n;this.indentation=n.session.getTabString();if(!e){e=window.emmet}e.require("resources").setVariable("indentation",this.indentation);this.$syntax=null;this.$syntax=this.getSyntax()},getSelectionRange:function(){var n=this.ace.getSelectionRange();return{start:this.ace.positionToIndex(n.start),end:this.ace.positionToIndex(n.end)}},createSelection:function(o,n){this.ace.selection.setRange({start:this.ace.indexToPosition(o),end:this.ace.indexToPosition(n)})},getCurrentLineRange:function(){var p=this.ace.getCursorPosition().row;var n=this.ace.session.getLine(p).length;var o=this.ace.positionToIndex({row:p,column:0});return{start:o,end:o+n}},getCaretPos:function(){var n=this.ace.getCursorPosition();return this.ace.positionToIndex(n)},setCaretPos:function(n){var o=this.ace.indexToPosition(n);this.ace.selection.moveToPosition(o)},getCurrentLine:function(){var n=this.ace.getCursorPosition().row;return this.ace.session.getLine(n)},replaceContent:function(r,s,n,q){if(n==null){n=s==null?this.getContent().length:s}if(s==null){s=0}var p=this.ace;var o=c.fromPoints(p.indexToPosition(s),p.indexToPosition(n));p.session.remove(o);o.end=o.start;r=this.$updateTabstops(r);a.insertSnippet(p,r)},getContent:function(){return this.ace.getValue()},getSyntax:function(){if(this.$syntax){return this.$syntax}var n=this.ace.session.$modeId.split("/").pop();if(n=="html"||n=="php"){var p=this.ace.getCursorPosition();var o=this.ace.session.getState(p.row);if(typeof o!="string"){o=o[0]}if(o){o=o.split("-");if(o.length>1){n=o[0]}else{if(n=="php"){n="html"}}}}return n},getProfileName:function(){switch(this.getSyntax()){case"css":return"css";case"xml":case"xsl":return"xml";case"html":var n=e.require("resources").getVariable("profile");if(!n){n=this.ace.session.getLines(0,2).join("").search(/<!DOCTYPE[^>]+XHTML/i)!=-1?"xhtml":"html"}return n}return"xhtml"},prompt:function(n){return prompt(n)},getSelection:function(){return this.ace.session.getTextRange()},getFilePath:function(){return""},$updateTabstops:function(t){var s=1000;var r=0;var q=null;var n=e.require("range");var p=e.require("tabStops");var o=e.require("resources").getVocabulary("user");var u={tabstop:function(x){var y=parseInt(x.group,10);var w=y===0;if(w){y=++r}else{y+=s}var z=x.placeholder;if(z){z=p.processText(z,u)}var v="${"+y+(z?":"+z:"")+"}";if(w){q=n.create(x.start,v)}return v},escape:function(v){if(v=="$"){return"\\$"}if(v=="\\"){return"\\\\"}return v}};t=p.processText(t,u);if(o.variables.insert_final_tabstop&&!/\$\{0\}$/.test(t)){t+="${0}"}else{if(q){t=e.require("utils").replaceSubstring(t,"${0}",q)}}return t}};var i={expand_abbreviation:{mac:"ctrl+alt+e",win:"alt+e"},match_pair_outward:{mac:"ctrl+d",win:"ctrl+,"},match_pair_inward:{mac:"ctrl+j",win:"ctrl+shift+0"},matching_pair:{mac:"ctrl+alt+j",win:"alt+j"},next_edit_point:"alt+right",prev_edit_point:"alt+left",toggle_comment:{mac:"command+/",win:"ctrl+/"},split_join_tag:{mac:"shift+command+'",win:"shift+ctrl+`"},remove_tag:{mac:"command+'",win:"shift+ctrl+;"},evaluate_math_expression:{mac:"shift+command+y",win:"shift+ctrl+y"},increment_number_by_1:"ctrl+up",decrement_number_by_1:"ctrl+down",increment_number_by_01:"alt+up",decrement_number_by_01:"alt+down",increment_number_by_10:{mac:"alt+command+up",win:"shift+alt+up"},decrement_number_by_10:{mac:"alt+command+down",win:"shift+alt+down"},select_next_item:{mac:"shift+command+.",win:"shift+ctrl+."},select_previous_item:{mac:"shift+command+,",win:"shift+ctrl+,"},reflect_css_value:{mac:"shift+command+r",win:"shift+ctrl+r"},encode_decode_data_url:{mac:"shift+ctrl+d",win:"ctrl+'"},expand_abbreviation_with_tab:"Tab",wrap_with_abbreviation:{mac:"shift+ctrl+a",win:"shift+ctrl+a"}};var l=new h();g.commands=new k();g.runEmmetCommand=function(o){l.setupContext(o);if(l.getSyntax()=="php"){return false}var q=e.require("actions");if(this.action=="expand_abbreviation_with_tab"){if(!o.selection.isEmpty()){return false}}if(this.action=="wrap_with_abbreviation"){return setTimeout(function(){q.run("wrap_with_abbreviation",l)},0)}try{var n=q.run(this.action,l)}catch(p){o._signal("changeStatus",typeof p=="string"?p:p.message);console.log(p)}return n};for(var f in i){g.commands.addCommand({name:"emmet:"+f,action:f,bindKey:i[f],exec:g.runEmmetCommand,multiSelectAction:"forEach"})}var m=function(q,p){var o=p;if(!o){return}var r=o.session.$modeId;var n=r&&/css|less|scss|sass|stylus|html|php/.test(r);if(q.enableEmmet===false){n=false}if(n){o.keyBinding.addKeyboardHandler(g.commands)}else{o.keyBinding.removeKeyboardHandler(g.commands)}};g.AceEmmetEditor=h;d("ace/config").defineOptions(j.prototype,"editor",{enableEmmet:{set:function(n){this[n?"on":"removeListener"]("changeMode",m);m({enableEmmet:!!n},this)},value:true}});g.setCore=function(n){e=n}});