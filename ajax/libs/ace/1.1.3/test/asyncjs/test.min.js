/*!
 * async.js
 * Copyright(c) 2010 Fabian Jakobs <fabian.jakobs@web.de>
 * MIT Licensed
 */
define(function(b,a,c){var e=b("ace/lib/oop");var d=b("asyncjs/async");b("asyncjs/utils");a.TestGenerator=function(f){d.Generator.call(this,f)};e.inherits(a.TestGenerator,d.Generator);(function(){this.exec=function(){this.run().report().summary(function(f,g){console.log("DONE")})};this.run=function(){return this.setupTest().each(function(g,f){if(g.setUpSuite){g.setUpSuite(f)}else{f()}}).each(function(g,f){g.test(function(h,i){g.err=h;g.passed=i;f()})}).each(function(g,f){if(g.tearDownSuite){g.tearDownSuite(f)}else{f()}})};this.report=function(){return this.each(function(i,h){var f=i.passed?"\x1b[32m":"\x1b[31m";var g=i.name;if(i.suiteName){g=i.suiteName+": "+i.name}console.log(f+"["+i.count+"/"+i.index+"] "+g+" "+(i.passed?"OK":"FAIL")+"\x1b[0m");if(!i.passed){if(i.err.stack){console.log(i.err.stack)}else{console.log(i.err)}}h()})};this.summary=function(h){var g=0;var f=0;this.each(function(i){if(i.passed){g+=1}else{f+=1}}).end(function(){console.log("");console.log("Summary:");console.log("");console.log("Total number of tests: "+(g+f));g&&console.log("\x1b[32mPassed tests:          "+g+"\x1b[0m");f&&console.log("\x1b[31mFailed tests:          "+f+"\x1b[0m");console.log("");h(null,f==0)})};this.setupTest=function(){return this.each(function(m,j){var k=function(n){n()};var i=m.context||this;if(m.setUp){var h=d.makeAsync(0,m.setUp,i)}else{h=k}tearDownCalled=false;if(m.tearDown){var f=d.makeAsync(0,m.tearDown,i)}else{f=k}function g(n){tearDownCalled=true;f.call(m.context,n)}var l=d.makeAsync(0,m.fn,i);m.test=function(p){var n;function o(q){if(n){return}n=true;if(!tearDownCalled){d.list([g]).call().timeout(m.timeout).end(function(){p(q,false)})}else{p(q,false)}}d.list([h,l,g]).delay(0).call(i).timeout(m.timeout).toArray(false,function(s,q){if(n){return}n=true;var r=s[1];p(r,!r)})};j()})}}).call(a.TestGenerator.prototype);a.testcase=function(h,g,p){var k=[];for(var f in h){k.push(f)}var m=h.setUp||null;var j=h.tearDown||null;var q;k.forEach(function(i){if(i.charAt(0)==">"){q=i}});if(q){k=[q]}var n=k.filter(function(i){return i.match(/^>?test/)&&typeof(h[i])=="function"});var o=n.length;var l=1;tests=n.map(function(i){return{suiteName:g||h.name||"",name:i,setUp:m,tearDown:j,context:h,timeout:p===undefined?3000:p,fn:h[i],count:o,index:l++}});if(h.setUpSuite){tests[0].setUpSuite=d.makeAsync(0,h.setUpSuite,h)}if(h.tearDownSuite){tests[tests.length-1].tearDownSuite=d.makeAsync(0,h.tearDownSuite,h)}return d.list(tests,a.TestGenerator)}});