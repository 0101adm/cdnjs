define(function(c,a,d){var g=c("./lib/lang");var e=c("./lib/oop");var f=c("./range").Range;var b=function(){this.$options={}};(function(){this.set=function(h){e.mixin(this.$options,h);return this};this.getOptions=function(){return g.copyObject(this.$options)};this.setOptions=function(h){this.$options=h};this.find=function(j){var i=this.$matchIterator(j,this.$options);if(!i){return false}var h=null;i.forEach(function(k,n,m){if(!k.start){var l=k.offset+(m||0);h=new f(n,l,n,l+k.length)}else{h=k}return true});return h};this.findAll=function(k){var q=this.$options;if(!q.needle){return[]}this.$assembleRegExp(q);var v=q.range;var h=v?k.getLines(v.start.row,v.end.row):k.doc.getAllLines();var o=[];var x=q.re;if(q.$isMultiLine){var C=x.length;var y=h.length-C;var w;outer:for(var s=x.offset||0;s<=y;s++){for(var A=0;A<C;A++){if(h[s+A].search(x[A])==-1){continue outer}}var z=h[s];var u=h[s+C-1];var r=z.length-z.match(x[0])[0].length;var n=u.match(x[C-1])[0].length;if(w&&w.end.row===s&&w.end.column>r){continue}o.push(w=new f(s,r,s+C-1,n));if(C>2){s=s+C-2}}}else{for(var B=0;B<h.length;B++){var l=g.getMatchOffsets(h[B],x);for(var A=0;A<l.length;A++){var t=l[A];o.push(new f(B,t.offset,B,t.offset+t.length))}}}if(v){var p=v.start.column;var m=v.start.column;var B=0,A=o.length-1;while(B<A&&o[B].start.column<p&&o[B].start.row==v.start.row){B++}while(B<A&&o[A].end.column>m&&o[A].end.row==v.end.row){A--}o=o.slice(B,A+1);for(B=0,A=o.length;B<A;B++){o[B].start.row+=v.start.row;o[B].end.row+=v.start.row}}return o};this.replace=function(h,o){var k=this.$options;var n=this.$assembleRegExp(k);if(k.$isMultiLine){return o}if(!n){return}var j=n.exec(h);if(!j||j[0].length!=h.length){return null}o=h.replace(n,o);if(k.preserveCase){o=o.split("");for(var l=Math.min(h.length,h.length);l--;){var m=h[l];if(m&&m.toLowerCase()!=m){o[l]=o[l].toUpperCase()}else{o[l]=o[l].toLowerCase()}}o=o.join("")}return o};this.$matchIterator=function(n,k){var m=this.$assembleRegExp(k);if(!m){return false}var j=this,o,i=k.backwards;if(k.$isMultiLine){var h=m.length;var l=function(p,v,u){var t=p.search(m[0]);if(t==-1){return}for(var r=1;r<h;r++){p=n.getLine(v+r);if(p.search(m[r])==-1){return}}var s=p.match(m[h-1])[0].length;var q=new f(v,t,v+h-1,s);if(m.offset==1){q.start.row--;q.start.column=Number.MAX_VALUE}else{if(u){q.start.column+=u}}if(o(q)){return true}}}else{if(i){var l=function(p,t,s){var r=g.getMatchOffsets(p,m);for(var q=r.length-1;q>=0;q--){if(o(r[q],t,s)){return true}}}}else{var l=function(p,t,s){var r=g.getMatchOffsets(p,m);for(var q=0;q<r.length;q++){if(o(r[q],t,s)){return true}}}}}return{forEach:function(p){o=p;j.$lineIterator(n,k).forEach(l)}}};this.$assembleRegExp=function(i,m){if(i.needle instanceof RegExp){return i.re=i.needle}var l=i.needle;if(!i.needle){return i.re=false}if(!i.regExp){l=g.escapeRegExp(l)}if(i.wholeWord){l="\\b"+l+"\\b"}var h=i.caseSensitive?"g":"gi";i.$isMultiLine=!m&&/[\n\r]/.test(l);if(i.$isMultiLine){return i.re=this.$assembleMultilineRegExp(l,h)}try{var j=new RegExp(l,h)}catch(k){j=false}return i.re=j};this.$assembleMultilineRegExp=function(n,h){var m=n.replace(/\r\n|\r|\n/g,"$\n^").split("\n");var k=[];for(var j=0;j<m.length;j++){try{k.push(new RegExp(m[j],h))}catch(l){return false}}if(m[0]==""){k.shift();k.offset=1}else{k.offset=0}return k};this.$lineIterator=function(m,p){var n=p.backwards==true;var i=p.skipCurrent!=false;var k=p.range;var h=p.start;if(!h){h=k?k[n?"end":"start"]:m.selection.getRange()}if(h.start){h=h[i!=n?"end":"start"]}var j=k?k.start.row:0;var o=k?k.end.row:m.getLength()-1;var l=n?function(s){var r=h.row;var q=m.getLine(r).substring(0,h.column);if(s(q,r)){return}for(r--;r>=j;r--){if(s(m.getLine(r),r)){return}}if(p.wrap==false){return}for(r=o,j=h.row;r>=j;r--){if(s(m.getLine(r),r)){return}}}:function(s){var r=h.row;var q=m.getLine(r).substr(h.column);if(s(q,r,h.column)){return}for(r=r+1;r<=o;r++){if(s(m.getLine(r),r)){return}}if(p.wrap==false){return}for(r=j,o=h.row;r<=o;r++){if(s(m.getLine(r),r)){return}}};return{forEach:l}}}).call(b.prototype);a.Search=b});