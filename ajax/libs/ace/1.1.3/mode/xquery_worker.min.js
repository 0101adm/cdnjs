define(function(e,f,c){var g=e("../lib/oop");var a=e("../worker/mirror").Mirror;var h=e("./xquery/JSONParseTreeHandler").JSONParseTreeHandler;var i=e("./xquery/XQueryParser").XQueryParser;var d=e("./xquery/visitors/SemanticHighlighter").SemanticHighlighter;var b=f.XQueryWorker=function(j){a.call(this,j);this.setTimeout(200)};g.inherits(b,a);(function(){this.onUpdate=function(){this.sender.emit("start");var r=this.doc.getValue();var m=new h(r);var k=new i(r,m);try{k.parse_XQuery();this.sender.emit("ok");var j=m.getParseTree();var q=new d(j,r);var p=q.getTokens();this.sender.emit("highlight",{tokens:p,lines:q.lines})}catch(o){if(o instanceof k.ParseException){var n=r.substring(0,o.getBegin());var t=n.split("\n").length;var l=o.getBegin()-n.lastIndexOf("\n");var s=k.getErrorMessage(o);this.sender.emit("error",{row:t-1,column:l,text:s,type:"error"})}else{throw o}}}}).call(b.prototype)});