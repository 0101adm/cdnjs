define(function(f,h,c){var i=f("../lib/oop");var g=f("./text").Mode;var j=f("../tokenizer").Tokenizer;var b=f("./lua_highlight_rules").LuaHighlightRules;var d=f("./folding/lua").FoldMode;var e=f("../range").Range;var a=f("../worker/worker_client").WorkerClient;var k=function(){this.HighlightRules=b;this.foldingRules=new d()};i.inherits(k,g);(function(){this.lineCommentStart="--";this.blockComment={start:"--[",end:"]--"};var n={"function":1,then:1,"do":1,"else":1,elseif:1,repeat:1,end:-1,until:-1};var m=["else","elseif","end","until"];function l(q){var r=0;for(var p=0;p<q.length;p++){var o=q[p];if(o.type=="keyword"){if(o.value in n){r+=n[o.value]}}else{if(o.type=="paren.lparen"){r++}else{if(o.type=="paren.rparen"){r--}}}}if(r<0){return -1}else{if(r>0){return 1}else{return 0}}}this.getNextLineIndent=function(s,p,q){var o=this.$getIndent(p);var u=0;var r=this.getTokenizer().getLineTokens(p,s);var t=r.tokens;if(s=="start"){u=l(t)}if(u>0){return o+q}else{if(u<0&&o.substr(o.length-q.length)==q){if(!this.checkOutdent(s,p,"\n")){return o.substr(0,o.length-q.length)}}}return o};this.checkOutdent=function(q,o,p){if(p!="\n"&&p!="\r"&&p!="\r\n"){return false}if(o.match(/^\s*[\)\}\]]$/)){return true}var r=this.getTokenizer().getLineTokens(o.trim(),q).tokens;if(!r||!r.length){return false}return(r[0].type=="keyword"&&m.indexOf(r[0].value)!=-1)};this.autoOutdent=function(p,s,w){var t=s.getLine(w-1);var r=this.$getIndent(t).length;var o=this.getTokenizer().getLineTokens(t,"start").tokens;var q=s.getTabString().length;var v=r+q*l(o);var u=this.$getIndent(s.getLine(w)).length;if(u<v){return}s.outdentRows(new e(w,0,w+2,0))};this.createWorker=function(o){var p=new a(["ace"],"ace/mode/lua_worker","Worker");p.attachToDocument(o.getDocument());p.on("error",function(q){o.setAnnotations([q.data])});p.on("ok",function(q){o.clearAnnotations()});return p};this.$id="ace/mode/lua"}).call(k.prototype);h.Mode=k});