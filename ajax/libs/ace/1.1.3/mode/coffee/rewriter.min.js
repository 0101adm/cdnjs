define(function(l,x,b){var d,w,g,a,t,k,i,r,u,j,f,o,s,q,h,m,c,v,n,e=[].indexOf||function(A){for(var z=0,y=this.length;z<y;z++){if(z in this&&this[z]===A){return z}}return -1},p=[].slice;q=function(y,A){var z;z=[y,A];z.generated=true;return z};x.Rewriter=(function(){function y(){}y.prototype.rewrite=function(z){this.tokens=z;this.removeLeadingNewlines();this.closeOpenCalls();this.closeOpenIndexes();this.normalizeLines();this.tagPostfixConditionals();this.addImplicitBracesAndParens();this.addLocationDataToGeneratedTokens();return this.tokens};y.prototype.scanTokens=function(C){var A,z,B;B=this.tokens;A=0;while(z=B[A]){A+=C.call(this,z,A,B)}return true};y.prototype.detectEnd=function(B,G,E){var D,A,F,C,z;F=this.tokens;D=0;while(A=F[B]){if(D===0&&G.call(this,A,B)){return E.call(this,A,B)}if(!A||D<0){return E.call(this,A,B-1)}if(C=A[0],e.call(t,C)>=0){D+=1}else{if(z=A[0],e.call(a,z)>=0){D-=1}}B+=1}return B-1};y.prototype.removeLeadingNewlines=function(){var B,z,D,A,C;C=this.tokens;for(B=D=0,A=C.length;D<A;B=++D){z=C[B][0];if(z!=="TERMINATOR"){break}}if(B){return this.tokens.splice(0,B)}};y.prototype.closeOpenCalls=function(){var z,A;A=function(C,B){var D;return((D=C[0])===")"||D==="CALL_END")||C[0]==="OUTDENT"&&this.tag(B-1)===")"};z=function(C,B){return this.tokens[C[0]==="OUTDENT"?B-1:B][0]="CALL_END"};return this.scanTokens(function(C,B){if(C[0]==="CALL_START"){this.detectEnd(B+1,A,z)}return 1})};y.prototype.closeOpenIndexes=function(){var z,A;A=function(C,B){var D;return(D=C[0])==="]"||D==="INDEX_END"};z=function(C,B){return C[0]="INDEX_END"};return this.scanTokens(function(C,B){if(C[0]==="INDEX_START"){this.detectEnd(B+1,A,z)}return 1})};y.prototype.matchTags=function(){var F,B,A,E,D,C,z;B=arguments[0],E=2<=arguments.length?p.call(arguments,1):[];F=0;for(A=D=0,C=E.length;0<=C?D<C:D>C;A=0<=C?++D:--D){while(this.tag(B+A+F)==="HERECOMMENT"){F+=2}if(E[A]==null){continue}if(typeof E[A]==="string"){E[A]=[E[A]]}if(z=this.tag(B+A+F),e.call(E[A],z)<0){return false}}return true};y.prototype.looksObjectish=function(z){return this.matchTags(z,"@",null,":")||this.matchTags(z,null,":")};y.prototype.findTagsBackwards=function(F,G){var H,E,D,C,B,A,z;H=[];while(F>=0&&(H.length||(C=this.tag(F),e.call(G,C)<0)&&((B=this.tag(F),e.call(t,B)<0)||this.tokens[F].generated)&&(A=this.tag(F),e.call(f,A)<0))){if(E=this.tag(F),e.call(a,E)>=0){H.push(this.tag(F))}if((D=this.tag(F),e.call(t,D)>=0)&&H.length){H.pop()}F-=1}return z=this.tag(F),e.call(G,z)>=0};y.prototype.addImplicitBracesAndParens=function(){var z;z=[];return this.scanTokens(function(L,Z,T){var V,K,C,Q,aa,Y,ab,ac,M,I,ad,N,S,U,X,E,W,H,R,P,J,ae,O,G,F,D,B,A;ae=L[0];ad=(N=Z>0?T[Z-1]:[])[0];M=(Z<T.length-1?T[Z+1]:[])[0];W=function(){return z[z.length-1]};H=Z;Q=function(af){return Z-H+af};aa=function(){var ag,af;return(ag=W())!=null?(af=ag[2])!=null?af.ours:void 0:void 0};Y=function(){var af;return aa()&&((af=W())!=null?af[0]:void 0)==="("};ac=function(){var af;return aa()&&((af=W())!=null?af[0]:void 0)==="{"};ab=function(){var af;return aa&&((af=W())!=null?af[0]:void 0)==="CONTROL"};R=function(ag){var af;af=ag!=null?ag:Z;z.push(["(",af,{ours:true}]);T.splice(af,0,q("CALL_START","("));if(ag==null){return Z+=1}};K=function(){z.pop();T.splice(Z,0,q("CALL_END",")"));return Z+=1};V=function(){while(Y()){K()}};P=function(ag,ah){var af;if(ah==null){ah=true}af=ag!=null?ag:Z;z.push(["{",af,{sameLine:true,startsLine:ah,ours:true}]);T.splice(af,0,q("{",q(new String("{"))));if(ag==null){return Z+=1}};C=function(af){af=af!=null?af:Z;z.pop();T.splice(af,0,q("}","}"));return Z+=1};if(Y()&&(ae==="IF"||ae==="TRY"||ae==="FINALLY"||ae==="CATCH"||ae==="CLASS"||ae==="SWITCH")){z.push(["CONTROL",Z,{ours:true}]);return Q(1)}if(ae==="INDENT"&&aa()){if(ad!=="=>"&&ad!=="->"&&ad!=="["&&ad!=="("&&ad!==","&&ad!=="{"&&ad!=="TRY"&&ad!=="ELSE"&&ad!=="="){while(Y()){K()}}if(ab()){z.pop()}z.push([ae,Z]);return Q(1)}if(e.call(t,ae)>=0){z.push([ae,Z]);return Q(1)}if(e.call(a,ae)>=0){while(aa()){if(Y()){K()}else{if(ac()){C()}else{z.pop()}}}z.pop()}if((e.call(r,ae)>=0&&L.spaced&&!L.stringEnd||ae==="?"&&Z>0&&!T[Z-1].spaced)&&(e.call(k,M)>=0||e.call(u,M)>=0&&!((O=T[Z+1])!=null?O.spaced:void 0)&&!((G=T[Z+1])!=null?G.newLine:void 0))){if(ae==="?"){ae=L[0]="FUNC_EXIST"}R(Z+1);return Q(2)}if(e.call(r,ae)>=0&&this.matchTags(Z+1,"INDENT",null,":")&&!this.findTagsBackwards(Z,["CLASS","EXTENDS","IF","CATCH","SWITCH","LEADING_WHEN","FOR","WHILE","UNTIL"])){R(Z+1);z.push(["INDENT",Z+2]);return Q(3)}if(ae===":"){if(this.tag(Z-2)==="@"){S=Z-2}else{S=Z-1}while(this.tag(S-2)==="HERECOMMENT"){S-=2}J=S===0||(F=this.tag(S-1),e.call(f,F)>=0)||T[S-1].newLine;if(W()){D=W(),E=D[0],X=D[1];if((E==="{"||E==="INDENT"&&this.tag(X-1)==="{")&&(J||this.tag(S-1)===","||this.tag(S-1)==="{")){return Q(1)}}P(S,!!J);return Q(2)}if(Y()&&e.call(w,ae)>=0){if(ad==="OUTDENT"){K();return Q(1)}if(N.newLine){V();return Q(1)}}if(ac()&&e.call(f,ae)>=0){W()[2].sameLine=false}if(e.call(i,ae)>=0){while(aa()){B=W(),E=B[0],X=B[1],(A=B[2],U=A.sameLine,J=A.startsLine);if(Y()&&ad!==","){K()}else{if(ac()&&U&&!J){C()}else{if(ac()&&ae==="TERMINATOR"&&ad!==","&&!(J&&this.looksObjectish(Z+1))){C()}else{break}}}}}if(ae===","&&!this.looksObjectish(Z+1)&&ac()&&(M!=="TERMINATOR"||!this.looksObjectish(Z+2))){I=M==="OUTDENT"?1:0;while(ac()){C(Z+I)}}return Q(1)})};y.prototype.addLocationDataToGeneratedTokens=function(){return this.scanTokens(function(B,E,G){var A,H,z,F,D,C;if(B[2]){return 1}if(!(B.generated||B.explicit)){return 1}if(B[0]==="{"&&(z=(D=G[E+1])!=null?D[2]:void 0)){H=z.first_line,A=z.first_column}else{if(F=(C=G[E-1])!=null?C[2]:void 0){H=F.last_line,A=F.last_column}else{H=A=0}}B[2]={first_line:H,first_column:A,last_line:H,last_column:A};return 1})};y.prototype.normalizeLines=function(){var A,D,z,B,C;C=z=B=null;D=function(G,F){var H,E,J,I;return G[1]!==";"&&(H=G[0],e.call(o,H)>=0)&&!(G[0]==="TERMINATOR"&&(E=this.tag(F+1),e.call(g,E)>=0))&&!(G[0]==="ELSE"&&C!=="THEN")&&!(((J=G[0])==="CATCH"||J==="FINALLY")&&(C==="->"||C==="=>"))||(I=G[0],e.call(w,I)>=0)&&this.tokens[F-1].newLine};A=function(F,E){return this.tokens.splice((this.tag(E-1)===","?E-1:E),0,B)};return this.scanTokens(function(F,K,L){var I,M,H,J,G,E;M=F[0];if(M==="TERMINATOR"){if(this.tag(K+1)==="ELSE"&&this.tag(K-1)!=="OUTDENT"){L.splice.apply(L,[K,1].concat(p.call(this.indentation())));return 1}if(J=this.tag(K+1),e.call(g,J)>=0){L.splice(K,1);return 0}}if(M==="CATCH"){for(I=H=1;H<=2;I=++H){if(!((G=this.tag(K+I))==="OUTDENT"||G==="TERMINATOR"||G==="FINALLY")){continue}L.splice.apply(L,[K+I,0].concat(p.call(this.indentation())));return 2+I}}if(e.call(s,M)>=0&&this.tag(K+1)!=="INDENT"&&!(M==="ELSE"&&this.tag(K+1)==="IF")){C=M;E=this.indentation(true),z=E[0],B=E[1];if(C==="THEN"){z.fromThen=true}L.splice(K+1,0,z);this.detectEnd(K+2,D,A);if(M==="THEN"){L.splice(K,1)}return 1}return 1})};y.prototype.tagPostfixConditionals=function(){var A,B,z;z=null;B=function(F,E){var D,C;C=F[0];D=this.tokens[E-1][0];return C==="TERMINATOR"||(C==="INDENT"&&e.call(s,D)<0)};A=function(D,C){if(D[0]!=="INDENT"||(D.generated&&!D.fromThen)){return z[0]="POST_"+z[0]}};return this.scanTokens(function(D,C){if(D[0]!=="IF"){return 1}z=D;this.detectEnd(C+1,B,A);return 1})};y.prototype.indentation=function(A){var z,B;if(A==null){A=false}z=["INDENT",2];B=["OUTDENT",2];if(A){z.generated=B.generated=true}if(!A){z.explicit=B.explicit=true}return[z,B]};y.prototype.generate=q;y.prototype.tag=function(z){var A;return(A=this.tokens[z])!=null?A[0]:void 0};return y})();d=[["(",")"],["[","]"],["{","}"],["INDENT","OUTDENT"],["CALL_START","CALL_END"],["PARAM_START","PARAM_END"],["INDEX_START","INDEX_END"]];x.INVERSES=j={};t=[];a=[];for(c=0,v=d.length;c<v;c++){n=d[c],h=n[0],m=n[1];t.push(j[m]=h);a.push(j[h]=m)}g=["CATCH","THEN","ELSE","FINALLY"].concat(a);r=["IDENTIFIER","SUPER",")","CALL_END","]","INDEX_END","@","THIS"];k=["IDENTIFIER","NUMBER","STRING","JS","REGEX","NEW","PARAM_START","CLASS","IF","TRY","SWITCH","THIS","BOOL","NULL","UNDEFINED","UNARY","SUPER","THROW","@","->","=>","[","(","{","--","++"];u=["+","-"];i=["POST_IF","FOR","WHILE","UNTIL","WHEN","BY","LOOP","TERMINATOR"];s=["ELSE","->","=>","TRY","FINALLY","THEN"];o=["TERMINATOR","CATCH","FINALLY","ELSE","OUTDENT","LEADING_WHEN"];f=["TERMINATOR","INDENT","OUTDENT"];w=[".","?.","::","?::"]});