define(function(f,i,d){var k=f("../../lib/oop");var h=f("../behaviour").Behaviour;var l=f("../../token_iterator").TokenIterator;var c=f("../../lib/lang");var j=["text","paren.rparen","punctuation.operator"];var e=["text","paren.rparen","punctuation.operator","comment"];var a;var g={};var b=function(n){var o=-1;if(n.multiSelect){o=n.selection.id;if(g.rangeCount!=n.multiSelect.rangeCount){g={rangeCount:n.multiSelect.rangeCount}}}if(g[o]){return a=g[o]}a=g[o]={autoInsertedBrackets:0,autoInsertedRow:-1,autoInsertedLineEnd:"",maybeInsertedBrackets:0,maybeInsertedRow:-1,maybeInsertedLineStart:"",maybeInsertedLineEnd:""}};var m=function(){this.add("braces","insertion",function(o,r,u,x,z){var A=u.getCursorPosition();var B=x.doc.getLine(A.row);if(z=="{"){b(u);var y=u.getSelectionRange();var s=x.doc.getTextRange(y);if(s!==""&&s!=="{"&&u.getWrapBehavioursEnabled()){return{text:"{"+s+"}",selection:false}}else{if(m.isSaneInsertion(u,x)){if(/[\]\}\)]/.test(B[A.column])||u.inMultiSelectMode){m.recordAutoInsert(u,x,"}");return{text:"{}",selection:[1,1]}}else{m.recordMaybeInsert(u,x,"{");return{text:"{",selection:[1,1]}}}}}else{if(z=="}"){b(u);var v=B.substring(A.column,A.column+1);if(v=="}"){var n=x.$findOpeningBracket("}",{column:A.column+1,row:A.row});if(n!==null&&m.isAutoInsertedClosing(A,B,z)){m.popAutoInsertedClosing();return{text:"",selection:[1,1]}}}}else{if(z=="\n"||z=="\r\n"){b(u);var q="";if(m.isMaybeInsertedClosing(A,B)){q=c.stringRepeat("}",a.maybeInsertedBrackets);m.clearMaybeInsertedClosing()}var v=B.substring(A.column,A.column+1);if(v==="}"){var w=x.findMatchingBracket({row:A.row,column:A.column+1},"}");if(!w){return null}var t=this.$getIndent(x.getLine(w.row))}else{if(q){var t=this.$getIndent(B)}else{m.clearMaybeInsertedClosing();return}}var p=t+x.getTabString();return{text:"\n"+p+"\n"+t+q,selection:[1,p.length,1,p.length]}}else{m.clearMaybeInsertedClosing()}}}});this.add("braces","deletion",function(s,r,q,t,o){var p=t.doc.getTextRange(o);if(!o.isMultiLine()&&p=="{"){b(q);var n=t.doc.getLine(o.start.row);var u=n.substring(o.end.column,o.end.column+1);if(u=="}"){o.end.column++;return o}else{a.maybeInsertedBrackets--}}});this.add("parens","insertion",function(o,p,r,t,v){if(v=="("){b(r);var u=r.getSelectionRange();var q=t.doc.getTextRange(u);if(q!==""&&r.getWrapBehavioursEnabled()){return{text:"("+q+")",selection:false}}else{if(m.isSaneInsertion(r,t)){m.recordAutoInsert(r,t,")");return{text:"()",selection:[1,1]}}}}else{if(v==")"){b(r);var w=r.getCursorPosition();var x=t.doc.getLine(w.row);var s=x.substring(w.column,w.column+1);if(s==")"){var n=t.$findOpeningBracket(")",{column:w.column+1,row:w.row});if(n!==null&&m.isAutoInsertedClosing(w,x,v)){m.popAutoInsertedClosing();return{text:"",selection:[1,1]}}}}}});this.add("parens","deletion",function(s,r,q,t,o){var p=t.doc.getTextRange(o);if(!o.isMultiLine()&&p=="("){b(q);var n=t.doc.getLine(o.start.row);var u=n.substring(o.start.column+1,o.start.column+2);if(u==")"){o.end.column++;return o}}});this.add("brackets","insertion",function(o,p,r,t,v){if(v=="["){b(r);var u=r.getSelectionRange();var q=t.doc.getTextRange(u);if(q!==""&&r.getWrapBehavioursEnabled()){return{text:"["+q+"]",selection:false}}else{if(m.isSaneInsertion(r,t)){m.recordAutoInsert(r,t,"]");return{text:"[]",selection:[1,1]}}}}else{if(v=="]"){b(r);var w=r.getCursorPosition();var x=t.doc.getLine(w.row);var s=x.substring(w.column,w.column+1);if(s=="]"){var n=t.$findOpeningBracket("]",{column:w.column+1,row:w.row});if(n!==null&&m.isAutoInsertedClosing(w,x,v)){m.popAutoInsertedClosing();return{text:"",selection:[1,1]}}}}}});this.add("brackets","deletion",function(s,r,q,t,o){var p=t.doc.getTextRange(o);if(!o.isMultiLine()&&p=="["){b(q);var n=t.doc.getLine(o.start.row);var u=n.substring(o.start.column+1,o.start.column+2);if(u=="]"){o.end.column++;return o}}});this.add("string_dquotes","insertion",function(o,r,u,y,C){if(C=='"'||C=="'"){b(u);var n=C;var A=u.getSelectionRange();var s=y.doc.getTextRange(A);if(s!==""&&s!=="'"&&s!='"'&&u.getWrapBehavioursEnabled()){return{text:n+s+n,selection:false}}else{var B=u.getCursorPosition();var E=y.doc.getLine(B.row);var D=E.substring(B.column-1,B.column);if(D=="\\"){return null}var w=y.getTokens(A.start.row);var p=0,q;var t=-1;for(var z=0;z<w.length;z++){q=w[z];if(q.type=="string"){t=-1}else{if(t<0){t=q.value.indexOf(n)}}if((q.value.length+p)>A.start.column){break}p+=w[z].value.length}if(!q||(t<0&&q.type!=="comment"&&(q.type!=="string"||((A.start.column!==q.value.length+p-1)&&q.value.lastIndexOf(n)===q.value.length-1)))){if(!m.isSaneInsertion(u,y)){return}return{text:n+n,selection:[1,1]}}else{if(q&&q.type==="string"){var v=E.substring(B.column,B.column+1);if(v==n){return{text:"",selection:[1,1]}}}}}}});this.add("string_dquotes","deletion",function(s,r,q,t,o){var p=t.doc.getTextRange(o);if(!o.isMultiLine()&&(p=='"'||p=="'")){b(q);var n=t.doc.getLine(o.start.row);var u=n.substring(o.start.column+1,o.start.column+2);if(u==p){o.end.column++;return o}}})};m.isSaneInsertion=function(p,q){var r=p.getCursorPosition();var o=new l(q,r.row,r.column);if(!this.$matchTokenType(o.getCurrentToken()||"text",j)){var n=new l(q,r.row,r.column+1);if(!this.$matchTokenType(n.getCurrentToken()||"text",j)){return false}}o.stepForward();return o.getCurrentTokenRow()!==r.row||this.$matchTokenType(o.getCurrentToken()||"text",e)};m.$matchTokenType=function(o,n){return n.indexOf(o.type||o)>-1};m.recordAutoInsert=function(o,p,r){var q=o.getCursorPosition();var n=p.doc.getLine(q.row);if(!this.isAutoInsertedClosing(q,n,a.autoInsertedLineEnd[0])){a.autoInsertedBrackets=0}a.autoInsertedRow=q.row;a.autoInsertedLineEnd=r+n.substr(q.column);a.autoInsertedBrackets++};m.recordMaybeInsert=function(o,p,r){var q=o.getCursorPosition();var n=p.doc.getLine(q.row);if(!this.isMaybeInsertedClosing(q,n)){a.maybeInsertedBrackets=0}a.maybeInsertedRow=q.row;a.maybeInsertedLineStart=n.substr(0,q.column)+r;a.maybeInsertedLineEnd=n.substr(q.column);a.maybeInsertedBrackets++};m.isAutoInsertedClosing=function(p,n,o){return a.autoInsertedBrackets>0&&p.row===a.autoInsertedRow&&o===a.autoInsertedLineEnd[0]&&n.substr(p.column)===a.autoInsertedLineEnd};m.isMaybeInsertedClosing=function(o,n){return a.maybeInsertedBrackets>0&&o.row===a.maybeInsertedRow&&n.substr(o.column)===a.maybeInsertedLineEnd&&n.substr(0,o.column)==a.maybeInsertedLineStart};m.popAutoInsertedClosing=function(){a.autoInsertedLineEnd=a.autoInsertedLineEnd.substr(1);a.autoInsertedBrackets--};m.clearMaybeInsertedClosing=function(){if(a){a.maybeInsertedBrackets=0;a.maybeInsertedRow=-1}};k.inherits(m,h);i.CstyleBehaviour=m});