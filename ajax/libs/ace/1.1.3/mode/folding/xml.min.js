define(function(e,f,c){var g=e("../../lib/oop");var b=e("../../lib/lang");var d=e("../../range").Range;var i=e("./fold_mode").FoldMode;var h=e("../../token_iterator").TokenIterator;var a=f.FoldMode=function(j){i.call(this);this.voidElements=j||{}};g.inherits(a,i);(function(){this.getFoldWidget=function(l,k,m){var j=this._getFirstTagInLine(l,m);if(j.closing){return k=="markbeginend"?"end":""}if(!j.tagName||this.voidElements[j.tagName.toLowerCase()]){return""}if(j.selfClosing){return""}if(j.value.indexOf("/"+j.tagName)!==-1){return""}return"start"};this._getFirstTagInLine=function(n,o){var m=n.getTokens(o);var l="";for(var k=0;k<m.length;k++){var j=m[k];if(j.type.lastIndexOf("meta.tag",0)===0){l+=j.value}else{l+=b.stringRepeat(" ",j.value.length)}}return this._parseTag(l)};this.tagRe=/^(\s*)(<?(\/?)([-_a-zA-Z0-9:!]*)\s*(\/?)>?)/;this._parseTag=function(j){var k=j.match(this.tagRe);var l=0;return{value:j,match:k?k[2]:"",closing:k?!!k[3]:false,selfClosing:k?!!k[5]||k[2]=="/>":false,tagName:k?k[4]:"",column:k[1]?l+k[1].length:l}};this._readTagForward=function(l){var k=l.getCurrentToken();if(!k){return null}var m="";var n;do{if(k.type.lastIndexOf("meta.tag",0)===0){if(!n){var n={row:l.getCurrentTokenRow(),column:l.getCurrentTokenColumn()}}m+=k.value;if(m.indexOf(">")!==-1){var j=this._parseTag(m);j.start=n;j.end={row:l.getCurrentTokenRow(),column:l.getCurrentTokenColumn()+k.value.length};l.stepForward();return j}}}while(k=l.stepForward());return null};this._readTagBackward=function(m){var l=m.getCurrentToken();if(!l){return null}var n="";var k;do{if(l.type.lastIndexOf("meta.tag",0)===0){if(!k){k={row:m.getCurrentTokenRow(),column:m.getCurrentTokenColumn()+l.value.length}}n=l.value+n;if(n.indexOf("<")!==-1){var j=this._parseTag(n);j.end=k;j.start={row:m.getCurrentTokenRow(),column:m.getCurrentTokenColumn()};m.stepBackward();return j}}}while(l=m.stepBackward());return null};this._pop=function(k,j){while(k.length){var l=k[k.length-1];if(!j||l.tagName==j.tagName){return k.pop()}else{if(this.voidElements[j.tagName]){return}else{if(this.voidElements[l.tagName]){k.pop();continue}else{return null}}}}};this.getFoldWidgetRange=function(o,m,r){var l=this._getFirstTagInLine(o,r);if(!l.match){return null}var p=l.closing||l.selfClosing;var q=[];var s;if(!p){var n=new h(o,r,l.column);var j={row:r,column:l.column+l.tagName.length+2};while(s=this._readTagForward(n)){if(s.selfClosing){if(!q.length){s.start.column+=s.tagName.length+2;s.end.column-=2;return d.fromPoints(s.start,s.end)}else{continue}}if(s.closing){this._pop(q,s);if(q.length==0){return d.fromPoints(j,s.start)}}else{q.push(s)}}}else{var n=new h(o,r,l.column+l.match.length);var k={row:r,column:l.column};while(s=this._readTagBackward(n)){if(s.selfClosing){if(!q.length){s.start.column+=s.tagName.length+2;s.end.column-=2;return d.fromPoints(s.start,s.end)}else{continue}}if(!s.closing){this._pop(q,s);if(q.length==0){s.start.column+=s.tagName.length+2;return d.fromPoints(s.start,k)}}else{q.push(s)}}}}}).call(a.prototype)});