define(function(b,a,c){var e=b("../../lib/oop");var h=b("./fold_mode").FoldMode;var g=b("../../range").Range;var d=b("../../token_iterator").TokenIterator;var f=a.FoldMode=function(){};e.inherits(f,h);(function(){this.foldingStartMarker=/\b(function|then|do|repeat)\b|{\s*$|(\[=*\[)/;this.foldingStopMarker=/\bend\b|^\s*}|\]=*\]/;this.getFoldWidget=function(o,n,p){var j=o.getLine(p);var i=this.foldingStartMarker.test(j);var m=this.foldingStopMarker.test(j);if(i&&!m){var k=j.match(this.foldingStartMarker);if(k[1]=="then"&&/\belseif\b/.test(j)){return}if(k[1]){if(o.getTokenAt(p,k.index+1).type==="keyword"){return"start"}}else{if(k[2]){var l=o.bgTokenizer.getState(p)||"";if(l[0]=="bracketedComment"||l[0]=="bracketedString"){return"start"}}else{return"start"}}}if(n!="markbeginend"||!m||i&&m){return""}var k=j.match(this.foldingStopMarker);if(k[0]==="end"){if(o.getTokenAt(p,k.index+1).type==="keyword"){return"end"}}else{if(k[0][0]==="]"){var l=o.bgTokenizer.getState(p-1)||"";if(l[0]=="bracketedComment"||l[0]=="bracketedString"){return"end"}}else{return"end"}}};this.getFoldWidgetRange=function(l,k,m){var i=l.doc.getLine(m);var j=this.foldingStartMarker.exec(i);if(j){if(j[1]){return this.luaBlock(l,m,j.index+1)}if(j[2]){return l.getCommentFoldRange(m,j.index+1)}return this.openingBracketBlock(l,"{",m,j.index)}var j=this.foldingStopMarker.exec(i);if(j){if(j[0]==="end"){if(l.getTokenAt(m,j.index+1).type==="keyword"){return this.luaBlock(l,m,j.index+1)}}if(j[0][0]==="]"){return l.getCommentFoldRange(m,j.index+1)}return this.closingBracketBlock(l,"}",m,j.index+j[0].length)}};this.luaBlock=function(p,t,n){var s=new d(p,t,n);var j={"function":1,"do":1,then:1,elseif:-1,end:-1,repeat:1,until:-1};var o=s.getCurrentToken();if(!o||o.type!="keyword"){return}var k=o.value;var q=[k];var l=j[k];if(!l){return}var m=l===-1?s.getCurrentTokenColumn():p.getLine(t).length;var r=t;s.step=l===-1?s.stepBackward:s.stepForward;while(o=s.step()){if(o.type!=="keyword"){continue}var i=l*j[o.value];if(i>0){q.unshift(o.value)}else{if(i<=0){q.shift();if(!q.length&&o.value!="elseif"){break}if(i===0){q.unshift(o.value)}}}}var t=s.getCurrentTokenRow();if(l===-1){return new g(t,p.getLine(t).length,r,m)}else{return new g(r,m,t,s.getCurrentTokenColumn())}}}).call(f.prototype)});