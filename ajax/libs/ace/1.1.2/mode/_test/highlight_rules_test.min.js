var fs=require("fs");if(!fs.existsSync){fs.existsSync=require("path").existsSync}require("amd-loader");var cwd=__dirname+"/";function generateTestData(){var a=Array(5).join("../")+"/demo/kitchen-sink/docs";var d=fs.readdirSync(cwd+a);var b=fs.readdirSync(cwd);var c=fs.readdirSync(cwd+"../").filter(function(e){return !/(_highlight_rules|behaviour|worker)\.js$/.test(e)&&/\.js$/.test(e)}).map(function(e){return e.replace(/\.js$/,"")});console.log("Docs:",d);console.log("Modes:",c);d.forEach(function(f){var h=f.toLowerCase().split(".");if(!h[1]){return}var n;if(c.indexOf(h[0])!=-1){n=h[0]}else{if(c.indexOf(h[1])!=-1){n=h[1]}else{n={txt:"text",cpp:"c_cpp"}[h[1]]}}var i="text_"+n+".txt";if(b.indexOf(i)==-1){i=a+"/"+f}var o=fs.readFileSync(cwd+i,"utf8");try{var l=require("../"+n).Mode}catch(k){console.warn("Can't load mode :"+n,h,k);return}var m=new l().getTokenizer();var g="start";var j=o.split(/\n|\r|\r\n/).map(function(e){var r=m.getLineTokens(e,g);var p=[];p.push(JSON.stringify(r.state));var q="";r.tokens.forEach(function(s){q+=s.value;p.push(JSON.stringify([s.type,s.value]))});if(q!=e){p.push(JSON.stringify(e))}g=r.state;return p.join(",\n  ")});jsonStr="[[\n   "+j.join("\n],[\n   ")+"\n]]";fs.writeFileSync(cwd+"tokens_"+n+".json",jsonStr,"utf8")})}function test(a){var c=fs.readdirSync(cwd).map(function(d){return(d.match(/tokens_(.*).json/)||{})[1]}).filter(function(d){return !!d});for(var b=Math.max(0,a||0);b<c.length;b++){testMode(c[b],b)}console.log("\u001b[32mall ok\u001b[0m")}function testMode(g,a){console.log(padNumber(a+1,3)+") testing: \u001b[33m"+g+"\u001b[0m");var f=fs.readFileSync(cwd+"tokens_"+g+".json","utf8");var e=JSON.parse(f);var c=require("../"+g).Mode;var b=new c().getTokenizer();var d="start";e.forEach(function(n){n.values=[];n.types=[];n.state=n.shift();var h=null;if(typeof n[n.length-1]=="string"){h=n.pop()}n.forEach(function(o){n.types.push(o[0]);n.values.push(o[1])});if(typeof h!="string"){h=n.values.join("")}var l=b.getLineTokens(h,d);var i=l.tokens.map(function(o){return o.value});var j=l.tokens.map(function(o){return o.type});var m=true;var k=testEqual([JSON.stringify(n.state),JSON.stringify(l.state),n.types,j,n.values,i]);if(k){console.log(h);throw"error"}d=l.state})}function testEqual(b){var c;if(b[0]+""!==b[1]+""){console.log(b[0],b[1]);c=1}if(b[2]+""!==b[3]+""||b[4]+""!==b[5]+""){arrayDiff(b[2],b[3]);arrayDiff(b[4],b[5]);c=1}return c}function arrayDiff(c,a){var b=Math.max(c.length,a.length);var d=[];for(var e=0;e<b;e++){d.push("\n",padNumber(e+1,3),") ");if(c[e]!==a[e]){d.push("\u001b[31m",c[e],"\u001b[0m != \u001b[32m",a[e],"\u001b[0m")}else{d.push(c[e])}}console.log(d.join(""))}function padNumber(a,b){return("      "+a).slice(-b)}var arg=process.argv[2];if(!arg){test()}else{if(/--?g(en)?/.test(arg)){generateTestData(process.argv.splice(3))}else{if(/\d+/.test(arg)){test(parseInt(process.argv[2],10)||0)}else{testMode(arg,-1)}}};