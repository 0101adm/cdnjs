define(function(f,h,d){var j=f("../tokenizer").Tokenizer;var a=f("./text_highlight_rules").TextHighlightRules;var g=f("./behaviour").Behaviour;var b=f("../unicode");var c=f("../lib/lang");var i=f("../token_iterator").TokenIterator;var e=f("../range").Range;var k=function(){this.HighlightRules=a;this.$behaviour=new g()};(function(){this.tokenRe=new RegExp("^["+b.packages.L+b.packages.Mn+b.packages.Mc+b.packages.Nd+b.packages.Pc+"\\$_]+","g");this.nonTokenRe=new RegExp("^(?:[^"+b.packages.L+b.packages.Mn+b.packages.Mc+b.packages.Nd+b.packages.Pc+"\\$_]|s])+","g");this.getTokenizer=function(){if(!this.$tokenizer){this.$highlightRules=new this.HighlightRules();this.$tokenizer=new j(this.$highlightRules.getRules())}return this.$tokenizer};this.lineCommentStart="";this.blockComment="";this.toggleCommentLines=function(q,m,l,z){var F=m.doc;var p=true;var B=true;var o=Infinity;var w=m.getTabSize();var E=false;if(!this.lineCommentStart){if(!this.blockComment){return false}var C=this.blockComment.start;var t=this.blockComment.end;var x=new RegExp("^(\\s*)(?:"+c.escapeRegExp(C)+")");var y=new RegExp("(?:"+c.escapeRegExp(t)+")\\s*$");var n=function(G,H){if(u(G,H)){return}if(!p||/\S/.test(G)){F.insertInLine({row:H,column:G.length},t);F.insertInLine({row:H,column:o},C)}};var r=function(H,I){var G;if(G=H.match(y)){F.removeInLine(I,H.length-G[0].length,H.length)}if(G=H.match(x)){F.removeInLine(I,G[1].length,G[0].length)}};var u=function(G,J){if(x.test(G)){return true}var I=m.getTokens(J);for(var H=0;H<I.length;H++){if(I[H].type==="comment"){return true}}}}else{if(Array.isArray(this.lineCommentStart)){var x=this.lineCommentStart.map(c.escapeRegExp).join("|");var C=this.lineCommentStart[0]}else{var x=c.escapeRegExp(this.lineCommentStart);var C=this.lineCommentStart}x=new RegExp("^(\\s*)(?:"+x+") ?");E=m.getUseSoftTabs();var r=function(I,J){var G=I.match(x);if(!G){return}var K=G[1].length,H=G[0].length;if(!D(I,K,H)&&G[0][H-1]==" "){H--}F.removeInLine(J,K,H)};var s=C+" ";var n=function(G,H){if(!p||/\S/.test(G)){if(D(G,o,o)){F.insertInLine({row:H,column:o},s)}else{F.insertInLine({row:H,column:o},C)}}};var u=function(G,H){return x.test(G)};var D=function(G,I,J){var H=0;while(I--&&G.charAt(I)==" "){H++}if(H%w!=0){return false}var H=0;while(G.charAt(J++)==" "){H++}if(w>2){return H%w!=w-1}else{return H%w==0}return true}}function A(G){for(var H=l;H<=z;H++){G(F.getLine(H),H)}}var v=Infinity;A(function(H,I){var G=H.search(/\S/);if(G!==-1){if(G<o){o=G}if(B&&!u(H,I)){B=false}}else{if(v>H.length){v=H.length}}});if(o==Infinity){o=v;p=false;B=false}if(E&&o%w!=0){o=Math.floor(o/w)*w}A(B?r:n)};this.toggleBlockComment=function(l,w,s,z){var t=this.blockComment;if(!t){return}if(!t.start&&t[0]){t=t[0]}var r=new i(w,z.row,z.column);var o=r.getCurrentToken();var m=w.selection;var v=w.selection.toOrientedRange();var y,u;if(o&&/comment/.test(o.type)){var x,p;while(o&&/comment/.test(o.type)){var q=o.value.indexOf(t.start);if(q!=-1){var A=r.getCurrentTokenRow();var n=r.getCurrentTokenColumn()+q;x=new e(A,n,A,n+t.start.length);break}o=r.stepBackward()}var r=new i(w,z.row,z.column);var o=r.getCurrentToken();while(o&&/comment/.test(o.type)){var q=o.value.indexOf(t.end);if(q!=-1){var A=r.getCurrentTokenRow();var n=r.getCurrentTokenColumn()+q;p=new e(A,n,A,n+t.end.length);break}o=r.stepForward()}if(p){w.remove(p)}if(x){w.remove(x);y=x.start.row;u=-t.start.length}}else{u=t.start.length;y=s.start.row;w.insert(s.end,t.end);w.insert(s.start,t.start)}if(v.start.row==y){v.start.column+=u}if(v.end.row==y){v.end.column+=u}w.selection.fromOrientedRange(v)};this.getNextLineIndent=function(n,l,m){return this.$getIndent(l)};this.checkOutdent=function(n,l,m){return false};this.autoOutdent=function(l,m,n){};this.$getIndent=function(l){return l.match(/^\s*/)[0]};this.createWorker=function(l){return null};this.createModeDelegates=function(m){this.$embeds=[];this.$modes={};for(var n in m){if(m[n]){this.$embeds.push(n);this.$modes[n]=new m[n]()}}var l=["toggleCommentLines","getNextLineIndent","checkOutdent","autoOutdent","transformAction","getCompletions"];for(var n=0;n<l.length;n++){(function(p){var q=l[n];var o=p[q];p[l[n]]=function(){return this.$delegator(q,arguments,o)}}(this))}};this.$delegator=function(s,n,m){var q=n[0];if(typeof q!="string"){q=q[0]}for(var p=0;p<this.$embeds.length;p++){if(!this.$modes[this.$embeds[p]]){continue}var o=q.split(this.$embeds[p]);if(!o[0]&&o[1]){n[0]=o[1];var r=this.$modes[this.$embeds[p]];return r[s].apply(r,n)}}var l=m.apply(this,n);return m?l:undefined};this.transformAction=function(q,p,n,r,s){if(this.$behaviour){var o=this.$behaviour.getBehaviours();for(var m in o){if(o[m][p]){var l=o[m][p].apply(this,arguments);if(l){return l}}}}};this.getKeywords=function(o){if(!this.completionKeywords){var v=this.$tokenizer.rules;var p=[];for(var t in v){var s=v[t];for(var n=0,q=s.length;n<q;n++){if(typeof s[n].token==="string"){if(/keyword|support|storage/.test(s[n].token)){p.push(s[n].regex)}}else{if(typeof s[n].token==="object"){for(var u=0,m=s[n].token.length;u<m;u++){if(/keyword|support|storage/.test(s[n].token[u])){var t=s[n].regex.match(/\(.+?\)/g)[u];p.push(t.substr(1,t.length-2))}}}}}}this.completionKeywords=p}if(!o){return this.$keywordList}return p.concat(this.$keywordList||[])};this.$createKeywordList=function(){if(!this.$highlightRules){this.getTokenizer()}return this.$keywordList=this.$highlightRules.$keywordList||[]};this.getCompletions=function(n,o,p,m){var l=this.$keywordList||this.$createKeywordList();return l.map(function(q){return{name:q,value:q,score:0,meta:"keyword"}})};this.$id="ace/mode/text"}).call(k.prototype);h.Mode=k});