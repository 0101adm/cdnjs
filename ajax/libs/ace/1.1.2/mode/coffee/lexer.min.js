define(function(f,U,e){var O,t,p,z,P,C,q,g,M,c,n,T,s,ad,o,ae,w,b,y,V,d,R,E,Y,I,Z,Q,H,W,K,F,X,j,A,a,v,L,i,x,ac,B,k,aa,S,D,u,r,J,G,h,ab,N,m,l=[].indexOf||function(ah){for(var ag=0,af=this.length;ag<af;ag++){if(ag in this&&this[ag]===ah){return ag}}return -1};N=f("./rewriter"),v=N.Rewriter,b=N.INVERSES;m=f("./helpers"),S=m.count,h=m.starts,aa=m.compact,r=m.last,G=m.repeat,D=m.invertLiterate,J=m.locationDataToString,ab=m.throwSyntaxError;U.Lexer=I=(function(){function af(){}af.prototype.tokenize=function(aj,ai){var ak,ah,ag,al;if(ai==null){ai={}}this.literate=ai.literate;this.indent=0;this.baseIndent=0;this.indebt=0;this.outdebt=0;this.indents=[];this.ends=[];this.tokens=[];this.chunkLine=ai.line||0;this.chunkColumn=ai.column||0;aj=this.clean(aj);ah=0;while(this.chunk=aj.slice(ah)){ak=this.identifierToken()||this.commentToken()||this.whitespaceToken()||this.lineToken()||this.heredocToken()||this.stringToken()||this.numberToken()||this.regexToken()||this.jsToken()||this.literalToken();al=this.getLineAndColumnFromChunk(ak),this.chunkLine=al[0],this.chunkColumn=al[1];ah+=ak}this.closeIndentation();if(ag=this.ends.pop()){this.error("missing "+ag)}if(ai.rewrite===false){return this.tokens}return(new v).rewrite(this.tokens)};af.prototype.clean=function(ag){if(ag.charCodeAt(0)===O){ag=ag.slice(1)}ag=ag.replace(/\r/g,"").replace(ac,"");if(k.test(ag)){ag="\n"+ag;this.chunkLine--}if(this.literate){ag=D(ag)}return ag};af.prototype.identifierToken=function(){var ap,aq,ai,ah,ar,at,ao,ag,am,au,an,al,ak,aj;if(!(ao=ae.exec(this.chunk))){return 0}at=ao[0],ah=ao[1],ap=ao[2];ar=ah.length;ag=void 0;if(ah==="own"&&this.tag()==="FOR"){this.token("OWN",ah);return ah.length}ai=ap||(am=r(this.tokens))&&(((al=am[0])==="."||al==="?."||al==="::"||al==="?::")||!am.spaced&&am[0]==="@");au="IDENTIFIER";if(!ai&&(l.call(d,ah)>=0||l.call(q,ah)>=0)){au=ah.toUpperCase();if(au==="WHEN"&&(ak=this.tag(),l.call(R,ak)>=0)){au="LEADING_WHEN"}else{if(au==="FOR"){this.seenFor=true}else{if(au==="UNLESS"){au="IF"}else{if(l.call(B,au)>=0){au="UNARY"}else{if(l.call(A,au)>=0){if(au!=="INSTANCEOF"&&this.seenFor){au="FOR"+au;this.seenFor=false}else{au="RELATION";if(this.value()==="!"){ag=this.tokens.pop();ah="!"+ah}}}}}}}}if(l.call(V,ah)>=0){if(ai){au="IDENTIFIER";ah=new String(ah);ah.reserved=true}else{if(l.call(a,ah)>=0){this.error('reserved word "'+ah+'"')}}}if(!ai){if(l.call(P,ah)>=0){ah=C[ah]}au=(function(){switch(ah){case"!":return"UNARY";case"==":case"!=":return"COMPARE";case"&&":case"||":return"LOGIC";case"true":case"false":return"BOOL";case"break":case"continue":return"STATEMENT";default:return au}})()}an=this.token(au,ah,0,ar);if(ag){aj=[ag[2].first_line,ag[2].first_column],an[2].first_line=aj[0],an[2].first_column=aj[1]}if(ap){aq=at.lastIndexOf(":");this.token(":",":",aq,ap.length)}return at.length};af.prototype.numberToken=function(){var ak,ah,ag,ai,aj;if(!(ag=F.exec(this.chunk))){return 0}ai=ag[0];if(/^0[BOX]/.test(ai)){this.error("radix prefix '"+ai+"' must be lowercase")}else{if(/E/.test(ai)&&!/^0x/.test(ai)){this.error("exponential notation '"+ai+"' must be indicated with a lowercase 'e'")}else{if(/^0\d*[89]/.test(ai)){this.error("decimal literal '"+ai+"' must not be prefixed with '0'")}else{if(/^0\d+/.test(ai)){this.error("octal literal '"+ai+"' must be prefixed with '0o'")}}}}ah=ai.length;if(aj=/^0o([0-7]+)/.exec(ai)){ai="0x"+parseInt(aj[1],8).toString(16)}if(ak=/^0b([01]+)/.exec(ai)){ai="0x"+parseInt(ak[1],2).toString(16)}this.token("NUMBER",ai,0,ah);return ah};af.prototype.stringToken=function(){var ai,ag,ah,aj;switch(ag=this.chunk.charAt(0)){case"'":ah=i.exec(this.chunk)[0];break;case'"':ah=this.balancedString(this.chunk,'"')}if(!ah){return 0}aj=this.removeNewlines(ah.slice(1,-1));if(ag==='"'&&0<ah.indexOf("#{",1)){this.interpolateString(aj,{strOffset:1,lexedLength:ah.length})}else{this.token("STRING",ag+this.escapeLines(aj)+ag,0,ah.length)}if(ai=/^(?:\\.|[^\\])*\\(?:0[0-7]|[1-7])/.test(ah)){this.error("octal escape sequences "+ah+" are not allowed")}return ah.length};af.prototype.heredocToken=function(){var aj,ag,ai,ah;if(!(ai=n.exec(this.chunk))){return 0}ag=ai[0];ah=ag.charAt(0);aj=this.sanitizeHeredoc(ai[2],{quote:ah,indent:null});if(ah==='"'&&0<=aj.indexOf("#{")){this.interpolateString(aj,{heredoc:true,strOffset:3,lexedLength:ag.length})}else{this.token("STRING",this.makeString(aj,ah,true),0,ag.length)}return ag.length};af.prototype.commentToken=function(){var ai,ah,ag;if(!(ag=this.chunk.match(g))){return 0}ai=ag[0],ah=ag[1];if(ah){this.token("HERECOMMENT",this.sanitizeHeredoc(ah,{herecomment:true,indent:G(" ",this.indent)}),0,ai.length)}return ai.length};af.prototype.jsToken=function(){var ah,ag;if(!(this.chunk.charAt(0)==="`"&&(ah=y.exec(this.chunk)))){return 0}this.token("JS",(ag=ah[0]).slice(1,-1),0,ag.length);return ag.length};af.prototype.regexToken=function(){var ag,ak,ah,aj,ai,am,al;if(this.chunk.charAt(0)!=="/"){return 0}if(ah=ad.exec(this.chunk)){ak=this.heregexToken(ah);return ak}aj=r(this.tokens);if(aj&&(am=aj[0],l.call((aj.spaced?W:K),am)>=0)){return 0}if(!(ah=j.exec(this.chunk))){return 0}al=ah,ah=al[0],ai=al[1],ag=al[2];if(ai.slice(0,2)==="/*"){this.error("regular expressions cannot begin with `*`")}if(ai==="//"){ai="/(?:)/"}this.token("REGEX",""+ai+ag,0,ah.length);return ah.length};af.prototype.heregexToken=function(ap){var aq,aj,ag,ai,aw,an,av,ax,am,ar,au,ao,at,al,ak,ah;ai=ap[0],aq=ap[1],aj=ap[2];if(0>aq.indexOf("#{")){av=this.escapeLines(aq.replace(o,"$1$2").replace(/\//g,"\\/"),true);if(av.match(/^\*/)){this.error("regular expressions cannot begin with `*`")}this.token("REGEX","/"+(av||"(?:)")+"/"+aj,0,ai.length);return ai.length}this.token("IDENTIFIER","RegExp",0,0);this.token("CALL_START","(",0,0);ar=[];al=this.interpolateString(aq,{regex:true});for(ao=0,at=al.length;ao<at;ao++){am=al[ao];ax=am[0],au=am[1];if(ax==="TOKENS"){ar.push.apply(ar,au)}else{if(ax==="NEOSTRING"){if(!(au=au.replace(o,"$1$2"))){continue}au=au.replace(/\\/g,"\\\\");am[0]="STRING";am[1]=this.makeString(au,'"',true);ar.push(am)}else{this.error("Unexpected "+ax)}}an=r(this.tokens);aw=["+","+"];aw[2]=an[2];ar.push(aw)}ar.pop();if(((ak=ar[0])!=null?ak[0]:void 0)!=="STRING"){this.token("STRING",'""',0,0);this.token("+","+",0,0)}(ah=this.tokens).push.apply(ah,ar);if(aj){ag=ai.lastIndexOf(aj);this.token(",",",",ag,0);this.token("STRING",'"'+aj+'"',ag,aj.length)}this.token(")",")",ai.length-1,0);return ai.length};af.prototype.lineToken=function(){var ak,ag,ai,ah,aj;if(!(ai=H.exec(this.chunk))){return 0}ag=ai[0];this.seenFor=false;aj=ag.length-1-ag.lastIndexOf("\n");ah=this.unfinished();if(aj-this.indebt===this.indent){if(ah){this.suppressNewlines()}else{this.newlineToken(0)}return ag.length}if(aj>this.indent){if(ah){this.indebt=aj-this.indent;this.suppressNewlines();return ag.length}if(!this.tokens.length){this.baseIndent=this.indent=aj;return ag.length}ak=aj-this.indent+this.outdebt;this.token("INDENT",ak,ag.length-aj,aj);this.indents.push(ak);this.ends.push("OUTDENT");this.outdebt=this.indebt=0}else{if(aj<this.baseIndent){this.error("missing indentation",ag.length)}else{this.indebt=0;this.outdentToken(this.indent-aj,ah,ag.length)}}this.indent=aj;return ag.length};af.prototype.outdentToken=function(ak,ah,ai){var aj,ag;while(ak>0){ag=this.indents.length-1;if(this.indents[ag]===void 0){ak=0}else{if(this.indents[ag]===this.outdebt){ak-=this.outdebt;this.outdebt=0}else{if(this.indents[ag]<this.outdebt){this.outdebt-=this.indents[ag];ak-=this.indents[ag]}else{aj=this.indents.pop()+this.outdebt;ak-=aj;this.outdebt=0;this.pair("OUTDENT");this.token("OUTDENT",aj,0,ai)}}}}if(aj){this.outdebt-=ak}while(this.value()===";"){this.tokens.pop()}if(!(this.tag()==="TERMINATOR"||ah)){this.token("TERMINATOR","\n",ai,0)}return this};af.prototype.whitespaceToken=function(){var ah,ag,ai;if(!((ah=k.exec(this.chunk))||(ag=this.chunk.charAt(0)==="\n"))){return 0}ai=r(this.tokens);if(ai){ai[ah?"spaced":"newLine"]=true}if(ah){return ah[0].length}else{return 0}};af.prototype.newlineToken=function(ag){while(this.value()===";"){this.tokens.pop()}if(this.tag()!=="TERMINATOR"){this.token("TERMINATOR","\n",ag,0)}return this};af.prototype.suppressNewlines=function(){if(this.value()==="\\"){this.tokens.pop()}return this};af.prototype.literalToken=function(){var ah,ai,ag,ak,an,am,al,aj;if(ah=X.exec(this.chunk)){ak=ah[0];if(z.test(ak)){this.tagParameters()}}else{ak=this.chunk.charAt(0)}ag=ak;ai=r(this.tokens);if(ak==="="&&ai){if(!ai[1].reserved&&(an=ai[1],l.call(V,an)>=0)){this.error('reserved word "'+(this.value())+"\" can't be assigned")}if((am=ai[1])==="||"||am==="&&"){ai[0]="COMPOUND_ASSIGN";ai[1]+="=";return ak.length}}if(ak===";"){this.seenFor=false;ag="TERMINATOR"}else{if(l.call(Z,ak)>=0){ag="MATH"}else{if(l.call(M,ak)>=0){ag="COMPARE"}else{if(l.call(c,ak)>=0){ag="COMPOUND_ASSIGN"}else{if(l.call(B,ak)>=0){ag="UNARY"}else{if(l.call(L,ak)>=0){ag="SHIFT"}else{if(l.call(Y,ak)>=0||ak==="?"&&(ai!=null?ai.spaced:void 0)){ag="LOGIC"}else{if(ai&&!ai.spaced){if(ak==="("&&(al=ai[0],l.call(p,al)>=0)){if(ai[0]==="?"){ai[0]="FUNC_EXIST"}ag="CALL_START"}else{if(ak==="["&&(aj=ai[0],l.call(w,aj)>=0)){ag="INDEX_START";switch(ai[0]){case"?":ai[0]="INDEX_SOAK"}}}}}}}}}}}switch(ak){case"(":case"{":case"[":this.ends.push(b[ak]);break;case")":case"}":case"]":this.pair(ak)}this.token(ag,ak);return ak.length};af.prototype.sanitizeHeredoc=function(al,ai){var ak,aj,ag,ah,am;ag=ai.indent,aj=ai.herecomment;if(aj){if(T.test(al)){this.error('block comment cannot contain "*/", starting')}if(al.indexOf("\n")<0){return al}}else{while(ah=s.exec(al)){ak=ah[1];if(ag===null||(0<(am=ak.length)&&am<ag.length)){ag=ak}}}if(ag){al=al.replace(RegExp("\\n"+ag,"g"),"\n")}if(!aj){al=al.replace(/^\n/,"")}return al};af.prototype.tagParameters=function(){var ai,ag,ah,aj;if(this.tag()!==")"){return this}ag=[];aj=this.tokens;ai=aj.length;aj[--ai][0]="PARAM_END";while(ah=aj[--ai]){switch(ah[0]){case")":ag.push(ah);break;case"(":case"CALL_START":if(ag.length){ag.pop()}else{if(ah[0]==="("){ah[0]="PARAM_START";return this}else{return this}}}}return this};af.prototype.closeIndentation=function(){return this.outdentToken(this.indent)};af.prototype.balancedString=function(ao,aj){var an,al,ag,am,ai,ap,ak,ah;an=0;ap=[aj];for(al=ak=1,ah=ao.length;1<=ah?ak<ah:ak>ah;al=1<=ah?++ak:--ak){if(an){--an;continue}switch(ag=ao.charAt(al)){case"\\":++an;continue;case aj:ap.pop();if(!ap.length){return ao.slice(0,+al+1||9000000000)}aj=ap[ap.length-1];continue}if(aj==="}"&&(ag==='"'||ag==="'")){ap.push(aj=ag)}else{if(aj==="}"&&ag==="/"&&(am=ad.exec(ao.slice(al))||j.exec(ao.slice(al)))){an+=am[0].length-1}else{if(aj==="}"&&ag==="{"){ap.push(aj="}")}else{if(aj==='"'&&ai==="#"&&ag==="{"){ap.push(aj="}")}}}}ai=ag}return this.error("missing "+(ap.pop())+", starting")};af.prototype.interpolateString=function(aB,ao){var am,al,au,aC,aJ,av,aD,aI,ar,at,ay,aq,aH,aE,aG,ak,an,az,ax,aK,ap,aw,aA,ai,aF,aj,ah,ag;if(ao==null){ao={}}au=ao.heredoc,an=ao.regex,aH=ao.offsetInChunk,ax=ao.strOffset,ar=ao.lexedLength;aH=aH||0;ax=ax||0;ar=ar||aB.length;aw=[];aE=0;aC=-1;while(aI=aB.charAt(aC+=1)){if(aI==="\\"){aC+=1;continue}if(!(aI==="#"&&aB.charAt(aC+1)==="{"&&(al=this.balancedString(aB.slice(aC+1),"}")))){continue}if(aE<aC){aw.push(this.makeToken("NEOSTRING",aB.slice(aE,aC),ax+aE))}aJ=al.slice(1,-1);if(aJ.length){aj=this.getLineAndColumnFromChunk(ax+aC+1),at=aj[0],am=aj[1];aq=new af().tokenize(aJ,{line:at,column:am,rewrite:false});ak=aq.pop();if(((ah=aq[0])!=null?ah[0]:void 0)==="TERMINATOR"){ak=aq.shift()}if(aD=aq.length){if(aD>1){aq.unshift(this.makeToken("(","(",ax+aC+1,0));aq.push(this.makeToken(")",")",ax+aC+1+aJ.length,0))}aw.push(["TOKENS",aq])}}aC+=al.length;aE=aC+1}if((aC>aE&&aE<aB.length)){aw.push(this.makeToken("NEOSTRING",aB.slice(aE),ax+aE))}if(an){return aw}if(!aw.length){return this.token("STRING",'""',aH,ar)}if(aw[0][0]!=="NEOSTRING"){aw.unshift(this.makeToken("NEOSTRING","",aH))}if(av=aw.length>1){this.token("(","(",aH,0)}for(aC=ai=0,aF=aw.length;ai<aF;aC=++ai){ap=aw[aC];aK=ap[0],aA=ap[1];if(aC){if(aC){aG=this.token("+","+")}ay=aK==="TOKENS"?aA[0]:ap;aG[2]={first_line:ay[2].first_line,first_column:ay[2].first_column,last_line:ay[2].first_line,last_column:ay[2].first_column}}if(aK==="TOKENS"){(ag=this.tokens).push.apply(ag,aA)}else{if(aK==="NEOSTRING"){ap[0]="STRING";ap[1]=this.makeString(aA,'"',au);this.tokens.push(ap)}else{this.error("Unexpected "+aK)}}}if(av){az=this.makeToken(")",")",aH+ar,0);az.stringEnd=true;this.tokens.push(az)}return aw};af.prototype.pair=function(ag){var ai,ah;if(ag!==(ah=r(this.ends))){if("OUTDENT"!==ah){this.error("unmatched "+ag)}this.indent-=ai=r(this.indents);this.outdentToken(ai,true);return this.pair(ag)}return this.ends.pop()};af.prototype.getLineAndColumnFromChunk=function(ak){var aj,ah,ag,ai;if(ak===0){return[this.chunkLine,this.chunkColumn]}if(ak>=this.chunk.length){ai=this.chunk}else{ai=this.chunk.slice(0,+(ak-1)+1||9000000000)}ah=S(ai,"\n");aj=this.chunkColumn;if(ah>0){ag=ai.split("\n");aj=r(ag).length}else{aj+=ai.length}return[this.chunkLine+ah,aj]};af.prototype.makeToken=function(ao,am,al,ag){var an,ak,aj,ai,ah;if(al==null){al=0}if(ag==null){ag=am.length}ak={};ai=this.getLineAndColumnFromChunk(al),ak.first_line=ai[0],ak.first_column=ai[1];an=Math.max(0,ag-1);ah=this.getLineAndColumnFromChunk(al+an),ak.last_line=ah[0],ak.last_column=ah[1];aj=[ao,am,ak];return aj};af.prototype.token=function(ag,aj,ak,ai){var ah;ah=this.makeToken(ag,aj,ak,ai);this.tokens.push(ah);return ah};af.prototype.tag=function(ai,ag){var ah;return(ah=r(this.tokens,ai))&&(ag?ah[0]=ag:ah[0])};af.prototype.value=function(ah,ai){var ag;return(ag=r(this.tokens,ah))&&(ai?ag[1]=ai:ag[1])};af.prototype.unfinished=function(){var ag;return E.test(this.chunk)||((ag=this.tag())==="\\"||ag==="."||ag==="?."||ag==="?::"||ag==="UNARY"||ag==="MATH"||ag==="+"||ag==="-"||ag==="SHIFT"||ag==="RELATION"||ag==="COMPARE"||ag==="LOGIC"||ag==="THROW"||ag==="EXTENDS")};af.prototype.removeNewlines=function(ag){return ag.replace(/^\s*\n\s*/,"").replace(/([^\\]|\\\\)\s*\n\s*$/,"$1")};af.prototype.escapeLines=function(ah,ag){ah=ah.replace(/\\[^\S\n]*(\n|\\)\s*/g,function(aj,ai){if(ai==="\n"){return""}else{return aj}});if(ag){return ah.replace(Q,"\\n")}else{return ah.replace(/\s*\n\s*/g," ")}};af.prototype.makeString=function(ag,ai,ah){if(!ag){return ai+ai}ag=ag.replace(RegExp("\\\\("+ai+"|\\\\)","g"),function(aj,ak){if(ak===ai){return ak}else{return aj}});ag=ag.replace(RegExp(""+ai,"g"),"\\$&");return ai+this.escapeLines(ag,ah)+ai};af.prototype.error=function(ai,aj){var ag,ah,ak;if(aj==null){aj=0}ak=this.getLineAndColumnFromChunk(aj),ah=ak[0],ag=ak[1];return ab(ai,{first_line:ah,first_column:ag})};return af})();d=["true","false","null","this","new","delete","typeof","in","instanceof","return","throw","break","continue","debugger","if","else","switch","for","while","do","try","catch","finally","class","extends","super"];q=["undefined","then","unless","until","loop","of","by","when"];C={and:"&&",or:"||",is:"==",isnt:"!=",not:"!",yes:"true",no:"false",on:"true",off:"false"};P=(function(){var af;af=[];for(u in C){af.push(u)}return af})();q=q.concat(P);a=["case","default","function","var","void","with","const","let","enum","export","import","native","__hasProp","__extends","__slice","__bind","__indexOf","implements","interface","package","private","protected","public","static","yield"];x=["arguments","eval"];V=d.concat(a).concat(x);U.RESERVED=a.concat(d).concat(q).concat(x);U.STRICT_PROSCRIBED=x;O=65279;ae=/^([$A-Za-z_\x7f-\uffff][$\w\x7f-\uffff]*)([^\n\S]*:(?!:))?/;F=/^0b[01]+|^0o[0-7]+|^0x[\da-f]+|^\d*\.?\d+(?:e[+-]?\d+)?/i;n=/^("""|''')((?:\\[\s\S]|[^\\])*?)(?:\n[^\n\S]*)?\1/;X=/^(?:[-=]>|[-+*\/%<>&|^!?=]=|>>>=?|([-+:])\1|([&|<>])\2=?|\?(\.|::)|\.{2,3})/;k=/^[^\n\S]+/;g=/^###([^#][\s\S]*?)(?:###[^\n\S]*|###$)|^(?:\s*#(?!##[^#]).*)+/;z=/^[-=]>/;H=/^(?:\n[^\n\S]*)+/;i=/^'[^\\']*(?:\\[\s\S][^\\']*)*'/;y=/^`[^\\`]*(?:\\.[^\\`]*)*`/;j=/^(\/(?![\s=])[^[\/\n\\]*(?:(?:\\[\s\S]|\[[^\]\n\\]*(?:\\[\s\S][^\]\n\\]*)*])[^[\/\n\\]*)*\/)([imgy]{0,4})(?!\w)/;ad=/^\/{3}((?:\\?[\s\S])+?)\/{3}([imgy]{0,4})(?!\w)/;o=/((?:\\\\)+)|\\(\s|\/)|\s+(?:#.*)?/g;Q=/\n/g;s=/\n+([^\n\S]*)/g;T=/\*\//;E=/^\s*(?:,|\??\.(?![.\d])|::)/;ac=/\s+$/;c=["-=","+=","/=","*=","%=","||=","&&=","?=","<<=",">>=",">>>=","&=","^=","|="];B=["!","~","NEW","TYPEOF","DELETE","DO"];Y=["&&","||","&","|","^"];L=["<<",">>",">>>"];M=["==","!=","<",">","<=",">="];Z=["*","/","%"];A=["IN","OF","INSTANCEOF"];t=["TRUE","FALSE"];W=["NUMBER","REGEX","BOOL","NULL","UNDEFINED","++","--"];K=W.concat(")","}","THIS","IDENTIFIER","STRING","]");p=["IDENTIFIER","STRING","REGEX",")","]","}","?","::","@","THIS","SUPER"];w=p.concat("NUMBER","BOOL","NULL","UNDEFINED");R=["INDENT","OUTDENT","TERMINATOR"]});