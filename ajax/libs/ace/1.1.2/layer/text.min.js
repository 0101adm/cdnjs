define(function(e,g,b){var h=e("../lib/oop");var f=e("../lib/dom");var a=e("../lib/lang");var c=e("../lib/useragent");var i=e("../lib/event_emitter").EventEmitter;var d=function(j){this.element=f.createElement("div");this.element.className="ace_layer ace_text-layer";j.appendChild(this.element);this.$characterSize={width:0,height:0};this.checkForSizeChanges();this.$pollSizeChanges()};(function(){h.implement(this,i);this.EOF_CHAR="\xB6";this.EOL_CHAR="\xAC";this.TAB_CHAR="\u2192";this.SPACE_CHAR="\xB7";this.$padding=0;this.setPadding=function(j){this.$padding=j;this.element.style.padding="0 "+j+"px"};this.getLineHeight=function(){return this.$characterSize.height||0};this.getCharacterWidth=function(){return this.$characterSize.width||0};this.checkForSizeChanges=function(){var k=this.$measureSizes();if(k&&(this.$characterSize.width!==k.width||this.$characterSize.height!==k.height)){this.$measureNode.style.fontWeight="bold";var j=this.$measureSizes();this.$measureNode.style.fontWeight="";this.$characterSize=k;this.allowBoldFonts=j&&j.width===k.width&&j.height===k.height;this._emit("changeCharacterSize",{data:k})}};this.$pollSizeChanges=function(){var j=this;this.$pollSizeChangesTimer=setInterval(function(){j.checkForSizeChanges()},500)};this.$fontStyles={fontFamily:1,fontSize:1,fontWeight:1,fontStyle:1,lineHeight:1};this.$measureSizes=c.isIE||c.isOldGecko?function(){var q=1000;if(!this.$measureNode){var o=this.$measureNode=f.createElement("div");var m=o.style;m.width=m.height="auto";m.left=m.top=(-q*40)+"px";m.visibility="hidden";m.position="fixed";m.overflow="visible";m.whiteSpace="nowrap";o.innerHTML=a.stringRepeat("Xy",q);if(this.element.ownerDocument.body){this.element.ownerDocument.body.appendChild(o)}else{var j=this.element.parentNode;while(!f.hasCssClass(j,"ace_editor")){j=j.parentNode}j.appendChild(o)}}if(!this.element.offsetWidth){return null}var m=this.$measureNode.style;var k=f.computedStyle(this.element);for(var p in this.$fontStyles){m[p]=k[p]}var l={height:this.$measureNode.offsetHeight,width:this.$measureNode.offsetWidth/(q*2)};if(l.width==0||l.height==0){return null}return l}:function(){if(!this.$measureNode){var n=this.$measureNode=f.createElement("div");var l=n.style;l.width=l.height="auto";l.left=l.top=-100+"px";l.visibility="hidden";l.position="fixed";l.overflow="visible";l.whiteSpace="nowrap";n.innerHTML=a.stringRepeat("X",100);var j=this.element.parentNode;while(j&&!f.hasCssClass(j,"ace_editor")){j=j.parentNode}if(!j){return this.$measureNode=null}j.appendChild(n)}var m=this.$measureNode.getBoundingClientRect();var k={height:m.height,width:m.width/100};if(k.width==0||k.height==0){return null}return k};this.setSession=function(j){this.session=j;this.$computeTabString()};this.showInvisibles=false;this.setShowInvisibles=function(j){if(this.showInvisibles==j){return false}this.showInvisibles=j;this.$computeTabString();return true};this.displayIndentGuides=true;this.setDisplayIndentGuides=function(j){if(this.displayIndentGuides==j){return false}this.displayIndentGuides=j;this.$computeTabString();return true};this.$tabStrings=[];this.onChangeTabSize=this.$computeTabString=function(){var n=this.session.getTabSize();this.tabSize=n;var j=this.$tabStrings=[0];for(var k=1;k<n+1;k++){if(this.showInvisibles){j.push("<span class='ace_invisible'>"+this.TAB_CHAR+a.stringRepeat("\xa0",k-1)+"</span>")}else{j.push(a.stringRepeat("\xa0",k))}}if(this.displayIndentGuides){this.$indentGuideRe=/\s\S| \t|\t |\s$/;var l="ace_indent-guide";if(this.showInvisibles){l+=" ace_invisible";var o=a.stringRepeat(this.SPACE_CHAR,this.tabSize);var m=this.TAB_CHAR+a.stringRepeat("\xa0",this.tabSize-1)}else{var o=a.stringRepeat("\xa0",this.tabSize);var m=o}this.$tabStrings[" "]="<span class='"+l+"'>"+o+"</span>";this.$tabStrings["\t"]="<span class='"+l+"'>"+m+"</span>"}};this.updateLines=function(k,m,u){if(this.config.lastRow!=k.lastRow||this.config.firstRow!=k.firstRow){this.scrollLines(k)}this.config=k;var p=Math.max(m,k.firstRow);var r=Math.min(u,k.lastRow);var s=this.element.childNodes;var j=0;for(var t=k.firstRow;t<p;t++){var q=this.session.getFoldLine(t);if(q){if(q.containsRow(p)){p=q.start.row;break}else{t=q.end.row}}j++}var t=p;var q=this.session.getNextFoldLine(t);var n=q?q.start.row:Infinity;while(true){if(t>n){t=q.end.row+1;q=this.session.getNextFoldLine(t,q);n=q?q.start.row:Infinity}if(t>r){break}var l=s[j++];if(l){var o=[];this.$renderLine(o,t,!this.$useLineGroups(),t==n?q:false);l.style.height=k.lineHeight*this.session.getRowLength(t)+"px";f.setInnerHtml(l,o.join(""))}t++}};this.scrollLines=function(l){var j=this.config;this.config=l;if(!j||j.lastRow<l.firstRow){return this.update(l)}if(l.lastRow<j.firstRow){return this.update(l)}var m=this.element;if(j.firstRow<l.firstRow){for(var n=this.session.getFoldedRowCount(j.firstRow,l.firstRow-1);n>0;n--){m.removeChild(m.firstChild)}}if(j.lastRow>l.lastRow){for(var n=this.session.getFoldedRowCount(l.lastRow+1,j.lastRow);n>0;n--){m.removeChild(m.lastChild)}}if(l.firstRow<j.firstRow){var k=this.$renderLinesFragment(l,l.firstRow,j.firstRow-1);if(m.firstChild){m.insertBefore(k,m.firstChild)}else{m.appendChild(k)}}if(l.lastRow>j.lastRow){var k=this.$renderLinesFragment(l,j.lastRow+1,l.lastRow);m.appendChild(k)}};this.$renderLinesFragment=function(k,l,s){var o=this.element.ownerDocument.createDocumentFragment();var r=l;var p=this.session.getNextFoldLine(r);var m=p?p.start.row:Infinity;while(true){if(r>m){r=p.end.row+1;p=this.session.getNextFoldLine(r,p);m=p?p.start.row:Infinity}if(r>s){break}var j=f.createElement("div");var n=[];this.$renderLine(n,r,false,r==m?p:false);j.innerHTML=n.join("");if(this.$useLineGroups()){j.className="ace_line_group";o.appendChild(j);j.style.height=k.lineHeight*this.session.getRowLength(r)+"px"}else{var q=j.childNodes;while(q.length){o.appendChild(q[0])}}r++}return o};this.update=function(k){this.config=k;var l=[];var p=k.firstRow,m=k.lastRow;var o=p;var n=this.session.getNextFoldLine(o);var j=n?n.start.row:Infinity;while(true){if(o>j){o=n.end.row+1;n=this.session.getNextFoldLine(o,n);j=n?n.start.row:Infinity}if(o>m){break}if(this.$useLineGroups()){l.push("<div class='ace_line_group' style='height:",k.lineHeight*this.session.getRowLength(o),"px'>")}this.$renderLine(l,o,false,o==j?n:false);if(this.$useLineGroups()){l.push("</div>")}o++}this.element=f.setInnerHtml(this.element,l.join(""))};this.$textToken={text:true,rparen:true,lparen:true};this.$renderToken=function(l,p,o,r){var s=this;var j=/\t|&|<|( +)|([\x00-\x1f\x80-\xa0\u1680\u180E\u2000-\u200f\u2028\u2029\u202F\u205F\u3000\uFEFF])|[\u1100-\u115F\u11A3-\u11A7\u11FA-\u11FF\u2329-\u232A\u2E80-\u2E99\u2E9B-\u2EF3\u2F00-\u2FD5\u2FF0-\u2FFB\u3000-\u303E\u3041-\u3096\u3099-\u30FF\u3105-\u312D\u3131-\u318E\u3190-\u31BA\u31C0-\u31E3\u31F0-\u321E\u3220-\u3247\u3250-\u32FE\u3300-\u4DBF\u4E00-\uA48C\uA490-\uA4C6\uA960-\uA97C\uAC00-\uD7A3\uD7B0-\uD7C6\uD7CB-\uD7FB\uF900-\uFAFF\uFE10-\uFE19\uFE30-\uFE52\uFE54-\uFE66\uFE68-\uFE6B\uFF01-\uFF60\uFFE0-\uFFE6]/g;var q=function(A,v,u,w,t){if(v){return s.showInvisibles?"<span class='ace_invisible'>"+a.stringRepeat(s.SPACE_CHAR,A.length)+"</span>":a.stringRepeat("\xa0",A.length)}else{if(A=="&"){return"&#38;"}else{if(A=="<"){return"&#60;"}else{if(A=="\t"){var y=s.session.getScreenTabSize(p+w);p+=y-1;return s.$tabStrings[y]}else{if(A=="\u3000"){var z=s.showInvisibles?"ace_cjk ace_invisible":"ace_cjk";var x=s.showInvisibles?s.SPACE_CHAR:"";p+=1;return"<span class='"+z+"' style='width:"+(s.config.characterWidth*2)+"px'>"+x+"</span>"}else{if(u){return"<span class='ace_invisible ace_invalid'>"+s.SPACE_CHAR+"</span>"}else{p+=1;return"<span class='ace_cjk' style='width:"+(s.config.characterWidth*2)+"px'>"+A+"</span>"}}}}}}};var m=r.replace(j,q);if(!this.$textToken[o.type]){var n="ace_"+o.type.replace(/\./g," ace_");var k="";if(o.type=="fold"){k=" style='width:"+(o.value.length*this.config.characterWidth)+"px;' "}l.push("<span class='",n,"'",k,">",m,"</span>")}else{l.push(m)}return p+r.length};this.renderIndentGuide=function(l,k,j){var m=k.search(this.$indentGuideRe);if(m<=0||m>=j){return k}if(k[0]==" "){m-=m%this.tabSize;l.push(a.stringRepeat(this.$tabStrings[" "],m/this.tabSize));return k.substr(m)}else{if(k[0]=="\t"){l.push(a.stringRepeat(this.$tabStrings["\t"],m));return k.substr(m)}}return k};this.$renderWrappedLine=function(j,p,t,k){var q=0;var r=0;var l=t[0];var o=0;for(var n=0;n<p.length;n++){var m=p[n];var s=m.value;if(n==0&&this.displayIndentGuides){q=s.length;s=this.renderIndentGuide(j,s,l);if(!s){continue}q-=s.length}if(q+s.length<l){o=this.$renderToken(j,o,m,s);q+=s.length}else{while(q+s.length>=l){o=this.$renderToken(j,o,m,s.substring(0,l-q));s=s.substring(l-q);q=l;if(!k){j.push("</div>","<div class='ace_line' style='height:",this.config.lineHeight,"px'>")}r++;o=0;l=t[r]||Number.MAX_VALUE}if(s.length!=0){q+=s.length;o=this.$renderToken(j,o,m,s)}}}};this.$renderSimpleLine=function(n,o){var l=0;var k=o[0];var m=k.value;if(this.displayIndentGuides){m=this.renderIndentGuide(n,m)}if(m){l=this.$renderToken(n,l,k,m)}for(var j=1;j<o.length;j++){k=o[j];m=k.value;l=this.$renderToken(n,l,k,m)}};this.$renderLine=function(k,o,j,n){if(!n&&n!=false){n=this.session.getFoldLine(o)}if(n){var m=this.$getFoldLineTokens(o,n)}else{var m=this.session.getTokens(o)}if(!j){k.push("<div class='ace_line' style='height:",this.config.lineHeight*(this.$useLineGroups()?1:this.session.getRowLength(o)),"px'>")}if(m.length){var l=this.session.getRowSplitData(o);if(l&&l.length){this.$renderWrappedLine(k,m,l,j)}else{this.$renderSimpleLine(k,m)}}if(this.showInvisibles){if(n){o=n.end.row}k.push("<span class='ace_invisible'>",o==this.session.getLength()-1?this.EOF_CHAR:this.EOL_CHAR,"</span>")}if(!j){k.push("</div>")}};this.$getFoldLineTokens=function(n,m){var l=this.session;var j=[];function o(s,u,t){var p=0,q=0;while((q+s[p].value.length)<u){q+=s[p].value.length;p++;if(p==s.length){return}}if(q!=u){var r=s[p].value.substring(u-q);if(r.length>(t-u)){r=r.substring(0,t-u)}j.push({type:s[p].type,value:r});q=u+r.length;p+=1}while(q<t&&p<s.length){var r=s[p].value;if(r.length+q>t){j.push({type:s[p].type,value:r.substring(0,t-q)})}else{j.push(s[p])}q+=r.length;p+=1}}var k=l.getTokens(n);m.walk(function(t,s,r,q,p){if(t!=null){j.push({type:"fold",value:t})}else{if(p){k=l.getTokens(s)}if(k.length){o(k,q,r)}}},m.end.row,this.session.getLine(m.end.row).length);return j};this.$useLineGroups=function(){return this.session.getUseWrapMode()};this.destroy=function(){clearInterval(this.$pollSizeChangesTimer);if(this.$measureNode){this.$measureNode.parentNode.removeChild(this.$measureNode)}delete this.$measureNode}}).call(d.prototype);g.Text=d});