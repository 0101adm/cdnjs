define(function(d,c,e){var g=d("./lib/oop");var f=d("./lib/event_emitter").EventEmitter;var h=d("./range").Range;var a=d("./anchor").Anchor;var b=function(i){this.$lines=[];if(i.length==0){this.$lines=[""]}else{if(Array.isArray(i)){this._insertLines(0,i)}else{this.insert({row:0,column:0},i)}}};(function(){g.implement(this,f);this.setValue=function(j){var i=this.getLength();this.remove(new h(0,0,i,this.getLine(i-1).length));this.insert({row:0,column:0},j)};this.getValue=function(){return this.getAllLines().join(this.getNewLineCharacter())};this.createAnchor=function(j,i){return new a(this,j,i)};if("aaa".split(/a/).length==0){this.$split=function(i){return i.replace(/\r\n|\r/g,"\n").split("\n")}}else{this.$split=function(i){return i.split(/\r\n|\r|\n/)}}this.$detectNewLine=function(j){var i=j.match(/^.*?(\r\n|\r|\n)/m);this.$autoNewLine=i?i[1]:"\n"};this.getNewLineCharacter=function(){switch(this.$newLineMode){case"windows":return"\r\n";case"unix":return"\n";default:return this.$autoNewLine}};this.$autoNewLine="\n";this.$newLineMode="auto";this.setNewLineMode=function(i){if(this.$newLineMode===i){return}this.$newLineMode=i};this.getNewLineMode=function(){return this.$newLineMode};this.isNewLine=function(i){return(i=="\r\n"||i=="\r"||i=="\n")};this.getLine=function(i){return this.$lines[i]||""};this.getLines=function(j,i){return this.$lines.slice(j,i+1)};this.getAllLines=function(){return this.getLines(0,this.getLength())};this.getLength=function(){return this.$lines.length};this.getTextRange=function(k){if(k.start.row==k.end.row){return this.getLine(k.start.row).substring(k.start.column,k.end.column)}var j=this.getLines(k.start.row,k.end.row);j[0]=(j[0]||"").substring(k.start.column);var i=j.length-1;if(k.end.row-k.start.row==i){j[i]=j[i].substring(0,k.end.column)}return j.join(this.getNewLineCharacter())};this.$clipPosition=function(i){var j=this.getLength();if(i.row>=j){i.row=Math.max(0,j-1);i.column=this.getLine(j-1).length}else{if(i.row<0){i.row=0}}return i};this.insert=function(i,m){if(!m||m.length===0){return i}i=this.$clipPosition(i);if(this.getLength()<=1){this.$detectNewLine(m)}var k=this.$split(m);var l=k.splice(0,1)[0];var j=k.length==0?null:k.splice(k.length-1,1)[0];i=this.insertInLine(i,l);if(j!==null){i=this.insertNewLine(i);i=this._insertLines(i.row,k);i=this.insertInLine(i,j||"")}return i};this.insertLines=function(j,i){if(j>=this.getLength()){return this.insert({row:j,column:0},"\n"+i.join("\n"))}return this._insertLines(Math.max(j,0),i)};this._insertLines=function(m,j){if(j.length==0){return{row:m,column:0}}if(j.length>65535){var i=this._insertLines(m,j.slice(65535));j=j.slice(0,65535)}var l=[m,0];l.push.apply(l,j);this.$lines.splice.apply(this.$lines,l);var k=new h(m,0,m+j.length,0);var n={action:"insertLines",range:k,lines:j};this._emit("change",{data:n});return i||k.end};this.insertNewLine=function(i){i=this.$clipPosition(i);var k=this.$lines[i.row]||"";this.$lines[i.row]=k.substring(0,i.column);this.$lines.splice(i.row+1,0,k.substring(i.column,k.length));var j={row:i.row+1,column:0};var l={action:"insertText",range:h.fromPoints(i,j),text:this.getNewLineCharacter()};this._emit("change",{data:l});return j};this.insertInLine=function(i,l){if(l.length==0){return i}var k=this.$lines[i.row]||"";this.$lines[i.row]=k.substring(0,i.column)+l+k.substring(i.column);var j={row:i.row,column:i.column+l.length};var m={action:"insertText",range:h.fromPoints(i,j),text:l};this._emit("change",{data:m});return j};this.remove=function(j){if(!j instanceof h){j=h.fromPoints(j.start,j.end)}j.start=this.$clipPosition(j.start);j.end=this.$clipPosition(j.end);if(j.isEmpty()){return j.start}var m=j.start.row;var k=j.end.row;if(j.isMultiLine()){var l=j.start.column==0?m:m+1;var i=k-1;if(j.end.column>0){this.removeInLine(k,0,j.end.column)}if(i>=l){this._removeLines(l,i)}if(l!=m){this.removeInLine(m,j.start.column,this.getLine(m).length);this.removeNewLine(j.start.row)}}else{this.removeInLine(m,j.start.column,j.end.column)}return j.start};this.removeInLine=function(m,k,p){if(k==p){return}var j=new h(m,k,m,p);var i=this.getLine(m);var l=i.substring(k,p);var o=i.substring(0,k)+i.substring(p,i.length);this.$lines.splice(m,1,o);var n={action:"removeText",range:j,text:l};this._emit("change",{data:n});return j.start};this.removeLines=function(j,i){if(j<0||i>=this.getLength()){return this.remove(new h(j,0,i+1,0))}return this._removeLines(j,i)};this._removeLines=function(l,j){var i=new h(l,0,j+1,0);var k=this.$lines.splice(l,j-l+1);var m={action:"removeLines",range:i,nl:this.getNewLineCharacter(),lines:k};this._emit("change",{data:m});return k};this.removeNewLine=function(m){var l=this.getLine(m);var i=this.getLine(m+1);var k=new h(m,l.length,m+1,0);var j=l+i;this.$lines.splice(m,2,j);var n={action:"removeText",range:k,text:this.getNewLineCharacter()};this._emit("change",{data:n})};this.replace=function(j,k){if(!j instanceof h){j=h.fromPoints(j.start,j.end)}if(k.length==0&&j.isEmpty()){return j.start}if(k==this.getTextRange(j)){return j.end}this.remove(j);if(k){var i=this.insert(j.start,k)}else{i=j.start}return i};this.applyDeltas=function(l){for(var k=0;k<l.length;k++){var m=l[k];var j=h.fromPoints(m.range.start,m.range.end);if(m.action=="insertLines"){this.insertLines(j.start.row,m.lines)}else{if(m.action=="insertText"){this.insert(j.start,m.text)}else{if(m.action=="removeLines"){this._removeLines(j.start.row,j.end.row-1)}else{if(m.action=="removeText"){this.remove(j)}}}}}};this.revertDeltas=function(l){for(var k=l.length-1;k>=0;k--){var m=l[k];var j=h.fromPoints(m.range.start,m.range.end);if(m.action=="insertLines"){this._removeLines(j.start.row,j.end.row-1)}else{if(m.action=="insertText"){this.remove(j)}else{if(m.action=="removeLines"){this._insertLines(j.start.row,m.lines)}else{if(m.action=="removeText"){this.insert(j.start,m.text)}}}}}};this.indexToPosition=function(o,n){var k=this.$lines||this.getAllLines();var m=this.getNewLineCharacter().length;for(var p=n||0,j=k.length;p<j;p++){o-=k[p].length+m;if(o<0){return{row:p,column:o+k[p].length+m}}}return{row:j-1,column:k[j-1].length}};this.positionToIndex=function(p,l){var j=this.$lines||this.getAllLines();var k=this.getNewLineCharacter().length;var m=0;var o=Math.min(p.row,j.length);for(var n=l||0;n<o;++n){m+=j[n].length+k}return m+p.column}}).call(b.prototype);c.Document=b});