define(function(c,b,e){var d=function(i){this.$editor=i;var f=this;var g=[];var h=false;this.onAfterExec=function(){h=false;f.processRows(g);g=[]};this.onExec=function(){h=true};this.onChange=function(k){var j=k.data.range;if(h){if(g.indexOf(j.start.row)==-1){g.push(j.start.row)}if(j.end.row!=j.start.row){g.push(j.end.row)}}}};(function(){this.processRows=function(q){this.$inChange=true;var j=[];for(var f=0,n=q.length;f<n;f++){var p=q[f];if(j.indexOf(p)>-1){continue}var k=this.$findCellWidthsForBlock(p);var g=this.$setBlockCellWidthsToMax(k.cellWidths);var m=k.firstRow;for(var o=0,i=g.length;o<i;o++){var h=g[o];j.push(m);this.$adjustRow(m,h);m++}}this.$inChange=false};this.$findCellWidthsForBlock=function(k){var h=[],g;var f=k;while(f>=0){g=this.$cellWidthsForRow(f);if(g.length==0){break}h.unshift(g);f--}var j=f+1;f=k;var i=this.$editor.session.getLength();while(f<i-1){f++;g=this.$cellWidthsForRow(f);if(g.length==0){break}h.push(g)}return{cellWidths:h,firstRow:j}};this.$cellWidthsForRow=function(p){var g=this.$selectionColumnsForRow(p);var m=[-1].concat(this.$tabsForRow(p));var h=m.map(function(i){return 0}).slice(1);var q=this.$editor.session.getLine(p);for(var j=0,k=m.length-1;j<k;j++){var f=m[j]+1;var l=m[j+1];var n=this.$rightmostSelectionInCell(g,l);var o=q.substring(f,l);h[j]=Math.max(o.replace(/\s+$/g,"").length,n-f)}return h};this.$selectionColumnsForRow=function(h){var f=[],g=this.$editor.getCursorPosition();if(this.$editor.session.getSelection().isEmpty()){if(h==g.row){f.push(g.column)}}return f};this.$setBlockCellWidthsToMax=function(h){var g=true,p,q,u;var n=this.$izip_longest(h);for(var t=0,m=n.length;t<m;t++){var k=n[t];if(!k.push){console.error(k);continue}k.push(NaN);for(var f=0,v=k.length;f<v;f++){var i=k[f];if(g){p=f;u=0;g=false}if(isNaN(i)){q=f;for(var o=p;o<q;o++){h[o][t]=u}g=true}u=Math.max(u,i)}}return h};this.$rightmostSelectionInCell=function(h,g){var f=0;if(h.length){var k=[];for(var i=0,j=h.length;i<j;i++){if(h[i]<=g){k.push(i)}else{k.push(0)}}f=Math.max.apply(Math,k)}return f};this.$tabsForRow=function(j){var h=[],f=this.$editor.session.getLine(j),i=/\t/g,g;while((g=i.exec(f))!=null){h.push(g.index)}return h};this.$adjustRow=function(u,j){var q=this.$tabsForRow(u);if(q.length==0){return}var p=0,t=-1;var g=this.$izip(j,q);for(var n=0,k=g.length;n<k;n++){var s=g[n][0],m=g[n][1];t+=1+s;m+=p;var h=t-m;if(h==0){continue}var r=this.$editor.session.getLine(u).substr(0,m);var f=r.replace(/\s*$/g,"");var o=r.length-f.length;if(h>0){this.$editor.session.getDocument().insertInLine({row:u,column:m+1},Array(h+1).join(" ")+"\t");this.$editor.session.getDocument().removeInLine(u,m,m+1);p+=h}if(h<0&&o>=-h){this.$editor.session.getDocument().removeInLine(u,m+h,m);p+=h}}};this.$izip_longest=function(g){if(!g[0]){return[]}var k=g[0].length;var m=g.length;for(var j=1;j<m;j++){var h=g[j].length;if(h>k){k=h}}var n=[];for(var f=0;f<k;f++){var o=[];for(var j=0;j<m;j++){if(g[j][f]===""){o.push(NaN)}else{o.push(g[j][f])}}n.push(o)}return n};this.$izip=function(j,h){var g=j.length>=h.length?h.length:j.length;var k=[];for(var f=0;f<g;f++){var l=[j[f],h[f]];k.push(l)}return k}}).call(d.prototype);b.ElasticTabstopsLite=d;var a=c("../editor").Editor;c("../config").defineOptions(a.prototype,"editor",{useElasticTabstops:{set:function(f){if(f){if(!this.elasticTabstops){this.elasticTabstops=new d(this)}this.commands.on("afterExec",this.elasticTabstops.onAfterExec);this.commands.on("exec",this.elasticTabstops.onExec);this.on("change",this.elasticTabstops.onChange)}else{if(this.elasticTabstops){this.commands.removeListener("afterExec",this.elasticTabstops.onAfterExec);this.commands.removeListener("exec",this.elasticTabstops.onExec);this.removeListener("change",this.elasticTabstops.onChange)}}}}})});