define(function(c,b,d){var f=c("./lib/oop");var e=c("./lib/event_emitter").EventEmitter;var a=b.Anchor=function(h,i,g){this.$onChange=this.onChange.bind(this);this.attach(h);if(typeof g=="undefined"){this.setPosition(i.row,i.column)}else{this.setPosition(i,g)}};(function(){f.implement(this,e);this.getPosition=function(){return this.$clipPositionToDocument(this.row,this.column)};this.getDocument=function(){return this.document};this.$insertRight=false;this.onChange=function(j){var m=j.data;var h=m.range;if(h.start.row==h.end.row&&h.start.row!=this.row){return}if(h.start.row>this.row){return}if(h.start.row==this.row&&h.start.column>this.column){return}var k=this.row;var i=this.column;var l=h.start;var g=h.end;if(m.action==="insertText"){if(l.row===k&&l.column<=i){if(l.column===i&&this.$insertRight){}else{if(l.row===g.row){i+=g.column-l.column}else{i-=l.column;k+=g.row-l.row}}}else{if(l.row!==g.row&&l.row<k){k+=g.row-l.row}}}else{if(m.action==="insertLines"){if(l.row<=k){k+=g.row-l.row}}else{if(m.action==="removeText"){if(l.row===k&&l.column<i){if(g.column>=i){i=l.column}else{i=Math.max(0,i-(g.column-l.column))}}else{if(l.row!==g.row&&l.row<k){if(g.row===k){i=Math.max(0,i-g.column)+l.column}k-=(g.row-l.row)}else{if(g.row===k){k-=g.row-l.row;i=Math.max(0,i-g.column)+l.column}}}}else{if(m.action=="removeLines"){if(l.row<=k){if(g.row<=k){k-=g.row-l.row}else{k=l.row;i=0}}}}}}this.setPosition(k,i,true)};this.setPosition=function(j,i,g){var k;if(g){k={row:j,column:i}}else{k=this.$clipPositionToDocument(j,i)}if(this.row==k.row&&this.column==k.column){return}var h={row:this.row,column:this.column};this.row=k.row;this.column=k.column;this._emit("change",{old:h,value:k})};this.detach=function(){this.document.removeEventListener("change",this.$onChange)};this.attach=function(g){this.document=g||this.document;this.document.on("change",this.$onChange)};this.$clipPositionToDocument=function(h,g){var i={};if(h>=this.document.getLength()){i.row=Math.max(0,this.document.getLength()-1);i.column=this.document.getLine(i.row).length}else{if(h<0){i.row=0;i.column=0}else{i.row=h;i.column=Math.min(this.document.getLine(i.row).length,Math.max(0,g))}}if(g<0){i.column=0}return i}}).call(a.prototype)});