define(function(d,f,b){var j=d("./keys");var c=d("./useragent");var e=d("./dom");f.addListener=function(l,k,n){if(l.addEventListener){return l.addEventListener(k,n,false)}if(l.attachEvent){var m=function(){n.call(l,window.event)};n._wrapper=m;l.attachEvent("on"+k,m)}};f.removeListener=function(l,k,m){if(l.removeEventListener){return l.removeEventListener(k,m,false)}if(l.detachEvent){l.detachEvent("on"+k,m._wrapper||m)}};f.stopEvent=function(k){f.stopPropagation(k);f.preventDefault(k);return false};f.stopPropagation=function(k){if(k.stopPropagation){k.stopPropagation()}else{k.cancelBubble=true}};f.preventDefault=function(k){if(k.preventDefault){k.preventDefault()}else{k.returnValue=false}};f.getButton=function(k){if(k.type=="dblclick"){return 0}if(k.type=="contextmenu"||(k.ctrlKey&&c.isMac)){return 2}if(k.preventDefault){return k.button}else{return{1:0,2:2,4:1}[k.button]}};f.capture=function(n,m,l){function k(o){m&&m(o);l&&l(o);f.removeListener(document,"mousemove",m,true);f.removeListener(document,"mouseup",k,true);f.removeListener(document,"dragstart",k,true)}f.addListener(document,"mousemove",m,true);f.addListener(document,"mouseup",k,true);f.addListener(document,"dragstart",k,true);return k};f.addMouseWheelListener=function(k,l){if("onmousewheel" in k){f.addListener(k,"mousewheel",function(n){var m=8;if(n.wheelDeltaX!==undefined){n.wheelX=-n.wheelDeltaX/m;n.wheelY=-n.wheelDeltaY/m}else{n.wheelX=0;n.wheelY=-n.wheelDelta/m}l(n)})}else{if("onwheel" in k){f.addListener(k,"wheel",function(n){var m=0.35;switch(n.deltaMode){case n.DOM_DELTA_PIXEL:n.wheelX=n.deltaX*m||0;n.wheelY=n.deltaY*m||0;break;case n.DOM_DELTA_LINE:case n.DOM_DELTA_PAGE:n.wheelX=(n.deltaX||0)*5;n.wheelY=(n.deltaY||0)*5;break}l(n)})}else{f.addListener(k,"DOMMouseScroll",function(m){if(m.axis&&m.axis==m.HORIZONTAL_AXIS){m.wheelX=(m.detail||0)*5;m.wheelY=0}else{m.wheelX=0;m.wheelY=(m.detail||0)*5}l(m)})}}};f.addMultiMouseDownListener=function(n,k,o,r){var s=0;var q,p,l;var m={2:"dblclick",3:"tripleclick",4:"quadclick"};f.addListener(n,"mousedown",function(u){if(f.getButton(u)!=0){s=0}else{if(u.detail>1){s++;if(s>4){s=1}}else{s=1}}if(c.isIE){var t=Math.abs(u.clientX-q)>5||Math.abs(u.clientY-p)>5;if(t){s=1}if(s==1){q=u.clientX;p=u.clientY}}o[r]("mousedown",u);if(s>4){s=0}else{if(s>1){return o[r](m[s],u)}}});if(c.isOldIE){f.addListener(n,"dblclick",function(t){s=2;if(l){clearTimeout(l)}l=setTimeout(function(){l=null},k[s-1]||600);o[r]("mousedown",t);o[r](m[s],t)})}};function i(p,o,n){var m=0;if((c.isOpera&&!("KeyboardEvent" in window))&&c.isMac){m=0|(o.metaKey?1:0)|(o.altKey?2:0)|(o.shiftKey?4:0)|(o.ctrlKey?8:0)}else{m=0|(o.ctrlKey?1:0)|(o.altKey?2:0)|(o.shiftKey?4:0)|(o.metaKey?8:0)}if(!c.isMac&&h){if(h[91]||h[92]){m|=8}if(h.altGr){if((3&m)!=3){h.altGr=0}else{return}}if(n===18||n===17){var k=o.location||o.keyLocation;if(n===17&&k===1){g=o.timeStamp}else{if(n===18&&m===3&&k===2){var l=-g;g=o.timeStamp;l+=g;if(l<3){h.altGr=true}}}}}if(n in j.MODIFIER_KEYS){switch(j.MODIFIER_KEYS[n]){case"Alt":m=2;break;case"Shift":m=4;break;case"Ctrl":m=1;break;default:m=8;break}n=0}if(m&8&&(n===91||n===93)){n=0}if(!m&&n===13){if(o.location||o.keyLocation===3){p(o,m,-n);if(o.defaultPrevented){return}}}if(!m&&!(n in j.FUNCTION_KEYS)&&!(n in j.PRINTABLE_KEYS)){return false}return p(o,m,n)}var h=null;var g=0;f.addCommandKeyListener=function(m,o){var l=f.addListener;if(c.isOldGecko||(c.isOpera&&!("KeyboardEvent" in window))){var n=null;l(m,"keydown",function(p){n=p.keyCode});l(m,"keypress",function(p){return i(o,p,n)})}else{var k=null;l(m,"keydown",function(q){h[q.keyCode]=true;var p=i(o,q,q.keyCode);k=q.defaultPrevented;return p});l(m,"keypress",function(p){if(k&&(p.ctrlKey||p.altKey||p.shiftKey||p.metaKey)){f.stopEvent(p);k=null}});l(m,"keyup",function(p){h[p.keyCode]=null});if(!h){h=Object.create(null);l(window,"focus",function(p){h=Object.create(null)})}}};if(window.postMessage&&!c.isOldIE){var a=1;f.nextTick=function(n,m){m=m||window;var k="zero-timeout-message-"+a;f.addListener(m,"message",function l(o){if(o.data==k){f.stopPropagation(o);f.removeListener(m,"message",l);n()}});m.postMessage(k,"*")}}f.nextFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame;if(f.nextFrame){f.nextFrame=f.nextFrame.bind(window)}else{f.nextFrame=function(k){setTimeout(k,17)}}});