define(function(c,a,d){var f=c("../lib/oop");var e=c("../lib/event_emitter").EventEmitter;var b=c("../config");var h=function(k,j,n){this.$sendDeltaQueue=this.$sendDeltaQueue.bind(this);this.changeListener=this.changeListener.bind(this);this.onMessage=this.onMessage.bind(this);if(c.nameToUrl&&!c.toUrl){c.toUrl=c.nameToUrl}var l;if(b.get("packaged")||!c.toUrl){l=b.moduleUrl(j,"worker")}else{var i=this.$normalizePath;l=i(c.toUrl("ace/worker/worker.js",null,"_"));var m={};k.forEach(function(o){m[o]=i(c.toUrl(o,null,"_").replace(/(\.js)?(\?.*)?$/,""))})}this.$worker=new Worker(l);this.$worker.postMessage({init:true,tlns:m,module:j,classname:n});this.callbackId=1;this.callbacks={};this.$worker.onmessage=this.onMessage};(function(){f.implement(this,e);this.onMessage=function(i){var j=i.data;switch(j.type){case"log":window.console&&console.log&&console.log.apply(console,j.data);break;case"event":this._emit(j.name,{data:j.data});break;case"call":var k=this.callbacks[j.id];if(k){k(j.data);delete this.callbacks[j.id]}break}};this.$normalizePath=function(i){if(!location.host){return i}i=i.replace(/^[a-z]+:\/\/[^\/]+/,"");i=location.protocol+"//"+location.host+(i.charAt(0)=="/"?"":location.pathname.replace(/\/[^\/]*$/,""))+"/"+i.replace(/^[\/]+/,"");return i};this.terminate=function(){this._emit("terminate",{});this.deltaQueue=null;this.$worker.terminate();this.$worker=null;this.$doc.removeEventListener("change",this.changeListener);this.$doc=null};this.send=function(j,i){this.$worker.postMessage({command:j,args:i})};this.call=function(j,i,l){if(l){var k=this.callbackId++;this.callbacks[k]=l;i.push(k)}this.send(j,i)};this.emit=function(j,k){try{this.$worker.postMessage({event:j,data:{data:k.data}})}catch(i){}};this.attachToDocument=function(i){if(this.$doc){this.terminate()}this.$doc=i;this.call("setValue",[i.getValue()]);i.on("change",this.changeListener)};this.changeListener=function(i){if(!this.deltaQueue){this.deltaQueue=[i.data];setTimeout(this.$sendDeltaQueue,0)}else{this.deltaQueue.push(i.data)}};this.$sendDeltaQueue=function(){var i=this.deltaQueue;if(!i){return}this.deltaQueue=null;if(i.length>20&&i.length>this.$doc.getLength()>>1){this.call("setValue",[this.$doc.getValue()])}else{this.emit("change",{data:i})}}}).call(h.prototype);var g=function(m,l,o){this.$sendDeltaQueue=this.$sendDeltaQueue.bind(this);this.changeListener=this.changeListener.bind(this);this.callbackId=1;this.callbacks={};this.messageBuffer=[];var j=null;var k=Object.create(e);var i=this;this.$worker={};this.$worker.terminate=function(){};this.$worker.postMessage=function(p){i.messageBuffer.push(p);j&&setTimeout(n)};var n=function(){var p=i.messageBuffer.shift();if(p.command){j[p.command].apply(j,p.args)}else{if(p.event){k._emit(p.event,p.data)}}};k.postMessage=function(p){i.onMessage({data:p})};k.callback=function(q,p){this.postMessage({type:"call",id:p,data:q})};k.emit=function(p,q){this.postMessage({type:"event",name:p,data:q})};b.loadModule(["worker",l],function(p){j=new p[o](k);while(i.messageBuffer.length){n()}})};g.prototype=h.prototype;a.UIWorkerClient=g;a.WorkerClient=h});