define(function(h,x,b){var y=h("../../lib/lang");var a=h("./maps/util");var q=h("./maps/motions");var r=h("./maps/operators");var n=h("./maps/aliases");var u=h("./registers");var m=1;var j=2;var c=3;var s=4;var v=8;var i=function i(A,B,z){while(0<B--){A.apply(this,z)}};var d=function(z){var B=z.renderer;var D=B.$cursorLayer.getPixelPosition();var C=D.top;var A=v*B.layerConfig.lineHeight;if(2*A>B.$size.scrollerHeight){A=B.$size.scrollerHeight/2}if(B.scrollTop>C-A){B.session.setScrollTop(C-A)}if(B.scrollTop+B.$size.scrollerHeight<C+A+B.lineHeight){B.session.setScrollTop(C+A+B.lineHeight-B.$size.scrollerHeight)}};var k=x.actions={z:{param:true,fn:function(A,z,B,C){switch(C){case"z":A.renderer.alignCursor(null,0.5);break;case"t":A.renderer.alignCursor(null,0);break;case"b":A.renderer.alignCursor(null,1);break;case"c":A.session.onFoldWidgetClick(z.start.row,{domEvent:{target:{}}});break;case"o":A.session.onFoldWidgetClick(z.start.row,{domEvent:{target:{}}});break;case"C":A.session.foldAll();break;case"O":A.session.unfold();break}}},r:{param:true,fn:function(A,z,B,C){if(C&&C.length){if(C.length>1){C=C=="return"?"\n":C=="tab"?"\t":C}i(function(){A.insert(C)},B||1);A.navigateLeft()}}},R:{fn:function(A,z,B,C){a.insertMode(A);A.setOverwrite(true)}},"~":{fn:function(A,z,B){i(function(){var C=A.selection.getRange();if(C.isEmpty()){C.end.column++}var D=A.session.getTextRange(C);var E=D.toUpperCase();if(E==D){A.navigateRight()}else{A.session.replace(C,E)}},B||1)}},"*":{fn:function(A,z,C,D){A.selection.selectWord();A.findNext();d(A);var B=A.selection.getRange();A.selection.setSelectionRange(B,true)}},"#":{fn:function(A,z,C,D){A.selection.selectWord();A.findPrevious();d(A);var B=A.selection.getRange();A.selection.setSelectionRange(B,true)}},m:{param:true,fn:function(B,z,C,E){var A=B.session;var D=A.vimMarkers||(A.vimMarkers={});var F=B.getCursorPosition();if(!D[E]){D[E]=B.session.doc.createAnchor(F)}D[E].setPosition(F.row,F.column,true)}},n:{fn:function(B,z,D,E){var A=B.getLastSearchOptions();A.backwards=false;B.selection.moveCursorRight();B.selection.clearSelection();B.findNext(A);d(B);var C=B.selection.getRange();C.end.row=C.start.row;C.end.column=C.start.column;B.selection.setSelectionRange(C,true)}},N:{fn:function(B,z,D,E){var A=B.getLastSearchOptions();A.backwards=true;B.findPrevious(A);d(B);var C=B.selection.getRange();C.end.row=C.start.row;C.end.column=C.start.column;B.selection.setSelectionRange(C,true)}},v:{fn:function(A,z,B,C){A.selection.selectRight();a.visualMode(A,false)},acceptsMotion:true},V:{fn:function(A,z,B,D){var C=A.getCursorPosition().row;A.selection.clearSelection();A.selection.moveCursorTo(C,0);A.selection.selectLineEnd();A.selection.visualLineStart=C;a.visualMode(A,true)},acceptsMotion:true},Y:{fn:function(A,z,B,C){a.copyLine(A)}},p:{fn:function(A,z,C,E){var B=u._default;A.setOverwrite(false);if(B.isLine){var F=A.getCursorPosition();F.column=A.session.getLine(F.row).length;var D=y.stringRepeat("\n"+B.text,C||1);A.session.insert(F,D);A.moveCursorTo(F.row+1,0)}else{A.navigateRight();A.insert(y.stringRepeat(B.text,C||1));A.navigateLeft()}A.setOverwrite(true);A.selection.clearSelection()}},P:{fn:function(A,z,C,E){var B=u._default;A.setOverwrite(false);if(B.isLine){var F=A.getCursorPosition();F.column=0;var D=y.stringRepeat(B.text+"\n",C||1);A.session.insert(F,D);A.moveCursorToPosition(F)}else{A.insert(y.stringRepeat(B.text,C||1))}A.setOverwrite(true);A.selection.clearSelection()}},J:{fn:function(E,C,D,A){var F=E.session;C=E.getSelectionRange();var G={row:C.start.row,column:C.start.column};D=D||C.end.row-C.start.row;var H=Math.min(G.row+(D||1),F.getLength()-1);C.start.column=F.getLine(G.row).length;C.end.column=F.getLine(H).length;C.end.row=H;var I="";for(var B=G.row;B<H;B++){var z=F.getLine(B+1);I+=" "+/^\s*(.*)$/.exec(z)[1]||""}F.replace(C,I);E.moveCursorTo(G.row,G.column)}},u:{fn:function(B,z,C,D){C=parseInt(C||1,10);for(var A=0;A<C;A++){B.undo()}B.selection.clearSelection()}},"ctrl-r":{fn:function(B,z,C,D){C=parseInt(C||1,10);for(var A=0;A<C;A++){B.redo()}B.selection.clearSelection()}},":":{fn:function(A,z,B,D){var C=":";if(B>1){C=".,.+"+B+C}if(A.showCommandLine){A.showCommandLine(C)}}},"/":{fn:function(A,z,B,C){if(A.showCommandLine){A.showCommandLine("/")}}},"?":{fn:function(A,z,B,C){if(A.showCommandLine){A.showCommandLine("?")}}},".":{fn:function(A,z,C,D){a.onInsertReplaySequence=o.lastInsertCommands;var B=o.previous;if(B){o.exec(A,B.action,B.param)}}},"ctrl-x":{fn:function(A,z,B,C){A.modifyNumber(-(B||1))}},"ctrl-a":{fn:function(A,z,B,C){A.modifyNumber(B||1)}}};var o=x.inputBuffer={accepting:[m,j,c,s],currentCmd:null,currentCount:"",status:"",operator:null,motion:null,lastInsertCommands:[],push:function(D,C,G){var B=this.status;var E=true;this.idle=false;var F=this.waitingForParam;if(/^numpad\d+$/i.test(C)){C=C.substr(6)}if(F){this.exec(D,F,C)}else{if(!(C==="0"&&!this.currentCount.length)&&(/^\d+$/.test(C)&&this.isAccepting(m))){this.currentCount+=C;this.currentCmd=m;this.accepting=[m,j,c,s]}else{if(!this.operator&&this.isAccepting(j)&&r[C]){this.operator={ch:C,count:this.getCount()};this.currentCmd=j;this.accepting=[m,c,s];this.exec(D,{operator:this.operator})}else{if(q[C]&&this.isAccepting(c)){this.currentCmd=c;var A={operator:this.operator,motion:{ch:C,count:this.getCount()}};if(q[C].param){this.waitForParam(A)}else{this.exec(D,A)}}else{if(n[C]&&this.isAccepting(c)){n[C].operator.count=this.getCount();this.exec(D,n[C])}else{if(k[C]&&this.isAccepting(s)){var z={action:{fn:k[C].fn,count:this.getCount()}};if(k[C].param){this.waitForParam(z)}else{this.exec(D,z)}if(k[C].acceptsMotion){this.idle=false}}else{if(this.operator){this.operator.count=this.getCount();this.exec(D,{operator:this.operator},C)}else{E=C.length==1;this.reset()}}}}}}}if(this.waitingForParam||this.motion||this.operator){this.status+=C}else{if(this.currentCount){this.status=this.currentCount}else{if(this.status){this.status=""}}}if(this.status!=B){D._emit("changeStatus")}return E},waitForParam:function(z){this.waitingForParam=z},getCount:function(){var z=this.currentCount;this.currentCount="";return z&&parseInt(z,10)},exec:function(F,D,A){var B=D.motion;var z=D.operator;var H=D.action;if(!A){A=D.param}if(z){this.previous={action:D,param:A}}if(z&&!F.selection.isEmpty()){if(r[z.ch].selFn){r[z.ch].selFn(F,F.getSelectionRange(),z.count,A);this.reset()}return}else{if(!B&&!H&&z&&A){r[z.ch].fn(F,null,z.count,A);this.reset()}else{if(B){var C=function(I){if(I&&typeof I==="function"){if(B.count&&!E.handlesCount){i(I,B.count,[F,null,B.count,A])}else{I(F,null,B.count,A)}}};var E=q[B.ch];var G=E.sel;if(!z){if((a.onVisualMode||a.onVisualLineMode)&&G){C(E.sel)}else{C(E.nav)}}else{if(G){i(function(){C(E.sel);r[z.ch].fn(F,F.getSelectionRange(),z.count,A)},z.count||1)}}this.reset()}else{if(H){H.fn(F,F.getSelectionRange(),H.count,A);this.reset()}}}}l(F)},isAccepting:function(z){return this.accepting.indexOf(z)!==-1},reset:function(){this.operator=null;this.motion=null;this.currentCount="";this.status="";this.accepting=[m,j,c,s];this.idle=true;this.waitingForParam=null}};function e(z){o.previous={action:{action:{fn:z}}}}x.coreCommands={start:{exec:function f(z){a.insertMode(z);e(f)}},startBeginning:{exec:function g(z){z.navigateLineStart();a.insertMode(z);e(g)}},stop:{exec:function p(z){o.reset();a.onVisualMode=false;a.onVisualLineMode=false;o.lastInsertCommands=a.normalMode(z)}},append:{exec:function t(z){var B=z.getCursorPosition();var A=z.session.getLine(B.row).length;if(A){z.navigateRight()}a.insertMode(z);e(t)}},appendEnd:{exec:function w(z){z.navigateLineEnd();a.insertMode(z);e(w)}}};var l=x.onCursorMove=function(z,D){if(a.currentMode==="insert"||l.running){return}else{if(!z.selection.isEmpty()){l.running=true;if(a.onVisualLineMode){var C=z.selection.visualLineStart;var E=z.getCursorPosition().row;if(C<=E){var B=z.session.getLine(E);z.selection.clearSelection();z.selection.moveCursorTo(C,0);z.selection.selectTo(E,B.length)}else{var B=z.session.getLine(C);z.selection.clearSelection();z.selection.moveCursorTo(C,B.length);z.selection.selectTo(E,0)}}l.running=false;return}else{if(D&&(a.onVisualLineMode||a.onVisualMode)){z.selection.clearSelection();a.normalMode(z)}l.running=true;var F=z.getCursorPosition();var A=z.session.getLine(F.row).length;if(A&&F.column===A){z.navigateLeft()}l.running=false}}}});