define(function(f,e,g){var b=f("./vim/commands");var a=b.coreCommands;var d=f("./vim/maps/util");var c=f("../lib/useragent");var h={i:{command:a.start},I:{command:a.startBeginning},a:{command:a.append},A:{command:a.appendEnd},"ctrl-f":{command:"gotopagedown"},"ctrl-b":{command:"gotopageup"}};e.handler={$id:"ace/keyboard/vim",handleMacRepeat:function(k,j,i){if(j==-1){k.inputChar=i;k.lastEvent="input"}else{if(k.inputChar&&k.$lastHash==j&&k.$lastKey==i){if(k.lastEvent=="input"){k.lastEvent="input1"}else{if(k.lastEvent=="input1"){return true}}}else{k.$lastHash=j;k.$lastKey=i;k.lastEvent="keypress"}}},updateMacCompositionHandlers:function(l,j){var i=function(n){if(d.currentMode!=="insert"){var m=this.textInput.getElement();m.blur();m.focus();m.value=n}else{this.onCompositionUpdateOrig(n)}};var k=function(m){if(d.currentMode==="insert"){this.onCompositionStartOrig(m)}};if(j){if(!l.onCompositionUpdateOrig){l.onCompositionUpdateOrig=l.onCompositionUpdate;l.onCompositionUpdate=i;l.onCompositionStartOrig=l.onCompositionStart;l.onCompositionStart=k}}else{if(l.onCompositionUpdateOrig){l.onCompositionUpdate=l.onCompositionUpdateOrig;l.onCompositionUpdateOrig=null;l.onCompositionStart=l.onCompositionStartOrig;l.onCompositionStartOrig=null}}},handleKeyboard:function(l,k,i,n,m){if(k!=0&&(i==""||i=="\x00")){return null}var j=l.editor;if(k==1){i="ctrl-"+i}if(i=="ctrl-c"){if(!c.isMac&&j.getCopyText()){j.once("copy",function(){if(l.state=="start"){a.stop.exec(j)}else{j.selection.clearSelection()}});return{command:"null",passEvent:true}}return{command:a.stop}}else{if((i=="esc"&&k==0)||i=="ctrl-["){return{command:a.stop}}else{if(l.state=="start"){if(c.isMac&&this.handleMacRepeat(l,k,i)){k=-1;i=l.inputChar}if(k==-1||k==1||k==0&&i.length>1){if(b.inputBuffer.idle&&h[i]){return h[i]}b.inputBuffer.push(j,i);return{command:"null",passEvent:false}}else{if(i.length==1&&(k==0||k==4)){return{command:"null",passEvent:true}}else{if(i=="esc"&&k==0){return{command:a.stop}}}}}else{if(i=="ctrl-w"){return{command:"removewordleft"}}}}}},attach:function(i){i.on("click",e.onCursorMove);if(d.currentMode!=="insert"){b.coreCommands.stop.exec(i)}i.$vimModeHandler=this;this.updateMacCompositionHandlers(i,true)},detach:function(i){i.removeListener("click",e.onCursorMove);d.noMode(i);d.currentMode="normal";this.updateMacCompositionHandlers(i,false)},actions:b.actions,getStatusText:function(){if(d.currentMode=="insert"){return"INSERT"}if(d.onVisualMode){return(d.onVisualLineMode?"VISUAL LINE ":"VISUAL ")+b.inputBuffer.status}return b.inputBuffer.status}};e.onCursorMove=function(i){b.onCursorMove(i.editor,i);e.onCursorMove.scheduled=false}});