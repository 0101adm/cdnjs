define(function(e,h,c){var a=e("../lib/event");var d=e("../lib/useragent");var f=e("../lib/dom");var b=e("../lib/lang");var g=d.isChrome<18;var i=function(z,H){var D=f.createElement("textarea");D.className="ace_text-input";if(d.isTouchPad){D.setAttribute("x-palm-disable-auto-cap",true)}D.wrap="off";D.autocorrect="off";D.autocapitalize="off";D.spellcheck=false;D.style.opacity="0";z.insertBefore(D,z.firstChild);var k="\x01\x01";var n=false;var I=false;var q=false;var m=false;var R="";var o=true;try{var A=document.activeElement===D}catch(M){}a.addListener(D,"blur",function(){H.onBlur();A=false});a.addListener(D,"focus",function(){A=true;H.onFocus();y()});this.focus=function(){D.focus()};this.blur=function(){D.blur()};this.isFocused=function(){return A};var x=b.delayedCall(function(){A&&y(o)});var p=b.delayedCall(function(){if(!m){D.value=k;A&&y()}});function y(V){if(m){return}if(w){S=0;U=V?0:D.value.length-1}else{var S=V?2:1;var U=2}try{D.setSelectionRange(S,U)}catch(T){}}function u(){if(m){return}D.value=k;if(d.isWebKit){p.schedule()}}d.isWebKit||H.addEventListener("changeSelection",function(){if(H.selection.isEmpty()!=o){o=!o;x.schedule()}});u();if(A){H.onFocus()}var E=function(S){return S.selectionStart===0&&S.selectionEnd===S.value.length};if(!D.setSelectionRange&&D.createTextRange){D.setSelectionRange=function(T,U){var S=this.createTextRange();S.collapse(true);S.moveStart("character",T);S.moveEnd("character",U);S.select()};E=function(U){try{var S=U.ownerDocument.selection.createRange()}catch(T){}if(!S||S.parentElement()!=U){return false}return S.text==U.value}}if(d.isOldIE){var J=false;var Q=function(T){if(J){return}var S=D.value;if(m||!S||S==k){return}if(T&&S==k[0]){return t.schedule()}O(S);J=true;u();J=false};var t=b.delayedCall(Q);a.addListener(D,"propertychange",Q);var K={13:1,27:1};a.addListener(D,"keyup",function(S){if(m&&(!D.value||K[S.keyCode])){setTimeout(r,0)}if((D.value.charCodeAt(0)||0)<129){return t.call()}m?N():F()});a.addListener(D,"keydown",function(S){t.schedule(50)})}var P=function(S){if(n){n=false}else{if(I){I=false}else{if(E(D)){H.selectAll();y()}else{if(w){y(H.selection.isEmpty())}}}}};var w=null;this.setInputHandler=function(S){w=S};this.getInputHandler=function(){return w};var v=false;var O=function(S){if(w){S=w(S);w=null}if(q){y();if(S){H.onPaste(S)}q=false}else{if(S==k.charAt(0)){if(v){H.execCommand("del",{source:"ace"})}else{H.execCommand("backspace",{source:"ace"})}}else{if(S.substring(0,2)==k){S=S.substr(2)}else{if(S.charAt(0)==k.charAt(0)){S=S.substr(1)}else{if(S.charAt(S.length-1)==k.charAt(0)){S=S.slice(0,-1)}}}if(S.charAt(S.length-1)==k.charAt(0)){S=S.slice(0,-1)}if(S){H.onTextInput(S)}}}if(v){v=false}};var j=function(T){if(m){return}var S=D.value;O(S);u()};var s=function(U){var T=H.getCopyText();if(!T){a.preventDefault(U);return}var V=U.clipboardData||window.clipboardData;if(V&&!g){var S=V.setData("Text",T);if(S){H.onCut();a.preventDefault(U)}}if(!S){n=true;D.value=T;D.select();setTimeout(function(){n=false;u();y();H.onCut()})}};var B=function(U){var T=H.getCopyText();if(!T){a.preventDefault(U);return}var V=U.clipboardData||window.clipboardData;if(V&&!g){var S=V.setData("Text",T);if(S){H.onCopy();a.preventDefault(U)}}if(!S){I=true;D.value=T;D.select();setTimeout(function(){I=false;u();y();H.onCopy()})}};var l=function(T){var U=T.clipboardData||window.clipboardData;if(U){var S=U.getData("Text");if(S){H.onPaste(S)}if(d.isIE){setTimeout(y)}a.preventDefault(T)}else{D.value="";q=true}};a.addCommandKeyListener(D,H.onCommandKey.bind(H));a.addListener(D,"select",P);a.addListener(D,"input",j);a.addListener(D,"cut",s);a.addListener(D,"copy",B);a.addListener(D,"paste",l);if(!("oncut" in D)||!("oncopy" in D)||!("onpaste" in D)){a.addListener(z,"keydown",function(S){if((d.isMac&&!S.metaKey)||!S.ctrlKey){return}switch(S.keyCode){case 67:B(S);break;case 86:l(S);break;case 88:s(S);break}})}var F=function(S){if(m){return}m={};H.onCompositionStart();setTimeout(N,0);H.on("mousedown",r);if(!H.selection.isEmpty()){H.insert("");H.session.markUndoGroup();H.selection.clearSelection()}H.session.markUndoGroup()};var N=function(){if(!m){return}var T=D.value.replace(/\x01/g,"");if(m.lastValue===T){return}H.onCompositionUpdate(T);if(m.lastValue){H.undo()}m.lastValue=T;if(m.lastValue){var S=H.selection.getRange();H.insert(m.lastValue);H.session.markUndoGroup();m.range=H.selection.getRange();H.selection.setRange(S);H.selection.clearSelection()}};var r=function(T){var V=m;m=false;var U=setTimeout(function(){U=null;var W=D.value.replace(/\x01/g,"");if(m){return}else{if(W==V.lastValue){u()}else{if(!V.lastValue&&W){u();O(W)}}}});w=function S(W){if(U){clearTimeout(U)}W=W.replace(/\x01/g,"");if(W==V.lastValue){return""}if(V.lastValue&&U){H.undo()}return W};H.onCompositionEnd();H.removeListener("mousedown",r);if(T.type=="compositionend"&&V.range){H.selection.setRange(V.range)}};var G=b.delayedCall(N,50);a.addListener(D,"compositionstart",F);if(d.isGecko){a.addListener(D,"text",function(){G.schedule()})}else{a.addListener(D,"keyup",function(){G.schedule()});a.addListener(D,"keydown",function(){G.schedule()})}a.addListener(D,"compositionend",r);this.getElement=function(){return D};this.setReadOnly=function(S){D.readOnly=S};this.onContextMenu=function(X){v=true;if(!R){R=D.style.cssText}D.style.cssText="z-index:100000;"+(d.isIE?"opacity:0.1;":"");y(H.selection.isEmpty());H._emit("nativecontextmenu",{target:H,domEvent:X});var U=H.container.getBoundingClientRect();var T=f.computedStyle(H.container);var W=U.top+(parseInt(T.borderTopWidth)||0);var V=U.left+(parseInt(U.borderLeftWidth)||0);var Y=U.bottom-W-D.clientHeight;var S=function(Z){D.style.left=Z.clientX-V-2+"px";D.style.top=Math.min(Z.clientY-W-2,Y)+"px"};S(X);if(X.type!="mousedown"){return}if(H.renderer.$keepTextAreaAtCursor){H.renderer.$keepTextAreaAtCursor=null}if(d.isWin){a.capture(H.container,S,C)}};this.onContextMenuClose=C;function C(){setTimeout(function(){if(R){D.style.cssText=R;R=""}if(H.renderer.$keepTextAreaAtCursor==null){H.renderer.$keepTextAreaAtCursor=true;H.renderer.$moveTextAreaToCursor()}},0)}if(!d.isGecko||d.isMac){var L=function(S){H.textInput.onContextMenu(S);C()};a.addListener(H.renderer.scroller,"contextmenu",L);a.addListener(D,"contextmenu",L)}};h.TextInput=i});