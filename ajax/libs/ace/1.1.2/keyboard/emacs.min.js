define(function(d,f,b){var e=d("../lib/dom");d("../incremental_search");var l=d("../commands/incremental_search_commands");var k=function(q,u){var s=this.scroller.getBoundingClientRect();var r=Math.floor((q+this.scrollLeft-s.left-this.$padding)/this.characterWidth);var t=Math.floor((u+this.scrollTop-s.top)/this.lineHeight);return this.session.screenToDocumentPosition(t,r)};var h=d("./hash_handler").HashHandler;f.handler=new h();f.handler.isEmacs=true;f.handler.$id="ace/keyboard/emacs";var c=false;var n;var p;f.handler.attach=function(q){if(!c){c=true;e.importCssString("            .emacs-mode .ace_cursor{                border: 2px rgba(50,250,50,0.8) solid!important;                -moz-box-sizing: border-box!important;                -webkit-box-sizing: border-box!important;                box-sizing: border-box!important;                background-color: rgba(0,250,0,0.9);                opacity: 0.5;            }            .emacs-mode .ace_hidden-cursors .ace_cursor{                opacity: 1;                background-color: transparent;            }            .emacs-mode .ace_overwrite-cursors .ace_cursor {                opacity: 1;                background-color: transparent;                border-width: 0 0 2px 2px !important;            }            .emacs-mode .ace_text-layer {                z-index: 4            }            .emacs-mode .ace_cursor-layer {                z-index: 2            }","emacsMode")}n=q.session.$selectLongWords;q.session.$selectLongWords=true;p=q.session.$useEmacsStyleLineStart;q.session.$useEmacsStyleLineStart=true;q.session.$emacsMark=null;q.session.$emacsMarkRing=q.session.$emacsMarkRing||[];q.emacsMark=function(){return this.session.$emacsMark};q.setEmacsMark=function(r){this.session.$emacsMark=r};q.pushEmacsMark=function(t,s){var r=this.session.$emacsMark;if(r){this.session.$emacsMarkRing.push(r)}if(!t||s){this.setEmacsMark(t)}else{this.session.$emacsMarkRing.push(t)}};q.popEmacsMark=function(){var r=this.emacsMark();if(r){this.setEmacsMark(null);return r}return this.session.$emacsMarkRing.pop()};q.getLastEmacsMark=function(r){return this.session.$emacsMark||this.session.$emacsMarkRing.slice(-1)[0]};q.on("click",m);q.on("changeSession",i);q.renderer.screenToTextCoordinates=k;q.setStyle("emacs-mode");q.commands.addCommands(a);f.handler.platform=q.commands.platform;q.$emacsModeHandler=this;q.addEventListener("copy",this.onCopy);q.addEventListener("paste",this.onPaste)};f.handler.detach=function(q){delete q.renderer.screenToTextCoordinates;q.session.$selectLongWords=n;q.session.$useEmacsStyleLineStart=p;q.removeEventListener("click",m);q.removeEventListener("changeSession",i);q.unsetStyle("emacs-mode");q.commands.removeCommands(a);q.removeEventListener("copy",this.onCopy);q.removeEventListener("paste",this.onPaste)};var i=function(q){if(q.oldSession){q.oldSession.$selectLongWords=n;q.oldSession.$useEmacsStyleLineStart=p}n=q.session.$selectLongWords;q.session.$selectLongWords=true;p=q.session.$useEmacsStyleLineStart;q.session.$useEmacsStyleLineStart=true;if(!q.session.hasOwnProperty("$emacsMark")){q.session.$emacsMark=null}if(!q.session.hasOwnProperty("$emacsMarkRing")){q.session.$emacsMarkRing=[]}};var m=function(q){q.editor.session.$emacsMark=null};var o=d("../lib/keys").KEY_MODS,g={C:"ctrl",S:"shift",M:"alt",CMD:"command"},j=["C-S-M-CMD","S-M-CMD","C-M-CMD","C-S-CMD","C-S-M","M-CMD","S-CMD","S-M","C-CMD","C-M","C-S","CMD","M","S","C"];j.forEach(function(r){var q=0;r.split("-").forEach(function(s){q=q|o[g[s]]});g[q]=r.toLowerCase()+"-"});f.handler.onCopy=function(r,q){if(q.$handlesEmacsOnCopy){return}q.$handlesEmacsOnCopy=true;f.handler.commands.killRingSave.exec(q);delete q.$handlesEmacsOnCopy};f.handler.onPaste=function(r,q){q.pushEmacsMark(q.getCursorPosition())};f.handler.bindKey=function(q,s){if(!q){return}var r=this.commandKeyBinding;q.split("|").forEach(function(t){t=t.toLowerCase();r[t]=s;var u=t.split(" ").slice(0,-1);u.reduce(function(v,x,w){var y=v[w-1]?v[w-1]+" ":"";return v.concat([y+x])},[]).forEach(function(v){if(!r[v]){r[v]="null"}})},this)};f.handler.handleKeyboard=function(u,t,z,A){var w=u.editor;if(t==-1){w.pushEmacsMark();if(u.count){var y=Array(u.count+1).join(z);u.count=null;return{command:"insertstring",args:y}}}if(z=="\x00"){return undefined}var q=g[t];if(q=="c-"||u.universalArgument){var r=String(u.count||0);var v=parseInt(z[z.length-1]);if(typeof v==="number"&&!isNaN(v)){u.count=parseInt(r+v);return{command:"null"}}else{if(u.universalArgument){u.count=4}}}u.universalArgument=false;if(q){z=q+z}if(u.keyChain){z=u.keyChain+=" "+z}var s=this.commandKeyBinding[z];u.keyChain=s=="null"?z:"";if(!s){return undefined}if(s==="null"){return{command:"null"}}if(s==="universalArgument"){u.universalArgument=true;return{command:"null"}}var x;if(typeof s!=="string"){x=s.args;if(s.command){s=s.command}if(s==="goorselect"){s=w.emacsMark()?x[1]:x[0];x=null}}if(typeof s==="string"){if(s==="insertstring"||s==="splitline"||s==="togglecomment"){w.pushEmacsMark()}s=this.commands[s]||w.commands.commands[s];if(!s){return undefined}}if(!s.readonly&&!s.isYank){u.lastCommand=null}if(u.count){var v=u.count;u.count=0;if(!s||!s.handlesCount){return{args:x,command:{exec:function(D,B){for(var C=0;C<v;C++){s.exec(D,B)}}}}}else{if(!x){x={}}if(typeof x==="object"){x.count=v}}}return{command:s,args:x}};f.emacsKeys={"Up|C-p":{command:"goorselect",args:["golineup","selectup"]},"Down|C-n":{command:"goorselect",args:["golinedown","selectdown"]},"Left|C-b":{command:"goorselect",args:["gotoleft","selectleft"]},"Right|C-f":{command:"goorselect",args:["gotoright","selectright"]},"C-Left|M-b":{command:"goorselect",args:["gotowordleft","selectwordleft"]},"C-Right|M-f":{command:"goorselect",args:["gotowordright","selectwordright"]},"Home|C-a":{command:"goorselect",args:["gotolinestart","selecttolinestart"]},"End|C-e":{command:"goorselect",args:["gotolineend","selecttolineend"]},"C-Home|S-M-,":{command:"goorselect",args:["gotostart","selecttostart"]},"C-End|S-M-.":{command:"goorselect",args:["gotoend","selecttoend"]},"S-Up|S-C-p":"selectup","S-Down|S-C-n":"selectdown","S-Left|S-C-b":"selectleft","S-Right|S-C-f":"selectright","S-C-Left|S-M-b":"selectwordleft","S-C-Right|S-M-f":"selectwordright","S-Home|S-C-a":"selecttolinestart","S-End|S-C-e":"selecttolineend","S-C-Home":"selecttostart","S-C-End":"selecttoend","C-l":"recenterTopBottom","M-s":"centerselection","M-g":"gotoline","C-x C-p":"selectall","C-Down":{command:"goorselect",args:["gotopagedown","selectpagedown"]},"C-Up":{command:"goorselect",args:["gotopageup","selectpageup"]},"PageDown|C-v":{command:"goorselect",args:["gotopagedown","selectpagedown"]},"PageUp|M-v":{command:"goorselect",args:["gotopageup","selectpageup"]},"S-C-Down":"selectpagedown","S-C-Up":"selectpageup","C-s":"iSearch","C-r":"iSearchBackwards","M-C-s":"findnext","M-C-r":"findprevious","S-M-5":"replace",Backspace:"backspace","Delete|C-d":"del","Return|C-m":{command:"insertstring",args:"\n"},"C-o":"splitline","M-d|C-Delete":{command:"killWord",args:"right"},"C-Backspace|M-Backspace|M-Delete":{command:"killWord",args:"left"},"C-k":"killLine","C-y|S-Delete":"yank","M-y":"yankRotate","C-g":"keyboardQuit","C-w":"killRegion","M-w":"killRingSave","C-Space":"setMark","C-x C-x":"exchangePointAndMark","C-t":"transposeletters","M-u":"touppercase","M-l":"tolowercase","M-/":"autocomplete","C-u":"universalArgument","M-;":"togglecomment","C-/|C-x u|S-C--|C-z":"undo","S-C-/|S-C-x u|C--|S-C-z":"redo","C-x r":"selectRectangularRegion","M-x":{command:"focusCommandLine",args:"M-x "}};f.handler.bindKeys(f.emacsKeys);f.handler.addCommands({recenterTopBottom:function(r){var s=r.renderer;var u=s.$cursorLayer.getPixelPosition();var q=s.$size.scrollerHeight-s.lineHeight;var t=s.scrollTop;if(Math.abs(u.top-t)<2){t=u.top-q}else{if(Math.abs(u.top-t-q*0.5)<2){t=u.top}else{t=u.top-q*0.5}}r.session.setScrollTop(t)},selectRectangularRegion:function(q){q.multiSelect.toggleBlockSelection()},setMark:{exec:function(r,q){if(q&&q.count){var u=r.popEmacsMark();u&&r.selection.moveCursorToPosition(u);return}var u=r.emacsMark(),s=true;if(s&&(u||!r.selection.isEmpty())){r.pushEmacsMark();r.clearSelection();return}if(u){var t=r.getCursorPosition();if(r.selection.isEmpty()&&u.row==t.row&&u.column==t.column){r.pushEmacsMark();return}}u=r.getCursorPosition();r.setEmacsMark(u);r.selection.setSelectionAnchor(u.row,u.column)},readonly:true,handlesCount:true,multiSelectAction:"forEach"},exchangePointAndMark:{exec:function(s,r){var t=s.selection;if(r.count){var v=s.getCursorPosition();t.clearSelection();t.moveCursorToPosition(s.popEmacsMark());s.pushEmacsMark(v);return}var u=s.getLastEmacsMark();var q=t.getRange();if(q.isEmpty()){t.selectToPosition(u);return}t.setSelectionRange(q,!t.isBackwards())},readonly:true,handlesCount:true,multiSelectAction:"forEach"},killWord:{exec:function(s,r){s.clearSelection();if(r=="left"){s.selection.selectWordLeft()}else{s.selection.selectWordRight()}var q=s.getSelectionRange();var t=s.session.getTextRange(q);f.killRing.add(t);s.session.remove(q);s.clearSelection()},multiSelectAction:"forEach"},killLine:function(r){r.pushEmacsMark(null);var t=r.getCursorPosition();if(t.column==0&&r.session.doc.getLine(t.row).length==0){r.selection.selectLine()}else{r.clearSelection();r.selection.selectLineEnd()}var q=r.getSelectionRange();var s=r.session.getTextRange(q);f.killRing.add(s);r.session.remove(q);r.clearSelection()},yank:function(q){q.onPaste(f.killRing.get()||"");q.keyBinding.$data.lastCommand="yank"},yankRotate:function(q){if(q.keyBinding.$data.lastCommand!="yank"){return}q.undo();q.onPaste(f.killRing.rotate());q.keyBinding.$data.lastCommand="yank"},killRegion:{exec:function(q){f.killRing.add(q.getCopyText());q.commands.byName.cut.exec(q)},readonly:true,multiSelectAction:"forEach"},killRingSave:{exec:function(q){f.killRing.add(q.getCopyText());setTimeout(function(){var s=q.selection,r=s.getRange();q.pushEmacsMark(s.isBackwards()?r.end:r.start);s.clearSelection()},0)},readonly:true},keyboardQuit:function(q){q.selection.clearSelection();q.setEmacsMark(null)},focusCommandLine:function(r,q){if(r.showCommandLine){r.showCommandLine(q)}}});f.handler.addCommands(l.iSearchStartCommands);var a=f.handler.commands;a.yank.isYank=true;a.yankRotate.isYank=true;f.killRing={$data:[],add:function(q){q&&this.$data.push(q);if(this.$data.length>30){this.$data.shift()}},get:function(q){q=q||1;return this.$data.slice(this.$data.length-q,this.$data.length).reverse().join("\n")},pop:function(){if(this.$data.length>1){this.$data.pop()}return this.get()},rotate:function(){this.$data.unshift(this.$data.pop());return this.get()}}});